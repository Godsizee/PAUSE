if ($string === null) return '';
        $string = str_replace('\\', '\\\\', $string);
        $string = str_replace(';', '\;', $string);
        $string = str_replace(',', '\,', $string);
        $string = str_replace("\r", '', $string);
        $string = str_replace("\n", '\n', $string);
        return $string;
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\app\Services\IcalService.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\app\Services\ImpersonationService.php ---
<?php
// app/Services/ImpersonationService.php

namespace App\Services;

use App\Repositories\UserRepository;
use App\Core\Security;
use App\Core\Utils;
use Exception;

/**
 * Service-Klasse zur Kapselung der Logik f√ºr User-Impersonation.
 * Stellt Methoden zum Starten und Beenden der Impersonation bereit.
 */
class ImpersonationService
{
    private UserRepository $userRepository;

    /**
     * @param UserRepository $userRepository Wird ben√∂tigt, um Benutzerdaten zu holen.
     */
    public function __construct(UserRepository $userRepository)
    {
        $this->userRepository = $userRepository;
    }

    /**
     * Startet die Impersonation f√ºr einen Zielbenutzer.
     *
     * @param int $targetUserId Der Benutzer, als der man sich anmelden m√∂chte.
     * @param int $adminUserId Der Admin, der die Aktion ausf√ºhrt.
     * @return array Der Zielbenutzer (f√ºr Logging-Zwecke).
     * @throws Exception Wenn Validierungen fehlschlagen.
     */
    public function start(int $targetUserId, int $adminUserId): array
    {
        if ($targetUserId == $adminUserId) {
            throw new Exception("Sie k√∂nnen sich nicht selbst imitieren.", 400);
        }

        // 1. Zieldaten des Benutzers abrufen
        $targetUser = $this->userRepository->findById($targetUserId);
        if (!$targetUser) {
            throw new Exception("Zielbenutzer nicht gefunden.", 404);
        }

        // 2. Admin-ID in der aktuellen Session sichern
        $_SESSION['impersonator_id'] = $adminUserId;

        // 3. Aktuelle Sitzungsdaten mit Zieldaten √ºberschreiben
        // Wichtig f√ºr die Sicherheit: Regeneriert die Session-ID
        session_regenerate_id(true);

        $_SESSION['user_id'] = $targetUser['user_id'];
        $_SESSION['username'] = $targetUser['username'];
        $_SESSION['user_role'] = $targetUser['role'];
        // NEU: Community-Sperrstatus ebenfalls setzen
        $_SESSION['is_community_banned'] = (int)($targetUser['is_community_banned'] ?? 0);

        // 4. Admin-ID erneut sichern (da die Session erneuert wurde)
        $_SESSION['impersonator_id'] = $adminUserId;

        // 5. CSRF-Token f√ºr die neue Session neu generieren
        // (Wichtig, da das alte Token ung√ºltig ist)
        Security::getCsrfToken();

        // 6. Zielbenutzerdaten f√ºr das Logging im Controller zur√ºckgeben
        return $targetUser;
    }

    /**
     * Beendet die Impersonation und stellt die Admin-Sitzung wieder her.
     *
     * @return array ['adminUser' => array, 'impersonatedUserId' => int]
     * @throws Exception Wenn die Wiederherstellung fehlschl√§gt.
     */
    public function revert(): array
    {
        if (session_status() !== PHP_SESSION_ACTIVE || empty($_SESSION['impersonator_id'])) {
            // Dies sollte nicht passieren, wenn die Route gesch√ºtzt ist,
            // aber zur Sicherheit.
            throw new Exception("Keine aktive Impersonation-Sitzung gefunden.", 400);
        }

        $impersonatedUserId = $_SESSION['user_id'] ?? 0;
        $adminUserId = $_SESSION['impersonator_id'];

        // 1. Aktuelle (impersonierte) Sitzung zerst√∂ren
        $_SESSION = [];
        session_destroy();

        // 2. Neue, saubere Session f√ºr den Admin starten
        session_start();
        session_regenerate_id(true);

        // 3. Admin-Benutzerdaten holen
        $adminUser = $this->userRepository->findById($adminUserId);
        if (!$adminUser || !in_array($adminUser['role'], ['admin', 'planer'])) { // Admins/Planer d√ºrfen
            error_log("Impersonation Revert Failed: Original user {$adminUserId} is no longer an admin/planer.");
            throw new Exception("Urspr√ºnglicher Benutzer konnte nicht wiederhergestellt werden.", 403);
        }

        // 4. Admin-Session manuell aufbauen
        $_SESSION['user_id'] = $adminUser['user_id'];
        $_SESSION['username'] = $adminUser['username'];
        $_SESSION['user_role'] = $adminUser['role'];
        $_SESSION['is_community_banned'] = 0; // Admins/Planer sind nie gesperrt
        // (Die 'impersonator_id' ist jetzt weg)

        // 5. CSRF-Token f√ºr die neue Admin-Session setzen
        Security::getCsrfToken();

        // 6. Daten f√ºr Logging zur√ºckgeben
        return [
            'adminUser' => $adminUser,
            'impersonatedUserId' => $impersonatedUserId
        ];
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\app\Services\ImpersonationService.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\app\Services\PdfService.php ---
<?php
// app/Services/PdfService.php

namespace App\Services;

use App\Repositories\PlanRepository;
use App\Repositories\UserRepository;
use App\Core\Utils; // Importiert f√ºr die getSettings-Typisierung
use Exception;
use DateTime;
use DateTimeZone;

// Definiere den Font-Pfad, bevor tFPDF eingebunden wird
if (!defined('FPDF_FONTPATH')) {
    define('FPDF_FONTPATH', dirname(__DIR__, 2) . DIRECTORY_SEPARATOR . 'libs' . DIRECTORY_SEPARATOR . 'tfpdf' . DIRECTORY_SEPARATOR . 'font' . DIRECTORY_SEPARATOR);
}
// Binde die tFPDF-Bibliothek ein
require_once dirname(__DIR__, 2) . '/libs/tfpdf/tfpdf.php';

/**
 * Service-Klasse zur Kapselung der PDF-Generierungslogik.
 * (Ausgelagert aus PdfController).
 * Erbt von tFPDF, um die PDF-Funktionalit√§t bereitzustellen.
 */
class PdfService extends \tFPDF
{
    private PlanRepository $planRepository;
    private UserRepository $userRepository;
    private array $settings;
    private ?array $userData = null; // Speichert den Benutzer, f√ºr den das PDF generiert wird
    private int $targetYear;
    private int $targetWeek;
    private array $timetableData = [];
    private array $substitutionData = [];
    private array $cellWidths = [];
    private float $headerHeight = 7;
    private float $totalWidth = 277; // A4 Landscape (297) - 10mm margins = 277

    private string $fontBody = 'Arial';
    private string $fontDisplay = 'Arial';

    private array $colors = [
        'border' => [200, 200, 200],
        'headerBg' => [240, 240, 240],
        'headerText' => [50, 50, 50],
        'cellBg' => [255, 255, 255],
        'cellText' => [0, 0, 0],
        'substBorderVertretung' => [220, 53, 69],
        'substBorderRaum' => [255, 193, 7],
        'substBorderEvent' => [13, 110, 253],
        'substBorderEntfall' => [108, 117, 125],
        'substTextEntfall' => [108, 117, 125],
        'commentText' => [108, 117, 125],
    ];

    /**
     * Konstruktor: Nimmt Abh√§ngigkeiten entgegen.
     */
    public function __construct(
        PlanRepository $planRepository,
        UserRepository $userRepository,
        array $settings
    ) {
        $this->planRepository = $planRepository;
        $this->userRepository = $userRepository;
        $this->settings = $settings;
        
        // WICHTIG: Der tFPDF-Konstruktor muss hier nicht aufgerufen werden,
        // da er von der generateTimetablePdf-Methode aufgerufen wird,
        // die die Seitenorientierung festlegt.
    }

    /**
     * Hauptmethode zur Generierung des PDF-Stundenplans.
     *
     * @param int $userId ID des anfragenden Benutzers.
     * @param string $userRole Rolle des anfragenden Benutzers.
     * @param int $year Ziel-Jahr.
     * @param int $week Ziel-Woche.
     * @return string Der rohe PDF-Daten-String.
     * @throws Exception Wenn Validierung fehlschl√§gt oder PDF-Fehler auftreten.
     */
    public function generateTimetablePdf(int $userId, string $userRole, int $year, int $week): string
    {
        // 1. Benutzerdaten validieren und holen
        $this->userData = $this->userRepository->findById($userId);
        if (!$this->userData || !in_array($userRole, ['schueler', 'lehrer'])) {
            throw new Exception("PDF Export nur f√ºr Sch√ºler und Lehrer verf√ºgbar.", 403);
        }

        $this->targetYear = $year;
        $this->targetWeek = $week;

        // 2. Daten abrufen (nur wenn ver√∂ffentlicht)
        $targetGroup = ($userRole === 'schueler') ? 'student' : 'teacher';
        if (!$this->planRepository->isWeekPublishedFor($targetGroup, $year, $week)) {
            throw new Exception("Der Stundenplan f√ºr diese Woche ist noch nicht ver√∂ffentlicht.", 403);
        }

        // 3. Daten basierend auf der Rolle laden
        if ($userRole === 'schueler' && !empty($this->userData['class_id'])) {
            $classId = $this->userData['class_id'];
            $this->timetableData = $this->planRepository->getPublishedTimetableForClass($classId, $year, $week);
            $this->substitutionData = $this->planRepository->getPublishedSubstitutionsForClassWeek($classId, $year, $week);
        } elseif ($userRole === 'lehrer' && !empty($this->userData['teacher_id'])) {
            $teacherId = $this->userData['teacher_id'];
            $this->timetableData = $this->planRepository->getPublishedTimetableForTeacher($teacherId, $year, $week);
            $this->substitutionData = $this->planRepository->getPublishedSubstitutionsForTeacherWeek($teacherId, $year, $week);
        } else {
            throw new Exception("Benutzerdaten unvollst√§ndig (Klasse/Lehrer fehlt).", 400);
        }

        // --- PDF-Generierung starten ---

        // 4. tFPDF-Konstruktor aufrufen
        parent::__construct('L', 'mm', 'A4'); // A4 Landscape

        // 5. Schriftarten laden
        try {
            if (!file_exists(FPDF_FONTPATH . 'unifont' . DIRECTORY_SEPARATOR . 'Oswald-Regular.ttf')) throw new Exception("Font file not found: Oswald-Regular.ttf");
            if (!file_exists(FPDF_FONTPATH . 'unifont' . DIRECTORY_SEPARATOR . 'Oswald-Bold.ttf')) throw new Exception("Font file not found: Oswald-Bold.ttf");
            
            $this->AddFont('Oswald', '', 'Oswald-Regular.ttf', true);
            $this->AddFont('Oswald', 'B', 'Oswald-Bold.ttf', true);
            
            $this->fontBody = 'Arial';
            $this->fontDisplay = 'Oswald';
        } catch (Exception $fontEx) {
            error_log("Fehler beim Laden der PDF-Schriftarten: " . $fontEx->getMessage() . " - Fallback auf Arial.");
            $this->fontBody = 'Arial';
            $this->fontDisplay = 'Arial';
        }

        // 6. PDF-Dokument aufbauen
        $this->AliasNbPages();
        $this->AddPage();
        $this->SetMargins(10, 10, 10);
        $this->SetAutoPageBreak(false);

        $this->drawPdfHeader();
        $this->drawTimetableGrid();

        // 7. PDF-Daten als String zur√ºckgeben
        return $this->Output('S');
    }

    /**
     * Zeichnet den Titel und Untertitel des PDFs.
     */
    private function drawPdfHeader(): float
    {
        $monday = $this->getDateOfISOWeek($this->targetWeek, $this->targetYear);
        $friday = (new DateTime())->setTimestamp($monday->getTimestamp() + 4 * 24 * 60 * 60);

        $className = '';
        if($this->userData['role'] === 'schueler') {
            $classData = $this->userRepository->findClassByUserId($this->userData['user_id']);
            if ($classData) {
                $className = 'Klasse ' . ($classData['class_name'] ?? $classData['class_id']);
            }
        }

        $title = sprintf(
            'Stundenplan %s %s',
            $this->userData['username'] ?? 'Benutzer',
            $className ? '(' . $className . ')' : ''
        );
        $subTitle = sprintf(
            'Kalenderwoche %d / %d (%s - %s)',
            $this->targetWeek,
            $this->targetYear,
            $monday->format('d.m.Y'),
            $friday->format('d.m.Y')
        );

        $this->SetFont($this->fontDisplay, 'B', 16);
        $this->SetTextColor(0, 0, 0);
        $this->Cell(0, 8, $title, 0, 1, 'C');
        $this->SetFont($this->fontBody, '', 10);
        $this->Cell(0, 6, $subTitle, 0, 1, 'C');
        $this->Ln(5);

        return 19; // H√∂he des Headers
    }

    /**
     * Zeichnet das komplette Stundenplan-Raster.
     */
    private function drawTimetableGrid()
    {
        // Spaltenbreiten berechnen
        $timeColWidth = 18;
        $dayColWidth = ($this->totalWidth - $timeColWidth) / 5;
        $this->cellWidths = [$timeColWidth, $dayColWidth, $dayColWidth, $dayColWidth, $dayColWidth, $dayColWidth];

        // Header zeichnen
        $this->SetFont($this->fontBody, 'B', 8);
        $this->SetFillColor(...$this->colors['headerBg']);
        $this->SetTextColor(...$this->colors['headerText']);
        $this->SetDrawColor(...$this->colors['border']);
        $this->SetLineWidth(0.2);

        $this->Cell($this->cellWidths[0], $this->headerHeight, 'Zeit', 1, 0, 'C', true);
        $daysOfWeek = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];
        foreach ($daysOfWeek as $i => $day) {
            $this->Cell($this->cellWidths[$i + 1], $this->headerHeight, $day, 1, 0, 'C', true);
        }
        $this->Ln($this->headerHeight);

        // Dynamische Zeilenh√∂he berechnen
        $headerAreaHeight = 19; // H√∂he von drawPdfHeader
        $drawableHeight = $this->h - $this->tMargin - 10; // 190mm
        $gridBodyHeight = $drawableHeight - $headerAreaHeight - $this->headerHeight; // 164mm
        
        $timeSlotsDisplay = [
            "08:00\n08:45", "08:55\n09:40", "09:40\n10:25", "10:35\n11:20",
            "11:20\n12:05", "13:05\n13:50", "13:50\n14:35", "14:45\n15:30",
            "15:30\n16:15", "16:25\n17:10"
        ];
        $numRows = count($timeSlotsDisplay);
        $calculatedRowHeight = $gridBodyHeight / $numRows; // 16.4mm
        $timeCellLineHeight = 3.5;

        $timetableByCell = $this->prepareTimetableData();

        foreach ($timeSlotsDisplay as $period => $timeLabel) {
            $currentPeriod = $period + 1;
            $rowStartY = $this->GetY();

            // Zeitzelle zeichnen
            $this->SetFillColor(...$this->colors['headerBg']);
            $this->SetTextColor(...$this->colors['headerText']);
            
            $periodLabel = $currentPeriod . ".";
            $timeLabelParts = explode("\n", $timeLabel);
            $timeLabelFormatted = $timeLabelParts[0] . ' - ' . $timeLabelParts[1];
            
            $totalTextHeight = $timeCellLineHeight * 2;
            $cellCenterY = $rowStartY + ($calculatedRowHeight / 2);
            $textStartY = $cellCenterY - ($totalTextHeight / 2);

            $this->SetXY(10, $rowStartY); 
            $this->Cell($this->cellWidths[0], $calculatedRowHeight, '', 1, 0, 'C', true);
            $this->SetXY(10, $textStartY);
            $this->SetFont($this->fontBody, 'B', 8);
            $this->Cell($this->cellWidths[0], $timeCellLineHeight, $periodLabel, 0, 1, 'C', false);
            $this->SetFont($this->fontBody, '', 7);
            $this->SetX(10);
            $this->Cell($this->cellWidths[0], $timeCellLineHeight, $timeLabelFormatted, 0, 1, 'C', false);
            $this->SetY($rowStartY);

            // Tageszellen zeichnen
            for ($dayNum = 1; $dayNum <= 5; $dayNum++) {
                $currentX = 10 + $this->cellWidths[0] + (($dayNum - 1) * $this->cellWidths[$dayNum]);
                $this->SetX($currentX);

                $cellKey = $dayNum . '-' . $currentPeriod;
                $entry = $timetableByCell[$cellKey] ?? null;

                $this->drawTimetableCell($entry, $this->cellWidths[$dayNum], $calculatedRowHeight, $this->fontBody, $currentPeriod);
            }
            $this->Ln($calculatedRowHeight);
        }
    }

    /**
     * Bereitet die Rohdaten in eine 'Tag-Periode'-Map um.
     */
    private function prepareTimetableData(): array
    {
        $map = [];
        $userRole = $this->userData['role']; // Verwende die gespeicherten Benutzerdaten

        // 1. Regul√§re Eintr√§ge
        foreach ($this->timetableData as $entry) {
            $key = $entry['day_of_week'] . '-' . $entry['period_number'];
            $map[$key] = [
                'type' => 'regular',
                'subject' => $entry['subject_shortcut'] ?? '---',
                'mainText' => $userRole === 'schueler' ? ($entry['teacher_shortcut'] ?? '---') : ($entry['class_name'] ?? '---'),
                'room' => $entry['room_name'] ?? '',
                'comment' => $entry['comment'] ?? '',
                'original' => $entry
            ];
        }

        // 2. Vertretungen (√ºberschreiben)
        foreach ($this->substitutionData as $sub) {
            try {
                $subDate = new DateTime($sub['date']);
                $dayNum = $subDate->format('N');
            } catch (Exception $e) { continue; }

            if ($dayNum < 1 || $dayNum > 5) continue;

            $key = $dayNum . '-' . $sub['period_number'];
            $regularEntryForKey = $map[$key]['original'] ?? null;

            $map[$key] = [
                'type' => $sub['substitution_type'],
                'subject' => $sub['new_subject_shortcut'] ?? $regularEntryForKey['subject_shortcut'] ?? ($sub['substitution_type'] === 'Sonderevent' ? 'EVENT' : ($sub['substitution_type'] === 'Entfall' ? ($regularEntryForKey['subject_shortcut'] ?? '---') : '---')),
                'mainText' => $sub['substitution_type'] === 'Vertretung'
                    ? ($userRole === 'teacher' ? ($sub['class_name'] ?? $regularEntryForKey['class_name'] ?? '---') : ($sub['new_teacher_shortcut'] ?? '---'))
                    : ($sub['substitution_type'] === 'Entfall' ? 'Entf√§llt' : ($regularEntryForKey ? ($userRole === 'schueler' ? $regularEntryForKey['teacher_shortcut'] : $regularEntryForKey['class_name']) : '')),
                'room' => $sub['new_room_name'] ?? $regularEntryForKey['room_name'] ?? '',
                'comment' => $sub['comment'] ?? '',
                'original' => $regularEntryForKey
            ];
        }
        return $map;
    }

    /**
     * Zeichnet eine einzelne Zelle im Raster.
     */
    private function drawTimetableCell(?array $entry, float $width, float $height, string $fontBody, int $currentPeriod)
    {
        $this->SetFillColor(...$this->colors['cellBg']);
        $this->SetTextColor(...$this->colors['cellText']);
        $this->SetDrawColor(...$this->colors['border']);
        $this->SetLineWidth(0.2);
        $border = 1;

        $startX = $this->GetX();
        $startY = $this->GetY();
        $borderColor = null;

        if ($entry) {
            $subjectText = $entry['subject'] ?? '';
            $mainText = $entry['mainText'] ?? '';
            $roomText = $entry['room'] ?? '';
            $commentText = $entry['comment'] ?? '';

            switch ($entry['type']) {
                case 'Vertretung': $borderColor = $this->colors['substBorderVertretung']; break;
                case 'Raum√§nderung': $borderColor = $this->colors['substBorderRaum']; break;
                case 'Sonderevent': $borderColor = $this->colors['substBorderEvent']; break;
                case 'Entfall': $borderColor = $this->colors['substBorderEntfall']; break;
                default: $borderColor = $this->colors['border'];
            }

            if ($borderColor && $borderColor !== $this->colors['border']) {
                $this->SetDrawColor(...$borderColor);
                $this->SetLineWidth(0.5);
                $this->Line($startX, $startY, $startX, $startY + $height);
                $this->SetDrawColor(...$this->colors['border']);
                $this->SetLineWidth(0.2);
            }

            $this->SetXY($startX, $startY);
            $this->Cell($width, $height, '', $border, 0, 'C', true);

            // Inhalt (vertikal zentriert)
            $padding = 1.5;
            $availableWidth = $width - (2 * $padding);
            $lineHeight = 3.5;
            $textBlockHeight = 0;

            if ($entry['type'] === 'Entfall') {
                $textBlockHeight += $lineHeight;
            } else {
                $textBlockHeight += $lineHeight;
                $detailsText = trim(($mainText ? $mainText : '') . ($roomText ? ' (' . $roomText . ')' : ''));
                if ($detailsText) $textBlockHeight += $lineHeight;
            }
            if ($commentText && $entry['type'] !== 'Sonderevent') {
                $textBlockHeight += $lineHeight;
            }
            if ($entry['type'] === 'Sonderevent') {
                $textBlockHeight = $lineHeight * 2;
            }

            $contentStartY = $startY + ($height - $textBlockHeight) / 2;
            if ($contentStartY < $startY + $padding) $contentStartY = $startY + $padding;

            $this->SetXY($startX + $padding, $contentStartY);

            // Fach
            $this->SetFont($fontBody, 'B', 9);
            if ($entry['type'] === 'Entfall') {
                $this->SetTextColor(...$this->colors['substTextEntfall']);
                $this->Cell($availableWidth, $lineHeight, 'Entf√§llt: ' . $subjectText, 0, 1, 'C');
            } else {
                $this->SetTextColor(...$this->colors['cellText']);
                $this->Cell($availableWidth, $lineHeight, $subjectText, 0, 1, 'C');
            }

            // Haupttext & Raum
            if ($entry['type'] !== 'Entfall') {
                $this->SetFont($fontBody, '', 8);
                $this->SetTextColor(...$this->colors['cellText']);
                $detailsText = trim(($mainText ? $mainText : '') . ($roomText ? ' (' . $roomText . ')' : ''));
                if ($detailsText) {
                    $this->SetX($startX + $padding);
                    $this->Cell($availableWidth, $lineHeight, $detailsText, 0, 1, 'C');
                }
            }

            // Kommentar
            if ($commentText && $entry['type'] !== 'Sonderevent') {
                $this->SetFont($fontBody, '', 7);
                $this->SetTextColor(...$this->colors['commentText']);
                $this->SetX($startX + $padding);
                $this->Cell($availableWidth, $lineHeight, $commentText, 0, 1, 'C');
            }

        } else {
            // Leere Zelle oder FU
            $isFU = ($currentPeriod == ($this->settings['default_start_hour'] ?? 1) || $currentPeriod == ($this->settings['default_end_hour'] ?? 10));
            if ($isFU) {
                $this->SetFillColor(...$this->colors['headerBg']);
                $this->SetTextColor(...$this->colors['headerText']);
                $this->SetFont($fontBody, 'B', 8);
                $this->Cell($width, $height, 'FU', $border, 0, 'C', true);
            } else {
                $this->Cell($width, $height, '', $border, 0, 'C', true);
            }
        }
        $this->SetXY($startX + $width, $startY);
    }

    /**
     * Hilfsfunktion zum Holen des Montagsdatums einer ISO-Woche.
     */
    private function getDateOfISOWeek(int $week, int $year): DateTime
    {
        $dto = new DateTime();
        $dto->setISODate($year, $week, 1);
        $dto->setTime(0,0,0);
        return $dto;
    }

    /**
     * √úberschreibt die tFPDF Header-Methode (hier leer).
     */
    public function Header()
    {
        // Wird von drawPdfHeader() manuell gehandhabt
    }

    /**
     * √úberschreibt die tFPDF Footer-Methode.
     */
    public function Footer()
    {
        $this->SetY(-10);
        $this->SetFont($this->fontBody,'',8);
        $this->SetTextColor(128);

        // Verwende den geladenen Einstellungs-Cache
        $footerText = $this->settings['pdf_footer_text'] ?? 'PAUSE Portal';
        $footerText .= ' | Generiert am: ' . date('d.m.Y H:i');
        
        $this->Cell(0, 10, $footerText, 0, 0, 'L');
        $this->Cell(0, 10, 'Seite '.$this->PageNo().'/{nb}', 0, 0, 'R');
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\app\Services\PdfService.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\app\Services\SingleIcalService.php ---
<?php
// app/Services/SingleIcalService.php

namespace App\Services;

use App\Repositories\AcademicEventRepository;
use App\Repositories\PlanRepository;
use DateTimeImmutable;
use DateTimeZone;
use Exception;

/**
 * Service-Klasse zur Kapselung der Logik f√ºr die Erstellung
 * einzelner .ics-Kalenderdateien (ausgelagert aus SingleEventController).
 */
class SingleIcalService
{
    private AcademicEventRepository $eventRepo;
    private PlanRepository $planRepo;
    private DateTimeZone $timezone;

    // Zeitdefinitionen (konsistent mit IcalService)
    private const PERIOD_TIMES = [
        1 => ['start' => '0800', 'end' => '0845'],
        2 => ['start' => '0855', 'end' => '0940'],
        3 => ['start' => '0940', 'end' => '1025'],
        4 => ['start' => '1035', 'end' => '1120'],
        5 => ['start' => '1120', 'end' => '1205'],
        6 => ['start' => '1305', 'end' => '1350'],
        7 => ['start' => '1350', 'end' => '1435'],
        8 => ['start' => '1445', 'end' => '1530'],
        9 => ['start' => '1530', 'end' => '1615'],
        10 => ['start' => '1625', 'end' => '1710'],
    ];

    /**
     * Konstruktor: Nimmt Abh√§ngigkeiten entgegen.
     */
    public function __construct(
        AcademicEventRepository $eventRepo,
        PlanRepository $planRepo
    ) {
        $this->eventRepo = $eventRepo;
        $this->planRepo = $planRepo;
        $this->timezone = new DateTimeZone('Europe/Berlin');
    }

    /**
     * Hauptmethode zur Generierung des iCal-Strings f√ºr ein einzelnes Event.
     *
     * @param string $type Typ des Events ('acad' oder 'sub').
     * @param int $id Die ID des Events.
     * @return array ['content' => string, 'filename' => string]
     * @throws Exception Wenn das Event nicht gefunden, ung√ºltig oder der Typ falsch ist.
     */
    public function generateSingleIcs(string $type, int $id): array
    {
        $eventData = null;

        if ($type === 'acad') {
            $eventData = $this->getAcademicEventData($id);
        } elseif ($type === 'sub') {
            $eventData = $this->getSubstitutionEventData($id);
        } else {
            throw new Exception("Ung√ºltiger Event-Typ.", 400);
        }

        if (!$eventData) {
            throw new Exception("Termin nicht gefunden oder ung√ºltig.", 404);
        }

        // Berechtigungspr√ºfung (k√∂nnte hier implementiert werden,
        // z.B. durch √úbergabe von $userId an diese Methode)
        // ...

        $icsContent = $this->formatAsIcs($eventData);
        
        // Dateinamen generieren (bereinigt)
        $safeSummary = $eventData['summary'] ?? 'termin';
        $safeSummary = preg_replace('/[^a-zA-Z0-9_-]/', '_', $safeSummary);
        $safeSummary = substr($safeSummary, 0, 50); // K√ºrzen
        $filename = $safeSummary . '.ics';

        return [
            'content' => $icsContent,
            'filename' => $filename
        ];
    }

    /** Holt und formatiert Daten f√ºr Aufgaben/Klausuren */
    private function getAcademicEventData(int $id): ?array
    {
        $event = $this->eventRepo->getEventById($id);
        if (!$event) return null;

        $dateObj = new DateTimeImmutable($event['due_date'] . ' 00:00:00', $this->timezone);
        $dtStart = $dateObj;
        $dtEnd = $dateObj->modify('+1 day');
        $dtStartFormat = 'Ymd';
        $dtEndFormat = 'Ymd';
        $timeInfo = "";
        $location = "";

        $icon = '‚ÑπÔ∏è'; $prefix = 'Info';
        if ($event['event_type'] === 'klausur') { $icon = 'üéì'; $prefix = 'Klausur'; }
        if ($event['event_type'] === 'aufgabe') { $icon = 'üìö'; $prefix = 'Aufgabe'; }

        $summary = "{$icon} {$prefix}: " . ($event['title'] ?? 'Eintrag');
        if ($event['subject_shortcut']) {
            $summary .= " (" . $event['subject_shortcut'] . ")";
        }

        $description = "Typ: " . ucfirst($event['event_type']) . "\n";
        $description .= "Fach: " . ($event['subject_shortcut'] ?? '-') . "\n";
        $description .= "Klasse: " . ($event['class_name'] ?? '?') . "\n";
        $description .= "Datum: " . $dateObj->format('d.m.Y') . $timeInfo . "\n";
        if ($event['description']) {
            $description .= "\nBeschreibung:\n" . $event['description'];
        }

        return [
            'uid' => 'acad-' . $event['event_id'],
            'dtStart' => $dtStart,
            'dtEnd' => $dtEnd,
            'dtStartFormat' => $dtStartFormat,
            'dtEndFormat' => $dtEndFormat,
            'summary' => $summary,
            'location' => $location,
            'description' => trim($description),
            'status' => 'CONFIRMED',
        ];
    }

    /** Holt und formatiert Daten f√ºr Sonderevents (aus Vertretungen) */
    private function getSubstitutionEventData(int $id): ?array
    {
        $sub = $this->planRepo->getSubstitutionById($id);
        if (!$sub || $sub['substitution_type'] !== 'Sonderevent') {
            // Nur Sonderevents zulassen
            return null; 
        }

        $dateObj = new DateTimeImmutable($sub['date'] . ' 00:00:00', $this->timezone);
        $period = (int)$sub['period_number'];
        $times = self::PERIOD_TIMES[$period] ?? null;

        if (!$times) {
            // Sollte nicht passieren, wenn Daten konsistent sind
            throw new Exception("Ung√ºltige Zeit f√ºr Sonderevent.");
        }

        $dtStart = $dateObj->setTime((int)substr($times['start'], 0, 2), (int)substr($times['start'], 2, 2));
        $dtEnd = $dateObj->setTime((int)substr($times['end'], 0, 2), (int)substr($times['end'], 2, 2));
        $dtStartFormat = 'Ymd\THis';
        $dtEndFormat = 'Ymd\THis';
        
        $summary = "Sonderevent: " . ($sub['comment'] ?: $sub['new_subject_shortcut'] ?: 'Termin');
        $location = $sub['new_room_name'] ?? '';
        
        $description = "Sonderevent\n";
        $description .= "Klasse: " . ($sub['class_name'] ?? '?') . "\n";
        $description .= "Raum: " . ($location ?: '?') . "\n";
        if ($sub['comment']) {
            $description .= "Details: " . $sub['comment'];
        }

        return [
            'uid' => 'sub-' . $sub['substitution_id'],
            'dtStart' => $dtStart,
            'dtEnd' => $dtEnd,
            'dtStartFormat' => $dtStartFormat,
            'dtEndFormat' => $dtEndFormat,
            'summary' => $summary,
            'location' => $location,
            'description' => trim($description),
            'status' => 'CONFIRMED',
        ];
    }

    /** Formatiert ein einzelnes Event als vollst√§ndigen iCal-String */
    private function formatAsIcs(array $event): string
    {
        $ics = "BEGIN:VCALENDAR\r\n";
        $ics .= "VERSION:2.0\r\n";
        $ics .= "PRODID:-//PMI//PAUSE Einzeltermin v1.0//DE\r\n";
        $ics .= "CALSCALE:GREGORIAN\r\n";
        $ics .= "METHOD:PUBLISH\r\n";

        // Zeitzonen-Definition
        $ics .= "BEGIN:VTIMEZONE\r\n";
        $ics .= "TZID:Europe/Berlin\r\n";
        $ics .= "X-LIC-LOCATION:Europe/Berlin\r\n";
        $ics .= "BEGIN:DAYLIGHT\r\n";
        $ics .= "TZOFFSETFROM:+0100\r\n";
        $ics .= "TZOFFSETTO:+0200\r\n";
        $ics .= "TZNAME:CEST\r\n";
        $ics .= "DTSTART:19700329T020000\r\n";
        $ics .= "RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=-1SU\r\n";
        $ics .= "END:DAYLIGHT\r\n";
        $ics .= "BEGIN:STANDARD\r\n";
        $ics .= "TZOFFSETFROM:+0200\r\n";
        $ics .= "TZOFFSETTO:+0100\r\n";
        $ics .= "TZNAME:CET\r\n";
        $ics .= "DTSTART:19701025T030000\r\n";
        $ics .= "RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU\r\n";
        $ics .= "END:STANDARD\r\n";
        $ics .= "END:VTIMEZONE\r\n";

        $nowUtc = gmdate('Ymd\THis\Z');

        // Event-Daten
        /** @var DateTimeImmutable $dtStart */
        /** @var DateTimeImmutable $dtEnd */
        $dtStart = $event['dtStart'];
        $dtEnd = $event['dtEnd'];
        $dtStartFormat = $event['dtStartFormat'] ?? 'Ymd\THis';
        $dtEndFormat = $event['dtEndFormat'] ?? 'Ymd\THis';
        $dtStartString = $dtStart->format($dtStartFormat);
        $dtEndString = $dtEnd->format($dtEndFormat);
        $datePrefix = ($dtStartFormat === 'Ymd') ? ';VALUE=DATE' : ';TZID=Europe/Berlin';
        
        // Korrigiere Endformat bei Zeit-Events (falls Endformat f√§lschlich Ymd war)
        if ($dtStartFormat === 'Ymd\THis' && $dtEndFormat === 'Ymd') {
             $dtEndString = $dtEnd->format('Ymd\THis');
        }

        $ics .= "BEGIN:VEVENT\r\n";
        $ics .= "UID:" . $event['uid'] . '-' . $dtStart->format('YmdHis') . "@pause.pmi\r\n";
        $ics .= "DTSTAMP:" . $nowUtc . "\r\n";
        $ics .= "DTSTART{$datePrefix}:" . $dtStartString . "\r\n";
        $ics .= "DTEND{$datePrefix}:" . $dtEndString . "\r\n";
        $ics .= "SUMMARY:" . $this->escapeIcsString($event['summary']) . "\r\n";
        if (!empty($event['location'])) {
            $ics .= "LOCATION:" . $this->escapeIcsString($event['location']) . "\r\n";
        }
        if (!empty($event['description'])) {
            $ics .= "DESCRIPTION:" . $this->escapeIcsString($event['description']) . "\r\n";
        }
        $ics .= "STATUS:" . $event['status'] . "\r\n";
        $ics .= ($dtStartFormat === 'Ymd') ? "TRANSP:TRANSPARENT\r\n" : "TRANSP:OPAQUE\r\n";
        $ics .= "END:VEVENT\r\n";

        $ics .= "END:VCALENDAR\r\n";
        return $ics;
    }

    /**
     * Bereinigt einen String f√ºr die Verwendung in iCal-Dateien.
     */
    private function escapeIcsString(?string $string): string
    {
        if ($string === null) return '';
        $string = str_replace('\\', '\\\\', $string);
        $string = str_replace(';', '\;', $string);
        $string = str_replace(',', '\,', $string);
        $string = str_replace("\r", '', $string); // CR entfernen
        $string = str_replace("\n", '\n', $string); // LF escapen
        return $string;
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\app\Services\SingleIcalService.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\app\Services\SystemHealthService.php ---
<?php
// app/Services/SystemHealthService.php

namespace App\Services;

use App\Core\Database;
use App\Core\Utils;
use PDO;
use Exception;
use PDOException; // Importiert f√ºr spezifisches DB-Error-Handling

/**
 * Service-Klasse zur Kapselung von System-Status- und Gesundheitspr√ºfungen.
 * Stellt wiederverwendbare Methoden f√ºr Controller (AdminDashboard, SystemHealth) bereit.
 */
class SystemHealthService
{
    private string $projectRoot;
    private string $publicPath;

    public function __construct()
    {
        // Geht 2 Ebenen vom 'app/Services' Verzeichnis hoch zum Projektstamm
        $this->projectRoot = dirname(__DIR__, 2);
        $this->publicPath = $this->projectRoot . '/public/';
    }

    /**
     * F√ºhrt eine umfassende Pr√ºfung aller wichtigen Systemkomponenten durch.
     * (Kombiniert die Logik aus AdminDashboardController und SystemHealthController)
     *
     * @return array Ein Array von Pr√ºfergebnissen.
     */
    public function performSystemChecks(): array
    {
        $checks = [];

        // 1. Datenbankverbindung
        $dbStatus = $this->checkDbStatus();
        $checks['database'] = [
            'label' => 'Datenbank-Verbindung',
            'status' => $dbStatus['status'] === 'ok',
            'message' => $dbStatus['message'],
            'tooltip' => 'Die Verbindung zur MySQL-Datenbank.'
        ];

        // 2. Konfigurationsdatei-Check
        $checks['config_file'] = [
            'label' => 'Konfigurationsdatei',
            'status' => true,
            'message' => 'Geladen', // (Wird in init.php geladen)
            'tooltip' => 'Datei: database_access.php'
        ];
        
        // 3. PHP Extensions
        $extensions = $this->checkExtensions();
        foreach ($extensions as $ext => $status) {
             $checks['ext_' . $ext] = [
                'label' => 'PHP Extension: ' . $ext,
                'status' => $status,
                'message' => $status ? 'OK' : 'Fehlt!',
                'tooltip' => $status ? 'Erweiterung ist geladen.' : 'Erforderlich f√ºr Kernfunktionen.'
            ];
        }

        // 4. Verzeichnis-Berechtigungen
        $directories = $this->checkDirectories();
        foreach ($directories as $name => $dir) {
             $checks[$name] = [
                'label' => 'Verzeichnis: ' . $name,
                'status' => $dir['status'] === 'ok',
                'message' => $dir['message'],
                'tooltip' => 'Pfad: ' . $dir['path_relative']
             ];
        }
        
        return $checks;
    }

    /**
     * Pr√ºft die Datenbankverbindung.
     *
     * @return array ['status' => 'ok'|'error', 'message' => string]
     */
    public function checkDbStatus(): array
    {
        try {
            $pdo = Database::getInstance();
            $pdo->query("SELECT 1");
            return ['status' => 'ok', 'message' => 'Verbunden (v' . $pdo->getAttribute(PDO::ATTR_SERVER_VERSION) . ')'];
        } catch (PDOException $e) {
            return ['status' => 'error', 'message' => 'Nicht verbunden'];
        }
    }

    /**
     * Pr√ºft wichtige PHP-Extensions.
     *
     * @return array [ext_name => bool (geladen?)]
     */
    public function checkExtensions(): array
    {
        // Kombinierte Liste der erforderlichen Erweiterungen
        $required = ['pdo_mysql', 'openssl', 'gd', 'mbstring', 'json', 'intl'];
        $status = [];

        foreach ($required as $ext) {
            $status[$ext] = extension_loaded($ext);
        }
        return $status;
    }

    /**
     * Pr√ºft, ob wichtige Verzeichnisse existieren und beschreibbar sind.
     * Versucht, Verzeichnisse zu erstellen, falls sie fehlen.
     *
     * @return array Status-Array f√ºr jedes Verzeichnis.
     */
    public function checkDirectories(): array
    {
        $dirs = [
            'cache' => $this->projectRoot . '/cache',
            'uploads/announcements' => $this->publicPath . 'uploads/announcements',
            'uploads/branding' => $this->publicPath . 'uploads/branding'
        ];
        
        $status = [];
        foreach ($dirs as $name => $path) {
            
            $pathRelative = str_replace($this->projectRoot, '', $path); // F√ºr Tooltip
            $pathRelative = str_replace($this->publicPath, 'public/', $pathRelative);
            $pathRelative = str_replace('//', '/', $pathRelative);

            if (!is_dir($path)) {
                // Versuche, das Verzeichnis zu erstellen
                if (!@mkdir($path, 0775, true)) {
                     $status[$name] = [
                        'status' => 'error', 
                        'message' => 'Fehlt & Erstellen fehlgeschlagen',
                        'path_relative' => $pathRelative
                     ];
                } else {
                     $status[$name] = [
                        'status' => 'ok', 
                        'message' => 'OK (Erstellt)',
                        'path_relative' => $pathRelative
                     ];
                }
            } else {
                // Verzeichnis existiert, teste Schreibzugriff
                $testFile = rtrim($path, '/') . '/write_test.tmp';
                if (@file_put_contents($testFile, 'test') !== false) {
                    @unlink($testFile);
                    $status[$name] = [
                        'status' => 'ok', 
                        'message' => 'Beschreibbar',
                        'path_relative' => $pathRelative
                    ];
                } else {
                    $status[$name] = [
                        'status' => 'error', 
                        'message' => 'Nicht beschreibbar!',
                        'path_relative' => $pathRelative
                    ];
                }
            }
        }
        return $status;
    }

    /**
     * Holt grundlegende System-Informationen.
     *
     * @return array
     */

    public function getSystemInfo(): array
    {
         try {
            $pdo = Database::getInstance();
            $dbVersion = $pdo->getAttribute(PDO::ATTR_SERVER_VERSION);
         } catch (Exception $e) {
            $dbVersion = 'N/A';
         }

         return [
            'php' => phpversion(),
            'db' => $dbVersion,
            'webserver' => $_SERVER['SERVER_SOFTWARE'] ?? 'N/A'
         ];
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\app\Services\SystemHealthService.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\config\database_access.php ---
<?php
// config/database_access.php

return [
    'db_host'    => '127.0.0.1', // oder 'localhost'
    'db_port'    => 3306,
    'db_name'    => 'pause_db',
    'db_user'    => 'root',
    'db_pass'    => '', // Standard-Passwort f√ºr XAMPP ist leer
    'db_charset' => 'utf8mb4',
    // WICHTIG: Die base_url muss auf den √∂ffentlichen Ordner zeigen!
    'base_url'  => '/files/PAUSE/public',


];
--- END FILE: C:\xampp\htdocs\files\PAUSE\config\database_access.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\config\routes.php ---
<?php
// config/routes.php


use App\Http\Controllers\Auth\AuthController;
use App\Http\Controllers\DashboardController;
use App\Http\Controllers\Admin\DashboardController as AdminDashboardController;
use App\Http\Controllers\Admin\StammdatenController;
use App\Http\Controllers\Admin\UserController;
use App\Http\Controllers\Admin\AnnouncementController as AdminAnnouncementController;
use App\Http\Controllers\Admin\CsvTemplateController;
use App\Http\Controllers\Admin\AuditLogController; 
use App\Http\Controllers\Admin\SettingsController;
use App\Http\Controllers\Admin\CommunityController as AdminCommunityController;
use App\Http\Controllers\Admin\SystemHealthController; 
use App\Http\Controllers\Planer\PlanController;
use App\Http\Controllers\Planer\AbsenceController;
use App\Http\Controllers\AnnouncementController;
use App\Http\Controllers\CommunityController;
use App\Http\Controllers\IcalController;
use App\Http\Controllers\PdfController;
use App\Http\Controllers\TeacherController;
use App\Http\Controllers\AcademicEventController;
use App\Http\Controllers\SingleEventController;


return [

    // --- Authentifizierung ---
    '#^login$#' => [AuthController::class, 'showLogin'],
    '#^login/process$#' => [AuthController::class, 'handleLogin'],
    '#^logout$#' => [AuthController::class, 'logout'],
    '#^logout/revert$#' => [AuthController::class, 'revertImpersonation'], // NEU: Route f√ºr Impersonation-Reset


    // --- Dashboard (Startseite nach Login) ---
    '#^$#' => [DashboardController::class, 'index'], // Root maps to dashboard
    '#^dashboard$#' => [DashboardController::class, 'index'],


    // --- Admin Bereich ---
    '#^admin/dashboard$#' => [AdminDashboardController::class, 'index'],
    '#^admin/users$#' => [UserController::class, 'index'],
    '#^admin/csv-template$#' => [CsvTemplateController::class, 'index'],
    '#^admin/stammdaten$#' => [StammdatenController::class, 'index'],
    '#^admin/announcements$#' => [AdminAnnouncementController::class, 'index'],
    '#^admin/audit-logs$#' => [AuditLogController::class, 'index'], 
    '#^admin/settings$#' => [SettingsController::class, 'index'], 
    '#^admin/community-moderation$#' => [AdminCommunityController::class, 'index'],
    '#^admin/system-health$#' => [SystemHealthController::class, 'index'], // NEU: Route hinzugef√ºgt


    // --- Planer Bereich ---
    '#^planer/dashboard$#' => [PlanController::class, 'index'],
    '#^planer/absences$#' => [AbsenceController::class, 'index'],


    // --- iCal Feed ---
    '#^ical/([a-f0-9]{64})$#' => [IcalController::class, 'generateFeed'],
    
    // --- Einzel-Event ICS Download ---
    '#^ics/event/(\w+)/(\d+)$#' => [SingleEventController::class, 'generateIcs'],


    // --- PDF Export ---
    '#^pdf/timetable/(\d{4})/(\d{1,2})$#' => [PdfController::class, 'generateTimetablePdf'],


    // --- API Routes for Stammdaten ---
    '#^api/admin/subjects$#' => [StammdatenController::class, 'getSubjects'],
    '#^api/admin/subjects/create$#' => [StammdatenController::class, 'createSubject'],
    '#^api/admin/subjects/update$#' => [StammdatenController::class, 'updateSubject'],
    '#^api/admin/subjects/delete$#' => [StammdatenController::class, 'deleteSubject'],
    '#^api/admin/rooms$#' => [StammdatenController::class, 'getRooms'],
    '#^api/admin/rooms/create$#' => [StammdatenController::class, 'createRoom'],
    '#^api/admin/rooms/update$#' => [StammdatenController::class, 'updateRoom'],
    '#^api/admin/rooms/delete$#' => [StammdatenController::class, 'deleteRoom'],
    '#^api/admin/teachers$#' => [StammdatenController::class, 'getTeachers'],
    '#^api/admin/teachers/create$#' => [StammdatenController::class, 'createTeacher'],
    '#^api/admin/teachers/update$#' => [StammdatenController::class, 'updateTeacher'],
    '#^api/admin/teachers/delete$#' => [StammdatenController::class, 'deleteTeacher'],
    '#^api/admin/classes$#' => [StammdatenController::class, 'getClasses'],
    '#^api/admin/classes/create$#' => [StammdatenController::class, 'createClass'],
    '#^api/admin/classes/update$#' => [StammdatenController::class, 'updateClass'],
    '#^api/admin/classes/delete$#' => [StammdatenController::class, 'deleteClass'],


    // --- API Routes for Users ---
    '#^api/admin/users$#' => [UserController::class, 'getUsers'],
    '#^api/admin/users/create$#' => [UserController::class, 'createUser'],
    '#^api/admin/users/update$#' => [UserController::class, 'updateUser'],
    '#^api/admin/users/delete$#' => [UserController::class, 'deleteUser'],
    '#^api/admin/users/import$#' => [UserController::class, 'importUsers'],
    '#^api/admin/users/impersonate$#' => [UserController::class, 'impersonateUserApi'],


    // --- API Routes for Admin ---
    '#^api/admin/audit-logs$#' => [AuditLogController::class, 'getLogsApi'],
    '#^api/admin/settings/save$#' => [SettingsController::class, 'save'],
    '#^api/admin/cache/clear$#' => [SettingsController::class, 'clearCacheApi'], 
    '#^api/admin/community/approve$#' => [CommunityController::class, 'approvePostApi'],
    '#^api/admin/community/reject$#' => [CommunityController::class, 'rejectPostApi'],
    '#^api/admin/community/delete$#' => [CommunityController::class, 'deletePostApi'],



    // --- API Routes for Planer ---
    '#^api/planer/data$#' => [PlanController::class, 'getTimetableData'],
    '#^api/planer/entry/save$#' => [PlanController::class, 'saveEntry'],
    '#^api/planer/entry/delete$#' => [PlanController::class, 'deleteEntry'],
    '#^api/planer/substitution/save$#' => [PlanController::class, 'saveSubstitution'],
    '#^api/planer/substitution/delete$#' => [PlanController::class, 'deleteSubstitution'],
    '#^api/planer/publish$#' => [PlanController::class, 'publish'],
    '#^api/planer/unpublish$#' => [PlanController::class, 'unpublish'],
    '#^api/planer/status$#' => [PlanController::class, 'getStatus'],
    '#^api/planer/check-conflicts$#' => [PlanController::class, 'checkConflictsApi'],
    '#^api/planer/copy-week$#' => [PlanController::class, 'copyWeek'],
    '#^api/planer/templates$#' => [PlanController::class, 'getTemplates'],
    '#^api/planer/templates/create$#' => [PlanController::class, 'createTemplate'],
    '#^api/planer/templates/apply$#' => [PlanController::class, 'applyTemplate'],
    '#^api/planer/templates/delete$#' => [PlanController::class, 'deleteTemplate'],
    '#^api/planer/templates/(\d+)$#' => [PlanController::class, 'getTemplateDetails'],
    '#^api/planer/templates/save$#' => [PlanController::class, 'saveTemplateDetails'],


    // --- API Routes for Absences ---
    '#^api/planer/absences$#' => [AbsenceController::class, 'getAbsencesApi'],
    '#^api/planer/absences/save$#' => [AbsenceController::class, 'saveAbsenceApi'],
    '#^api/planer/absences/delete$#' => [AbsenceController::class, 'deleteAbsenceApi'],


    // --- API Routes for Announcements (General API) ---
    '#^api/announcements$#' => [AnnouncementController::class, 'getAnnouncements'],
    '#^api/announcements/create$#' => [AnnouncementController::class, 'createAnnouncement'],
    '#^api/announcements/delete$#' => [AnnouncementController::class, 'deleteAnnouncement'],


    // --- API Route for User Dashboards ---
    '#^api/dashboard/weekly-data$#' => [DashboardController::class, 'getWeeklyData'],
    '#^api/student/note/save$#' => [DashboardController::class, 'saveNoteApi'],
    '#^api/student/events$#' => [AcademicEventController::class, 'getForStudent'],


    // --- API Routes for Teacher Cockpit ---
    '#^api/teacher/search-colleagues$#' => [TeacherController::class, 'searchColleaguesApi'], 
    '#^api/teacher/find-colleague$#' => [TeacherController::class, 'findColleagueApi'],
    '#^api/teacher/current-lesson$#' => [TeacherController::class, 'getCurrentLessonWithStudentsApi'],
    '#^api/teacher/attendance/save$#' => [TeacherController::class, 'saveAttendanceApi'],
    '#^api/teacher/prerequisites$#' => [TeacherController::class, 'getPrerequisitesApi'],
    
    // --- API Routes f√ºr Aufgaben/Klausuren (Lehrer) ---
    '#^api/teacher/events$#' => [AcademicEventController::class, 'getForTeacher'], // GET
    '#^api/teacher/events/create$#' => [AcademicEventController::class, 'createOrUpdate'], // POST
    '#^api/teacher/events/delete$#' => [AcademicEventController::class, 'delete'], // POST


    // --- API Routes f√ºr Sprechstunden ---
    '#^api/teacher/office-hours$#' => [TeacherController::class, 'getOfficeHoursApi'], 
    '#^api/teacher/office-hours/save$#' => [TeacherController::class, 'saveOfficeHoursApi'], 
    '#^api/teacher/office-hours/delete$#' => [TeacherController::class, 'deleteOfficeHoursApi'], 
    '#^api/student/available-slots$#' => [DashboardController::class, 'getAvailableSlotsApi'], 
    '#^api/student/book-appointment$#' => [DashboardController::class, 'bookAppointmentApi'], 
    '#^api/appointment/cancel$#' => [DashboardController::class, 'cancelAppointmentApi'],
    
    // --- API Routes f√ºr Schwarzes Brett (Community) ---
    '#^api/community/posts$#' => [CommunityController::class, 'getPostsApi'], // GET (Alle freigegebenen)
    '#^api/community/posts/create$#' => [CommunityController::class, 'createPostApi'], // POST (Sch√ºler/Lehrer erstellen)
    '#^api/community/my-posts$#' => [CommunityController::class, 'getMyPostsApi'], // GET (NEU: Sch√ºler holt seine Posts)
    '#^api/community/post/update$#' => [CommunityController::class, 'updatePostApi'], // POST (NEU: Sch√ºler/Admin bearbeitet Post)
    '#^api/community/post/delete$#' => [CommunityController::class, 'deletePostApi'], // POST (NEU: Sch√ºler/Admin l√∂scht eigenen/beliebigen Post)

];
--- END FILE: C:\xampp\htdocs\files\PAUSE\config\routes.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\libs\Parsedown.php ---
<?php

#
#
# Parsedown
# http://parsedown.org
#
# (c) Emanuil Rusev
# http://erusev.com
#
# For the full license information, view the LICENSE file that was distributed
# with this source code.
#
#

class Parsedown
{
    # ~

    const version = '1.8.0';

    # ~

    function text($text)
    {
        $Elements = $this->textElements($text);

        # convert to markup
        $markup = $this->elements($Elements);

        # trim line breaks
        $markup = trim($markup, "\n");

        return $markup;
    }

    protected function textElements($text)
    {
        # make sure no definitions are set
        $this->DefinitionData = array();

        # standardize line breaks
        $text = str_replace(array("\r\n", "\r"), "\n", $text);

        # remove surrounding line breaks
        $text = trim($text, "\n");

        # split text into lines
        $lines = explode("\n", $text);

        # iterate through lines to identify blocks
        return $this->linesElements($lines);
    }

    #
    # Setters
    #

    function setBreaksEnabled($breaksEnabled)
    {
        $this->breaksEnabled = $breaksEnabled;

        return $this;
    }

    protected $breaksEnabled;

    function setMarkupEscaped($markupEscaped)
    {
        $this->markupEscaped = $markupEscaped;

        return $this;
    }

    protected $markupEscaped;

    function setUrlsLinked($urlsLinked)
    {
        $this->urlsLinked = $urlsLinked;

        return $this;
    }

    protected $urlsLinked = true;

    function setSafeMode($safeMode)
    {
        $this->safeMode = (bool) $safeMode;

        return $this;
    }

    protected $safeMode;

    function setStrictMode($strictMode)
    {
        $this->strictMode = (bool) $strictMode;

        return $this;
    }

    protected $strictMode;

    protected $safeLinksWhitelist = array(
        'http://',
        'https://',
        'ftp://',
        'ftps://',
        'mailto:',
        'tel:',
        'data:image/png;base64,',
        'data:image/gif;base64,',
        'data:image/jpeg;base64,',
        'irc:',
        'ircs:',
        'git:',
        'ssh:',
        'news:',
        'steam:',
    );

    #
    # Lines
    #

    protected $BlockTypes = array(
        '#' => array('Header'),
        '*' => array('Rule', 'List'),
        '+' => array('List'),
        '-' => array('SetextHeader', 'Table', 'Rule', 'List'),
        '0' => array('List'),
        '1' => array('List'),
        '2' => array('List'),
        '3' => array('List'),
        '4' => array('List'),
        '5' => array('List'),
        '6' => array('List'),
        '7' => array('List'),
        '8' => array('List'),
        '9' => array('List'),
        ':' => array('Table'),
        '<' => array('Comment', 'Markup'),
        '=' => array('SetextHeader'),
        '>' => array('Quote'),
        '[' => array('Reference'),
        '_' => array('Rule'),
        '`' => array('FencedCode'),
        '|' => array('Table'),
        '~' => array('FencedCode'),
    );

    # ~

    protected $unmarkedBlockTypes = array(
        'Code',
    );

    #
    # Blocks
    #

    protected function lines(array $lines)
    {
        return $this->elements($this->linesElements($lines));
    }

    protected function linesElements(array $lines)
    {
        $Elements = array();
        $CurrentBlock = null;

        foreach ($lines as $line)
        {
            if (chop($line) === '')
            {
                if (isset($CurrentBlock))
                {
                    $CurrentBlock['interrupted'] = (isset($CurrentBlock['interrupted'])
                        ? $CurrentBlock['interrupted'] + 1 : 1
                    );
                }

                continue;
            }

            while (($beforeTab = strstr($line, "\t", true)) !== false)
            {
                $shortage = 4 - mb_strlen($beforeTab, 'utf-8') % 4;

                $line = $beforeTab
                    . str_repeat(' ', $shortage)
                    . substr($line, strlen($beforeTab) + 1)
                ;
            }

            $indent = strspn($line, ' ');

            $text = $indent > 0 ? substr($line, $indent) : $line;

            # ~

            $Line = array('body' => $line, 'indent' => $indent, 'text' => $text);

            # ~

            if (isset($CurrentBlock['continuable']))
            {
                $methodName = 'block' . $CurrentBlock['type'] . 'Continue';
                $Block = $this->$methodName($Line, $CurrentBlock);

                if (isset($Block))
                {
                    $CurrentBlock = $Block;

                    continue;
                }
                else
                {
                    if ($this->isBlockCompletable($CurrentBlock['type']))
                    {
                        $methodName = 'block' . $CurrentBlock['type'] . 'Complete';
                        $CurrentBlock = $this->$methodName($CurrentBlock);
                    }
                }
            }

            # ~

            $marker = $text[0];

            # ~

            $blockTypes = $this->unmarkedBlockTypes;

            if (isset($this->BlockTypes[$marker]))
            {
                foreach ($this->BlockTypes[$marker] as $blockType)
                {
                    $blockTypes []= $blockType;
                }
            }

            #
            # ~

            foreach ($blockTypes as $blockType)
            {
                $Block = $this->{"block$blockType"}($Line, $CurrentBlock);

                if (isset($Block))
                {
                    $Block['type'] = $blockType;

                    if ( ! isset($Block['identified']))
                    {
                        if (isset($CurrentBlock))
                        {
                            $Elements[] = $this->extractElement($CurrentBlock);
                        }

                        $Block['identified'] = true;
                    }

                    if ($this->isBlockContinuable($blockType))
                    {
                        $Block['continuable'] = true;
                    }

                    $CurrentBlock = $Block;

                    continue 2;
                }
            }

            # ~

            if (isset($CurrentBlock) and $CurrentBlock['type'] === 'Paragraph')
            {
                $Block = $this->paragraphContinue($Line, $CurrentBlock);
            }

            if (isset($Block))
            {
                $CurrentBlock = $Block;
            }
            else
            {
                if (isset($CurrentBlock))
                {
                    $Elements[] = $this->extractElement($CurrentBlock);
                }

                $CurrentBlock = $this->paragraph($Line);

                $CurrentBlock['identified'] = true;
            }
        }

        # ~

        if (isset($CurrentBlock['continuable']) and $this->isBlockCompletable($CurrentBlock['type']))
        {
            $methodName = 'block' . $CurrentBlock['type'] . 'Complete';
            $CurrentBlock = $this->$methodName($CurrentBlock);
        }

        # ~

        if (isset($CurrentBlock))
        {
            $Elements[] = $this->extractElement($CurrentBlock);
        }

        # ~

        return $Elements;
    }

    protected function extractElement(array $Component)
    {
        if ( ! isset($Component['element']))
        {
            if (isset($Component['markup']))
            {
                $Component['element'] = array('rawHtml' => $Component['markup']);
            }
            elseif (isset($Component['hidden']))
            {
                $Component['element'] = array();
            }
        }

        return $Component['element'];
    }

    protected function isBlockContinuable($Type)
    {
        return method_exists($this, 'block' . $Type . 'Continue');
    }

    protected function isBlockCompletable($Type)
    {
        return method_exists($this, 'block' . $Type . 'Complete');
    }

    #
    # Code

    protected function blockCode($Line, $Block = null)
    {
        if (isset($Block) and $Block['type'] === 'Paragraph' and ! isset($Block['interrupted']))
        {
            return;
        }

        if ($Line['indent'] >= 4)
        {
            $text = substr($Line['body'], 4);

            $Block = array(
                'element' => array(
                    'name' => 'pre',
                    'element' => array(
                        'name' => 'code',
                        'text' => $text,
                    ),
                ),
            );

            return $Block;
        }
    }

    protected function blockCodeContinue($Line, $Block)
    {
        if ($Line['indent'] >= 4)
        {
            if (isset($Block['interrupted']))
            {
                $Block['element']['element']['text'] .= str_repeat("\n", $Block['interrupted']);

                unset($Block['interrupted']);
            }

            $Block['element']['element']['text'] .= "\n";

            $text = substr($Line['body'], 4);

            $Block['element']['element']['text'] .= $text;

            return $Block;
        }
    }

    protected function blockCodeComplete($Block)
    {
        return $Block;
    }

    #
    # Comment

    protected function blockComment($Line)
    {
        if ($this->markupEscaped or $this->safeMode)
        {
            return;
        }

        if (strpos($Line['text'], '<!--') === 0)
        {
            $Block = array(
                'element' => array(
                    'rawHtml' => $Line['body'],
                    'autobreak' => true,
                ),
            );

            if (strpos($Line['text'], '-->') !== false)
            {
                $Block['closed'] = true;
            }

            return $Block;
        }
    }

    protected function blockCommentContinue($Line, array $Block)
    {
        if (isset($Block['closed']))
        {
            return;
        }

        $Block['element']['rawHtml'] .= "\n" . $Line['body'];

        if (strpos($Line['text'], '-->') !== false)
        {
            $Block['closed'] = true;
        }

        return $Block;
    }

    #
    # Fenced Code

    protected function blockFencedCode($Line)
    {
        $marker = $Line['text'][0];

        $openerLength = strspn($Line['text'], $marker);

        if ($openerLength < 3)
        {
            return;
        }

        $infostring = trim(substr($Line['text'], $openerLength), "\t ");

        if (strpos($infostring, '`') !== false)
        {
            return;
        }

        $Element = array(
            'name' => 'code',
            'text' => '',
        );

        if ($infostring !== '')
        {
            /**
             * https://www.w3.org/TR/2011/WD-html5-20110525/elements.html#classes
             * Every HTML element may have a class attribute specified.
             * The attribute, if specified, must have a value that is a set
             * of space-separated tokens representing the various classes
             * that the element belongs to.
             * [...]
             * The space characters, for the purposes of this specification,
             * are U+0020 SPACE, U+0009 CHARACTER TABULATION (tab),
             * U+000A LINE FEED (LF), U+000C FORM FEED (FF), and
             * U+000D CARRIAGE RETURN (CR).
             */
            $language = substr($infostring, 0, strcspn($infostring, " \t\n\f\r"));

            $Element['attributes'] = array('class' => "language-$language");
        }

        $Block = array(
            'char' => $marker,
            'openerLength' => $openerLength,
            'element' => array(
                'name' => 'pre',
                'element' => $Element,
            ),
        );

        return $Block;
    }

    protected function blockFencedCodeContinue($Line, $Block)
    {
        if (isset($Block['complete']))
        {
            return;
        }

        if (isset($Block['interrupted']))
        {
            $Block['element']['element']['text'] .= str_repeat("\n", $Block['interrupted']);

            unset($Block['interrupted']);
        }

        if (($len = strspn($Line['text'], $Block['char'])) >= $Block['openerLength']
            and chop(substr($Line['text'], $len), ' ') === ''
        ) {
            $Block['element']['element']['text'] = substr($Block['element']['element']['text'], 1);

            $Block['complete'] = true;

            return $Block;
        }

        $Block['element']['element']['text'] .= "\n" . $Line['body'];

        return $Block;
    }

    protected function blockFencedCodeComplete($Block)
    {
        return $Block;
    }

    #
    # Header

    protected function blockHeader($Line)
    {
        $level = strspn($Line['text'], '#');

        if ($level > 6)
        {
            return;
        }

        $text = trim($Line['text'], '#');

        if ($this->strictMode and isset($text[0]) and $text[0] !== ' ')
        {
            return;
        }

        $text = trim($text, ' ');

        $Block = array(
            'element' => array(
                'name' => 'h' . $level,
                'handler' => array(
                    'function' => 'lineElements',
                    'argument' => $text,
                    'destination' => 'elements',
                )
            ),
        );

        return $Block;
    }

    #
    # List

    protected function blockList($Line, ?array $CurrentBlock = null)
    {
        list($name, $pattern) = $Line['text'][0] <= '-' ? array('ul', '[*+-]') : array('ol', '[0-9]{1,9}+[.\)]');

        if (preg_match('/^('.$pattern.'([ ]++|$))(.*+)/', $Line['text'], $matches))
        {
            $contentIndent = strlen($matches[2]);

            if ($contentIndent >= 5)
            {
                $contentIndent -= 1;
                $matches[1] = substr($matches[1], 0, -$contentIndent);
                $matches[3] = str_repeat(' ', $contentIndent) . $matches[3];
            }
            elseif ($contentIndent === 0)
            {
                $matches[1] .= ' ';
            }

            $markerWithoutWhitespace = strstr($matches[1], ' ', true);

            $Block = array(
                'indent' => $Line['indent'],
                'pattern' => $pattern,
                'data' => array(
                    'type' => $name,
                    'marker' => $matches[1],
                    'markerType' => ($name === 'ul' ? $markerWithoutWhitespace : substr($markerWithoutWhitespace, -1)),
                ),
                'element' => array(
                    'name' => $name,
                    'elements' => array(),
                ),
            );
            $Block['data']['markerTypeRegex'] = preg_quote($Block['data']['markerType'], '/');

            if ($name === 'ol')
            {
                $listStart = ltrim(strstr($matches[1], $Block['data']['markerType'], true), '0') ?: '0';

                if ($listStart !== '1')
                {
                    if (
                        isset($CurrentBlock)
                        and $CurrentBlock['type'] === 'Paragraph'
                        and ! isset($CurrentBlock['interrupted'])
                    ) {
                        return;
                    }

                    $Block['element']['attributes'] = array('start' => $listStart);
                }
            }

            $Block['li'] = array(
                'name' => 'li',
                'handler' => array(
                    'function' => 'li',
                    'argument' => !empty($matches[3]) ? array($matches[3]) : array(),
                    'destination' => 'elements'
                )
            );

            $Block['element']['elements'] []= & $Block['li'];

            return $Block;
        }
    }

    protected function blockListContinue($Line, array $Block)
    {
        if (isset($Block['interrupted']) and empty($Block['li']['handler']['argument']))
        {
            return null;
        }

        $requiredIndent = ($Block['indent'] + strlen($Block['data']['marker']));

        if ($Line['indent'] < $requiredIndent
            and (
                (
                    $Block['data']['type'] === 'ol'
                    and preg_match('/^[0-9]++'.$Block['data']['markerTypeRegex'].'(?:[ ]++(.*)|$)/', $Line['text'], $matches)
                ) or (
                    $Block['data']['type'] === 'ul'
                    and preg_match('/^'.$Block['data']['markerTypeRegex'].'(?:[ ]++(.*)|$)/', $Line['text'], $matches)
                )
            )
        ) {
            if (isset($Block['interrupted']))
            {
                $Block['li']['handler']['argument'] []= '';

                $Block['loose'] = true;

                unset($Block['interrupted']);
            }

            unset($Block['li']);

            $text = isset($matches[1]) ? $matches[1] : '';

            $Block['indent'] = $Line['indent'];

            $Block['li'] = array(
                'name' => 'li',
                'handler' => array(
                    'function' => 'li',
                    'argument' => array($text),
                    'destination' => 'elements'
                )
            );

            $Block['element']['elements'] []= & $Block['li'];

            return $Block;
        }
        elseif ($Line['indent'] < $requiredIndent and $this->blockList($Line))
        {
            return null;
        }

        if ($Line['text'][0] === '[' and $this->blockReference($Line))
        {
            return $Block;
        }

        if ($Line['indent'] >= $requiredIndent)
        {
            if (isset($Block['interrupted']))
            {
                $Block['li']['handler']['argument'] []= '';

                $Block['loose'] = true;

                unset($Block['interrupted']);
            }

            $text = substr($Line['body'], $requiredIndent);

            $Block['li']['handler']['argument'] []= $text;

            return $Block;
        }

        if ( ! isset($Block['interrupted']))
        {
            $text = preg_replace('/^[ ]{0,'.$requiredIndent.'}+/', '', $Line['body']);

            $Block['li']['handler']['argument'] []= $text;

            return $Block;
        }
    }

    protected function blockListComplete(array $Block)
    {
        if (isset($Block['loose']))
        {
            foreach ($Block['element']['elements'] as &$li)
            {
                if (end($li['handler']['argument']) !== '')
                {
                    $li['handler']['argument'] []= '';
                }
            }
        }

        return $Block;
    }

    #
    # Quote

    protected function blockQuote($Line)
    {
        if (preg_match('/^>[ ]?+(.*+)/', $Line['text'], $matches))
        {
            $Block = array(
                'element' => array(
                    'name' => 'blockquote',
                    'handler' => array(
                        'function' => 'linesElements',
                        'argument' => (array) $matches[1],
                        'destination' => 'elements',
                    )
                ),
            );

            return $Block;
        }
    }

    protected function blockQuoteContinue($Line, array $Block)
    {
        if (isset($Block['interrupted']))
        {
            return;
        }

        if ($Line['text'][0] === '>' and preg_match('/^>[ ]?+(.*+)/', $Line['text'], $matches))
        {
            $Block['element']['handler']['argument'] []= $matches[1];

            return $Block;
        }

        if ( ! isset($Block['interrupted']))
        {
            $Block['element']['handler']['argument'] []= $Line['text'];

            return $Block;
        }
    }

    #
    # Rule

    protected function blockRule($Line)
    {
        $marker = $Line['text'][0];

        if (substr_count($Line['text'], $marker) >= 3 and chop($Line['text'], " $marker") === '')
        {
            $Block = array(
                'element' => array(
                    'name' => 'hr',
                ),
            );

            return $Block;
        }
    }

    #
    # Setext

    protected function blockSetextHeader($Line, ?array $Block = null)
    {
        if ( ! isset($Block) or $Block['type'] !== 'Paragraph' or isset($Block['interrupted']))
        {
            return;
        }

        if ($Line['indent'] < 4 and chop(chop($Line['text'], ' '), $Line['text'][0]) === '')
        {
            $Block['element']['name'] = $Line['text'][0] === '=' ? 'h1' : 'h2';

            return $Block;
        }
    }

    #
    # Markup

    protected function blockMarkup($Line)
    {
        if ($this->markupEscaped or $this->safeMode)
        {
            return;
        }

        if (preg_match('/^<[\/]?+(\w*)(?:[ ]*+'.$this->regexHtmlAttribute.')*+[ ]*+(\/)?>/', $Line['text'], $matches))
        {
            $element = strtolower($matches[1]);

            if (in_array($element, $this->textLevelElements))
            {
                return;
            }

            $Block = array(
                'name' => $matches[1],
                'element' => array(
                    'rawHtml' => $Line['text'],
                    'autobreak' => true,
                ),
            );

            return $Block;
        }
    }

    protected function blockMarkupContinue($Line, array $Block)
    {
        if (isset($Block['closed']) or isset($Block['interrupted']))
        {
            return;
        }

        $Block['element']['rawHtml'] .= "\n" . $Line['body'];

        return $Block;
    }

    #
    # Reference

    protected function blockReference($Line)
    {
        if (strpos($Line['text'], ']') !== false
            and preg_match('/^\[(.+?)\]:[ ]*+<?(\S+?)>?(?:[ ]+["\'(](.+)["\')])?[ ]*+$/', $Line['text'], $matches)
        ) {
            $id = strtolower($matches[1]);

            $Data = array(
                'url' => $matches[2],
                'title' => isset($matches[3]) ? $matches[3] : null,
            );

            $this->DefinitionData['Reference'][$id] = $Data;

            $Block = array(
                'element' => array(),
            );

            return $Block;
        }
    }

    #
    # Table

    protected function blockTable($Line, ?array $Block = null)
    {
        if ( ! isset($Block) or $Block['type'] !== 'Paragraph' or isset($Block['interrupted']))
        {
            return;
        }

        if (
            strpos($Block['element']['handler']['argument'], '|') === false
            and strpos($Line['text'], '|') === false
            and strpos($Line['text'], ':') === false
            or strpos($Block['element']['handler']['argument'], "\n") !== false
        ) {
            return;
        }

        if (chop($Line['text'], ' -:|') !== '')
        {
            return;
        }

        $alignments = array();

        $divider = $Line['text'];

        $divider = trim($divider);
        $divider = trim($divider, '|');

        $dividerCells = explode('|', $divider);

        foreach ($dividerCells as $dividerCell)
        {
            $dividerCell = trim($dividerCell);

            if ($dividerCell === '')
            {
                return;
            }

            $alignment = null;

            if ($dividerCell[0] === ':')
            {
                $alignment = 'left';
            }

            if (substr($dividerCell, - 1) === ':')
            {
                $alignment = $alignment === 'left' ? 'center' : 'right';
            }

            $alignments []= $alignment;
        }

        # ~

        $HeaderElements = array();

        $header = $Block['element']['handler']['argument'];

        $header = trim($header);
        $header = trim($header, '|');

        $headerCells = explode('|', $header);

        if (count($headerCells) !== count($alignments))
        {
            return;
        }

        foreach ($headerCells as $index => $headerCell)
        {
            $headerCell = trim($headerCell);

            $HeaderElement = array(
                'name' => 'th',
                'handler' => array(
                    'function' => 'lineElements',
                    'argument' => $headerCell,
                    'destination' => 'elements',
                )
            );

            if (isset($alignments[$index]))
            {
                $alignment = $alignments[$index];

                $HeaderElement['attributes'] = array(
                    'style' => "text-align: $alignment;",
                );
            }

            $HeaderElements []= $HeaderElement;
        }

        # ~

        $Block = array(
            'alignments' => $alignments,
            'identified' => true,
            'element' => array(
                'name' => 'table',
                'elements' => array(),
            ),
        );

        $Block['element']['elements'] []= array(
            'name' => 'thead',
        );

        $Block['element']['elements'] []= array(
            'name' => 'tbody',
            'elements' => array(),
        );

        $Block['element']['elements'][0]['elements'] []= array(
            'name' => 'tr',
            'elements' => $HeaderElements,
        );

        return $Block;
    }

    protected function blockTableContinue($Line, array $Block)
    {
        if (isset($Block['interrupted']))
        {
            return;
        }

        if (count($Block['alignments']) === 1 or $Line['text'][0] === '|' or strpos($Line['text'], '|'))
        {
            $Elements = array();

            $row = $Line['text'];

            $row = trim($row);
            $row = trim($row, '|');

            preg_match_all('/(?:(\\\\[|])|[^|`]|`[^`]++`|`)++/', $row, $matches);

            $cells = array_slice($matches[0], 0, count($Block['alignments']));

            foreach ($cells as $index => $cell)
            {
                $cell = trim($cell);

                $Element = array(
                    'name' => 'td',
                    'handler' => array(
                        'function' => 'lineElements',
                        'argument' => $cell,
                        'destination' => 'elements',
                    )
                );

                if (isset($Block['alignments'][$index]))
                {
                    $Element['attributes'] = array(
                        'style' => 'text-align: ' . $Block['alignments'][$index] . ';',
                    );
                }

                $Elements []= $Element;
            }

            $Element = array(
                'name' => 'tr',
                'elements' => $Elements,
            );

            $Block['element']['elements'][1]['elements'] []= $Element;

            return $Block;
        }
    }

    #
    # ~
    #

    protected function paragraph($Line)
    {
        return array(
            'type' => 'Paragraph',
            'element' => array(
                'name' => 'p',
                'handler' => array(
                    'function' => 'lineElements',
                    'argument' => $Line['text'],
                    'destination' => 'elements',
                ),
            ),
        );
    }

    protected function paragraphContinue($Line, array $Block)
    {
        if (isset($Block['interrupted']))
        {
            return;
        }

        $Block['element']['handler']['argument'] .= "\n".$Line['text'];

        return $Block;
    }

    #
    # Inline Elements
    #

    protected $InlineTypes = array(
        '!' => array('Image'),
        '&' => array('SpecialCharacter'),
        '*' => array('Emphasis'),
        ':' => array('Url'),
        '<' => array('UrlTag', 'EmailTag', 'Markup'),
        '[' => array('Link'),
        '_' => array('Emphasis'),
        '`' => array('Code'),
        '~' => array('Strikethrough'),
        '\\' => array('EscapeSequence'),
    );

    # ~

    protected $inlineMarkerList = '!*_&[:<`~\\';

    #
    # ~
    #

    public function line($text, $nonNestables = array())
    {
        return $this->elements($this->lineElements($text, $nonNestables));
    }

    protected function lineElements($text, $nonNestables = array())
    {
        # standardize line breaks
        $text = str_replace(array("\r\n", "\r"), "\n", $text);

        $Elements = array();

        $nonNestables = (empty($nonNestables)
            ? array()
            : array_combine($nonNestables, $nonNestables)
        );

        # $excerpt is based on the first occurrence of a marker

        while ($excerpt = strpbrk($text, $this->inlineMarkerList))
        {
            $marker = $excerpt[0];

            $markerPosition = strlen($text) - strlen($excerpt);

            $Excerpt = array('text' => $excerpt, 'context' => $text);

            foreach ($this->InlineTypes[$marker] as $inlineType)
            {
                # check to see if the current inline type is nestable in the current context

                if (isset($nonNestables[$inlineType]))
                {
                    continue;
                }

                $Inline = $this->{"inline$inlineType"}($Excerpt);

                if ( ! isset($Inline))
                {
                    continue;
                }

                # makes sure that the inline belongs to "our" marker

                if (isset($Inline['position']) and $Inline['position'] > $markerPosition)
                {
                    continue;
                }

                # sets a default inline position

                if ( ! isset($Inline['position']))
                {
                    $Inline['position'] = $markerPosition;
                }

                # cause the new element to 'inherit' our non nestables


                $Inline['element']['nonNestables'] = isset($Inline['element']['nonNestables'])
                    ? array_merge($Inline['element']['nonNestables'], $nonNestables)
                    : $nonNestables
                ;

                # the text that comes before the inline
                $unmarkedText = substr($text, 0, $Inline['position']);

                # compile the unmarked text
                $InlineText = $this->inlineText($unmarkedText);
                $Elements[] = $InlineText['element'];

                # compile the inline
                $Elements[] = $this->extractElement($Inline);

                # remove the examined text
                $text = substr($text, $Inline['position'] + $Inline['extent']);

                continue 2;
            }

            # the marker does not belong to an inline

            $unmarkedText = substr($text, 0, $markerPosition + 1);

            $InlineText = $this->inlineText($unmarkedText);
            $Elements[] = $InlineText['element'];

            $text = substr($text, $markerPosition + 1);
        }

        $InlineText = $this->inlineText($text);
        $Elements[] = $InlineText['element'];

        foreach ($Elements as &$Element)
        {
            if ( ! isset($Element['autobreak']))
            {
                $Element['autobreak'] = false;
            }
        }

        return $Elements;
    }

    #
    # ~
    #

    protected function inlineText($text)
    {
        $Inline = array(
            'extent' => strlen($text),
            'element' => array(),
        );

        $Inline['element']['elements'] = self::pregReplaceElements(
            $this->breaksEnabled ? '/[ ]*+\n/' : '/(?:[ ]*+\\\\|[ ]{2,}+)\n/',
            array(
                array('name' => 'br'),
                array('text' => "\n"),
            ),
            $text
        );

        return $Inline;
    }

    protected function inlineCode($Excerpt)
    {
        $marker = $Excerpt['text'][0];

        if (preg_match('/^(['.$marker.']++)[ ]*+(.+?)[ ]*+(?<!['.$marker.'])\1(?!'.$marker.')/s', $Excerpt['text'], $matches))
        {
            $text = $matches[2];
            $text = preg_replace('/[ ]*+\n/', ' ', $text);

            return array(
                'extent' => strlen($matches[0]),
                'element' => array(
                    'name' => 'code',
                    'text' => $text,
                ),
            );
        }
    }

    protected function inlineEmailTag($Excerpt)
    {
        $hostnameLabel = '[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?';

        $commonMarkEmail = '[a-zA-Z0-9.!#$%&\'*+\/=?^_`{|}~-]++@'
            . $hostnameLabel . '(?:\.' . $hostnameLabel . ')*';

        if (strpos($Excerpt['text'], '>') !== false
            and preg_match("/^<((mailto:)?$commonMarkEmail)>/i", $Excerpt['text'], $matches)
        ){
            $url = $matches[1];

            if ( ! isset($matches[2]))
            {
                $url = "mailto:$url";
            }

            return array(
                'extent' => strlen($matches[0]),
                'element' => array(
                    'name' => 'a',
                    'text' => $matches[1],
                    'attributes' => array(
                        'href' => $url,
                    ),
                ),
            );
        }
    }

    protected function inlineEmphasis($Excerpt)
    {
        if ( ! isset($Excerpt['text'][1]))
        {
            return;
        }

        $marker = $Excerpt['text'][0];

        if ($Excerpt['text'][1] === $marker and preg_match($this->StrongRegex[$marker], $Excerpt['text'], $matches))
        {
            $emphasis = 'strong';
        }
        elseif (preg_match($this->EmRegex[$marker], $Excerpt['text'], $matches))
        {
            $emphasis = 'em';
        }
        else
        {
            return;
        }

        return array(
            'extent' => strlen($matches[0]),
            'element' => array(
                'name' => $emphasis,
                'handler' => array(
                    'function' => 'lineElements',
                    'argument' => $matches[1],
                    'destination' => 'elements',
                )
            ),
        );
    }

    protected function inlineEscapeSequence($Excerpt)
    {
        if (isset($Excerpt['text'][1]) and in_array($Excerpt['text'][1], $this->specialCharacters))
        {
            return array(
                'element' => array('rawHtml' => $Excerpt['text'][1]),
                'extent' => 2,
            );
        }
    }

    protected function inlineImage($Excerpt)
    {
        if ( ! isset($Excerpt['text'][1]) or $Excerpt['text'][1] !== '[')
        {
            return;
        }

        $Excerpt['text']= substr($Excerpt['text'], 1);

        $Link = $this->inlineLink($Excerpt);

        if ($Link === null)
        {
            return;
        }

        $Inline = array(
            'extent' => $Link['extent'] + 1,
            'element' => array(
                'name' => 'img',
                'attributes' => array(
                    'src' => $Link['element']['attributes']['href'],
                    'alt' => $Link['element']['handler']['argument'],
                ),
                'autobreak' => true,
            ),
        );

        $Inline['element']['attributes'] += $Link['element']['attributes'];

        unset($Inline['element']['attributes']['href']);

        return $Inline;
    }

    protected function inlineLink($Excerpt)
    {
        $Element = array(
            'name' => 'a',
            'handler' => array(
                'function' => 'lineElements',
                'argument' => null,
                'destination' => 'elements',
            ),
            'nonNestables' => array('Url', 'Link'),
            'attributes' => array(
                'href' => null,
                'title' => null,
            ),
        );

        $extent = 0;

        $remainder = $Excerpt['text'];

        if (preg_match('/\[((?:[^][]++|(?R))*+)\]/', $remainder, $matches))
        {
            $Element['handler']['argument'] = $matches[1];

            $extent += strlen($matches[0]);

            $remainder = substr($remainder, $extent);
        }
        else
        {
            return;
        }

        if (preg_match('/^[(]\s*+((?:[^ ()]++|[(][^ )]+[)])++)(?:[ ]+("[^"]*+"|\'[^\']*+\'))?\s*+[)]/', $remainder, $matches))
        {
            $Element['attributes']['href'] = $matches[1];

            if (isset($matches[2]))
            {
                $Element['attributes']['title'] = substr($matches[2], 1, - 1);
            }

            $extent += strlen($matches[0]);
        }
        else
        {
            if (preg_match('/^\s*\[(.*?)\]/', $remainder, $matches))
            {
                $definition = strlen($matches[1]) ? $matches[1] : $Element['handler']['argument'];
                $definition = strtolower($definition);

                $extent += strlen($matches[0]);
            }
            else
            {
                $definition = strtolower($Element['handler']['argument']);
            }

            if ( ! isset($this->DefinitionData['Reference'][$definition]))
            {
                return;
            }

            $Definition = $this->DefinitionData['Reference'][$definition];

            $Element['attributes']['href'] = $Definition['url'];
            $Element['attributes']['title'] = $Definition['title'];
        }

        return array(
            'extent' => $extent,
            'element' => $Element,
        );
    }

    protected function inlineMarkup($Excerpt)
    {
        if ($this->markupEscaped or $this->safeMode or strpos($Excerpt['text'], '>') === false)
        {
            return;
        }

        if ($Excerpt['text'][1] === '/' and preg_match('/^<\/\w[\w-]*+[ ]*+>/s', $Excerpt['text'], $matches))
        {
            return array(
                'element' => array('rawHtml' => $matches[0]),
                'extent' => strlen($matches[0]),
            );
        }

        if ($Excerpt['text'][1] === '!' and preg_match('/^<!---?[^>-](?:-?+[^-])*-->/s', $Excerpt['text'], $matches))
        {
            return array(
                'element' => array('rawHtml' => $matches[0]),
                'extent' => strlen($matches[0]),
            );
        }

        if ($Excerpt['text'][1] !== ' ' and preg_match('/^<\w[\w-]*+(?:[ ]*+'.$this->regexHtmlAttribute.')*+[ ]*+\/?>/s', $Excerpt['text'], $matches))
        {
            return array(
                'element' => array('rawHtml' => $matches[0]),
                'extent' => strlen($matches[0]),
            );
        }
    }

    protected function inlineSpecialCharacter($Excerpt)
    {
        if (substr($Excerpt['text'], 1, 1) !== ' ' and strpos($Excerpt['text'], ';') !== false
            and preg_match('/^&(#?+[0-9a-zA-Z]++);/', $Excerpt['text'], $matches)
        ) {
            return array(
                'element' => array('rawHtml' => '&' . $matches[1] . ';'),
                'extent' => strlen($matches[0]),
            );
        }

        return;
    }

    protected function inlineStrikethrough($Excerpt)
    {
        if ( ! isset($Excerpt['text'][1]))
        {
            return;
        }

        if ($Excerpt['text'][1] === '~' and preg_match('/^~~(?=\S)(.+?)(?<=\S)~~/', $Excerpt['text'], $matches))
        {
            return array(
                'extent' => strlen($matches[0]),
                'element' => array(
                    'name' => 'del',
                    'handler' => array(
                        'function' => 'lineElements',
                        'argument' => $matches[1],
                        'destination' => 'elements',
                    )
                ),
            );
        }
    }

    protected function inlineUrl($Excerpt)
    {
        if ($this->urlsLinked !== true or ! isset($Excerpt['text'][2]) or $Excerpt['text'][2] !== '/')
        {
            return;
        }

        if (strpos($Excerpt['context'], 'http') !== false
            and preg_match('/\bhttps?+:[\/]{2}[^\s<]+\b\/*+/ui', $Excerpt['context'], $matches, PREG_OFFSET_CAPTURE)
        ) {
            $url = $matches[0][0];

            $Inline = array(
                'extent' => strlen($matches[0][0]),
                'position' => $matches[0][1],
                'element' => array(
                    'name' => 'a',
                    'text' => $url,
                    'attributes' => array(
                        'href' => $url,
                    ),
                ),
            );

            return $Inline;
        }
    }

    protected function inlineUrlTag($Excerpt)
    {
        if (strpos($Excerpt['text'], '>') !== false and preg_match('/^<(\w++:\/{2}[^ >]++)>/i', $Excerpt['text'], $matches))
        {
            $url = $matches[1];

            return array(
                'extent' => strlen($matches[0]),
                'element' => array(
                    'name' => 'a',
                    'text' => $url,
                    'attributes' => array(
                        'href' => $url,
                    ),
                ),
            );
        }
    }

    # ~

    protected function unmarkedText($text)
    {
        $Inline = $this->inlineText($text);
        return $this->element($Inline['element']);
    }

    #
    # Handlers
    #

    protected function handle(array $Element)
    {
        if (isset($Element['handler']))
        {
            if (!isset($Element['nonNestables']))
            {
                $Element['nonNestables'] = array();
            }

            if (is_string($Element['handler']))
            {
                $function = $Element['handler'];
                $argument = $Element['text'];
                unset($Element['text']);
                $destination = 'rawHtml';
            }
            else
            {
                $function = $Element['handler']['function'];
                $argument = $Element['handler']['argument'];
                $destination = $Element['handler']['destination'];
            }

            $Element[$destination] = $this->{$function}($argument, $Element['nonNestables']);

            if ($destination === 'handler')
            {
                $Element = $this->handle($Element);
            }

            unset($Element['handler']);
        }

        return $Element;
    }

    protected function handleElementRecursive(array $Element)
    {
        return $this->elementApplyRecursive(array($this, 'handle'), $Element);
    }

    protected function handleElementsRecursive(array $Elements)
    {
        return $this->elementsApplyRecursive(array($this, 'handle'), $Elements);
    }

    protected function elementApplyRecursive($closure, array $Element)
    {
        $Element = call_user_func($closure, $Element);

        if (isset($Element['elements']))
        {
            $Element['elements'] = $this->elementsApplyRecursive($closure, $Element['elements']);
        }
        elseif (isset($Element['element']))
        {
            $Element['element'] = $this->elementApplyRecursive($closure, $Element['element']);
        }

        return $Element;
    }

    protected function elementApplyRecursiveDepthFirst($closure, array $Element)
    {
        if (isset($Element['elements']))
        {
            $Element['elements'] = $this->elementsApplyRecursiveDepthFirst($closure, $Element['elements']);
        }
        elseif (isset($Element['element']))
        {
            $Element['element'] = $this->elementsApplyRecursiveDepthFirst($closure, $Element['element']);
        }

        $Element = call_user_func($closure, $Element);

        return $Element;
    }

    protected function elementsApplyRecursive($closure, array $Elements)
    {
        foreach ($Elements as &$Element)
        {
            $Element = $this->elementApplyRecursive($closure, $Element);
        }

        return $Elements;
    }

    protected function elementsApplyRecursiveDepthFirst($closure, array $Elements)
    {
        foreach ($Elements as &$Element)
        {
            $Element = $this->elementApplyRecursiveDepthFirst($closure, $Element);
        }

        return $Elements;
    }

    protected function element(array $Element)
    {
        if ($this->safeMode)
        {
            $Element = $this->sanitiseElement($Element);
        }

        # identity map if element has no handler
        $Element = $this->handle($Element);

        $hasName = isset($Element['name']);

        $markup = '';

        if ($hasName)
        {
            $markup .= '<' . $Element['name'];

            if (isset($Element['attributes']))
            {
                foreach ($Element['attributes'] as $name => $value)
                {
                    if ($value === null)
                    {
                        continue;
                    }

                    $markup .= " $name=\"".self::escape($value).'"';
                }
            }
        }

        $permitRawHtml = false;

        if (isset($Element['text']))
        {
            $text = $Element['text'];
        }
        // very strongly consider an alternative if you're writing an
        // extension
        elseif (isset($Element['rawHtml']))
        {
            $text = $Element['rawHtml'];

            $allowRawHtmlInSafeMode = isset($Element['allowRawHtmlInSafeMode']) && $Element['allowRawHtmlInSafeMode'];
            $permitRawHtml = !$this->safeMode || $allowRawHtmlInSafeMode;
        }

        $hasContent = isset($text) || isset($Element['element']) || isset($Element['elements']);

        if ($hasContent)
        {
            $markup .= $hasName ? '>' : '';

            if (isset($Element['elements']))
            {
                $markup .= $this->elements($Element['elements']);
            }
            elseif (isset($Element['element']))
            {
                $markup .= $this->element($Element['element']);
            }
            else
            {
                if (!$permitRawHtml)
                {
                    $markup .= self::escape($text, true);
                }
                else
                {
                    $markup .= $text;
                }
            }

            $markup .= $hasName ? '</' . $Element['name'] . '>' : '';
        }
        elseif ($hasName)
        {
            $markup .= ' />';
        }

        return $markup;
    }

    protected function elements(array $Elements)
    {
        $markup = '';

        $autoBreak = true;

        foreach ($Elements as $Element)
        {
            if (empty($Element))
            {
                continue;
            }

            $autoBreakNext = (isset($Element['autobreak'])
                ? $Element['autobreak'] : isset($Element['name'])
            );
            // (autobreak === false) covers both sides of an element
            $autoBreak = !$autoBreak ? $autoBreak : $autoBreakNext;

            $markup .= ($autoBreak ? "\n" : '') . $this->element($Element);
            $autoBreak = $autoBreakNext;
        }

        $markup .= $autoBreak ? "\n" : '';

        return $markup;
    }

    # ~

    protected function li($lines)
    {
        $Elements = $this->linesElements($lines);

        if ( ! in_array('', $lines)
            and isset($Elements[0]) and isset($Elements[0]['name'])
            and $Elements[0]['name'] === 'p'
        ) {
            unset($Elements[0]['name']);
        }

        return $Elements;
    }

    #
    # AST Convenience
    #

    /**
     * Replace occurrences $regexp with $Elements in $text. Return an array of
     * elements representing the replacement.
     */
    protected static function pregReplaceElements($regexp, $Elements, $text)
    {
        $newElements = array();

        while (preg_match($regexp, $text, $matches, PREG_OFFSET_CAPTURE))
        {
            $offset = $matches[0][1];
            $before = substr($text, 0, $offset);
            $after = substr($text, $offset + strlen($matches[0][0]));

            $newElements[] = array('text' => $before);

            foreach ($Elements as $Element)
            {
                $newElements[] = $Element;
            }

            $text = $after;
        }

        $newElements[] = array('text' => $text);

        return $newElements;
    }

    #
    # Deprecated Methods
    #

    function parse($text)
    {
        $markup = $this->text($text);

        return $markup;
    }

    protected function sanitiseElement(array $Element)
    {
        static $goodAttribute = '/^[a-zA-Z0-9][a-zA-Z0-9-_]*+$/';
        static $safeUrlNameToAtt  = array(
            'a'   => 'href',
            'img' => 'src',
        );

        if ( ! isset($Element['name']))
        {
            unset($Element['attributes']);
            return $Element;
        }

        if (isset($safeUrlNameToAtt[$Element['name']]))
        {
            $Element = $this->filterUnsafeUrlInAttribute($Element, $safeUrlNameToAtt[$Element['name']]);
        }

        if ( ! empty($Element['attributes']))
        {
            foreach ($Element['attributes'] as $att => $val)
            {
                # filter out badly parsed attribute
                if ( ! preg_match($goodAttribute, $att))
                {
                    unset($Element['attributes'][$att]);
                }
                # dump onevent attribute
                elseif (self::striAtStart($att, 'on'))
                {
                    unset($Element['attributes'][$att]);
                }
            }
        }

        return $Element;
    }

    protected function filterUnsafeUrlInAttribute(array $Element, $attribute)
    {
        foreach ($this->safeLinksWhitelist as $scheme)
        {
            if (self::striAtStart($Element['attributes'][$attribute], $scheme))
            {
                return $Element;
            }
        }

        $Element['attributes'][$attribute] = str_replace(':', '%3A', $Element['attributes'][$attribute]);

        return $Element;
    }

    #
    # Static Methods
    #

    protected static function escape($text, $allowQuotes = false)
    {
        return htmlspecialchars($text, $allowQuotes ? ENT_NOQUOTES : ENT_QUOTES, 'UTF-8');
    }

    protected static function striAtStart($string, $needle)
    {
        $len = strlen($needle);

        if ($len > strlen($string))
        {
            return false;
        }
        else
        {
            return strtolower(substr($string, 0, $len)) === strtolower($needle);
        }
    }

    static function instance($name = 'default')
    {
        if (isset(self::$instances[$name]))
        {
            return self::$instances[$name];
        }

        $instance = new static();

        self::$instances[$name] = $instance;

        return $instance;
    }

    private static $instances = array();

    #
    # Fields
    #

    protected $DefinitionData;

    #
    # Read-Only

    protected $specialCharacters = array(
        '\\', '`', '*', '_', '{', '}', '[', ']', '(', ')', '>', '#', '+', '-', '.', '!', '|', '~'
    );

    protected $StrongRegex = array(
        '*' => '/^[*]{2}((?:\\\\\*|[^*]|[*][^*]*+[*])+?)[*]{2}(?![*])/s',
        '_' => '/^__((?:\\\\_|[^_]|_[^_]*+_)+?)__(?!_)/us',
    );

    protected $EmRegex = array(
        '*' => '/^[*]((?:\\\\\*|[^*]|[*][*][^*]+?[*][*])+?)[*](?![*])/s',
        '_' => '/^_((?:\\\\_|[^_]|__[^_]*__)+?)_(?!_)\b/us',
    );

    protected $regexHtmlAttribute = '[a-zA-Z_:][\w:.-]*+(?:\s*+=\s*+(?:[^"\'=<>`\s]+|"[^"]*+"|\'[^\']*+\'))?+';

    protected $voidElements = array(
        'area', 'base', 'br', 'col', 'command', 'embed', 'hr', 'img', 'input', 'link', 'meta', 'param', 'source',
    );

    protected $textLevelElements = array(
        'a', 'br', 'bdo', 'abbr', 'blink', 'nextid', 'acronym', 'basefont',
        'b', 'em', 'big', 'cite', 'small', 'spacer', 'listing',
        'i', 'rp', 'del', 'code',          'strike', 'marquee',
        'q', 'rt', 'ins', 'font',          'strong',
        's', 'tt', 'kbd', 'mark',
        'u', 'xm', 'sub', 'nobr',
                   'sup', 'ruby',
                   'var', 'span',
                   'wbr', 'time',
    );
}

--- END FILE: C:\xampp\htdocs\files\PAUSE\libs\Parsedown.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\partials\_sidebar.php ---
<aside class="dashboard-sidebar">
    <h2>Verwaltung</h2>
    <nav class="dashboard-nav">
        <?php
        $currentUrl = $_SERVER['REQUEST_URI'];
        $userRole = $_SESSION['user_role'] ?? '';
        // NEU: Lade Einstellungen f√ºr die Sidebar
        $settings = \App\Core\Utils::getSettings();
        ?>

        <?php if (in_array($userRole, ['admin'])): ?>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/dashboard')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/dashboard') ? 'active' : ''); ?>">
                Dashboard √úbersicht
            </a>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/users')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/users') ? 'active' : ''); ?>">
                Benutzer verwalten
            </a>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/csv-template')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/csv-template') ? 'active' : ''); ?>">
                CSV Importvorlage
            </a>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/stammdaten')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/stammdaten') ? 'active' : ''); ?>">
                Stammdaten
            </a>
        <?php endif; ?>

        <?php if (in_array($userRole, ['admin', 'planer', 'lehrer'])): ?>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/announcements')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/announcements') ? 'active' : ''); ?>">
                Ank√ºndigungen
            </a>
        <?php endif; ?>
        
        <?php // NEU: Link nur anzeigen, wenn das Board in den Settings aktiviert ist ?>
        <?php if (in_array($userRole, ['admin', 'planer']) && $settings['community_board_enabled']): ?>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/community-moderation')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/community-moderation') ? 'active' : ''); ?>">
                Schwarzes Brett (Mod.)
            </a>
        <?php endif; ?>
        
        <?php if (in_array($userRole, ['admin'])): ?>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/audit-logs')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/audit-logs') ? 'active' : ''); ?>">
                Audit Log (Protokoll)
            </a>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/system-health')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/system-health') ? 'active' : ''); ?>">
                System-Status
            </a>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/settings')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'admin/settings') ? 'active' : ''); ?>">
                Einstellungen
            </a>
        <?php endif; ?>


         <?php if (in_array($userRole, ['planer'])): ?>
               <?php endif; ?>
    </nav>
</aside>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\partials\_sidebar.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\Announcements.php ---
<?php
// pages/admin/announcements.php
include_once dirname(__DIR__) . '/partials/header.php';

// Data ($allAnnouncements, $availableClasses, $userRole) is passed from AdminAnnouncementController->index()
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">Ank√ºndigungsverwaltung</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="announcements-management">
            <div class="dashboard-section active">
                <div class="form-container">
                    <h4 id="announcement-form-title">Neue Ank√ºndigung erstellen</h4>
                    <!-- KORRIGIERT: method="POST" hinzugef√ºgt -->
                    <form id="announcement-form" data-mode="create" method="POST" enctype="multipart/form-data">
                        <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                        <input type="hidden" name="announcement_id" id="announcement_id">

                        <div class="form-group">
                            <label for="title">Titel*</label>
                            <input type="text" name="title" id="title" required>
                        </div>

                        <div class="form-group">
                            <label for="content">Inhalt*</label>
                            <textarea name="content" id="content" rows="5" required></textarea>
                            <small class="form-hint">Sie k√∂nnen <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">Markdown</a> f√ºr die Formatierung verwenden (z.B. **fett**, *kursiv*, Listen).</small>
                        </div>

                        <?php if (in_array($userRole, ['admin', 'planer'])): ?>
                            <fieldset class="target-group-fieldset">
                                <legend>Zielgruppe ausw√§hlen*</legend>

                                <div class="form-group" id="target-class-container">
                                    <label for="target_class_id">Klassenspezifisch (nur Sch√ºler)</label>
                                    <select name="target_class_id" id="target_class_id">
                                        <option value="">-- Klasse w√§hlen --</option>
                                        <?php foreach ($availableClasses as $class): ?>
                                            <option value="<?php echo htmlspecialchars($class['class_id']); ?>">
                                                <?php echo htmlspecialchars($class['class_id'] . ' - ' . $class['class_name']); ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                    <small class="form-hint">ODER eine der folgenden Optionen w√§hlen:</small>
                                </div>


                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="target_global" id="target_global" value="1">
                                        Globale Ank√ºndigung (Alle Nutzer)
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="target_teacher" id="target_teacher" value="1">
                                        Nur f√ºr Lehrer
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="target_planer" id="target_planer" value="1">
                                        Nur f√ºr Planer
                                    </label>
                                </div>
                                <small class="form-hint error-hint" id="target-error" style="display: none; color: var(--color-danger); font-weight: bold;">Bitte eine Klasse ODER genau eine Checkbox ausw√§hlen.</small>

                            </fieldset>

                            <div class="form-group">
                                <label for="attachment">Anhang (optional, max 5MB)</label>
                                <input type="file" name="attachment" id="attachment">
                                <small class="form-hint">Erlaubte Typen: JPG, PNG, PDF, DOC, DOCX</small>
                                <div id="current-attachment-info" style="display: none; margin-top: 5px;">
                                    Aktueller Anhang: <a href="#" id="current-attachment-link" target="_blank"></a>
                                    <label style="margin-left: 10px;">
                                        <input type="checkbox" name="remove_attachment" id="remove_attachment" value="1"> Anhang entfernen
                                    </label>
                                </div>
                            </div>

                        <?php elseif ($userRole === 'lehrer'): ?>
                            <input type="hidden" name="target_role_fixed" value="schueler">
                            <div class="form-group">
                                <label for="target_class_id">Klasse*</label>
                                <select name="target_class_id" id="target_class_id" required>
                                    <option value="">Bitte w√§hlen...</option>
                                    <?php foreach ($availableClasses as $class): ?>
                                        <option value="<?php echo htmlspecialchars($class['class_id']); ?>">
                                            <?php echo htmlspecialchars($class['class_id'] . ' - ' . $class['class_name']); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                                <small>Sie k√∂nnen nur Ank√ºndigungen f√ºr Sch√ºler einer Klasse erstellen.</small>
                            </div>
                        <?php endif; ?>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancel-edit-announcement" style="display: none;">Abbrechen</button>
                            <button type="submit" class="btn btn-primary">Speichern</button>
                        </div>
                    </form>
                </div>

                <div class="table-container announcements-list">
                    <h3>Bestehende Ank√ºndigungen</h3>
                     <div id="announcements-table-container">
                         <?php if (empty($allAnnouncements)): ?>
                             <p>Keine Ank√ºndigungen vorhanden.</p>
                         <?php else: ?>
                             <table class="data-table" id="announcements-table">
                                 <thead>
                                     <tr>
                                         <th>Titel</th>
                                         <th>Autor</th>
                                         <th>Zielgruppe</th>
                                         <th>Datum</th>
                                         <th>Anhang</th>
                                         <th>Aktionen</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     <?php foreach ($allAnnouncements as $ann):
                                         $targetDisplay = '';
                                         if ($ann['is_global']) { $targetDisplay = 'Global'; }
                                         elseif ($ann['class_id']) { $targetDisplay = 'Klasse: ' . htmlspecialchars($ann['target_class_name'] ?? $ann['class_id']); }
                                         else { $targetDisplay = 'Unbekannt'; } // Fallback, sollte nicht vorkommen mit neuer Logik
                                     ?>
                                     <tr data-id="<?php echo $ann['announcement_id']; ?>"
                                         data-title="<?php echo htmlspecialchars($ann['title']); ?>"
                                         data-content="<?php echo htmlspecialchars($ann['content']); ?>"
                                         data-is-global="<?php echo $ann['is_global']; ?>"
                                         data-class-id="<?php echo htmlspecialchars($ann['class_id'] ?? ''); ?>"
                                         data-file-path="<?php echo htmlspecialchars($ann['file_path'] ?? ''); ?>"
                                         data-user-id="<?php echo $ann['user_id']; ?>">
                                         <td><?php echo htmlspecialchars($ann['title']); ?></td>
                                         <td><?php echo htmlspecialchars($ann['author_name'] ?? 'Unbekannt'); ?></td>
                                         <td><?php echo $targetDisplay; ?></td>
                                         <td><?php echo htmlspecialchars(date('d.m.Y H:i', strtotime($ann['created_at']))); ?></td>
                                          <td>
                                              <?php if (!empty($ann['file_url'])): ?>
                                                  <a href="<?php echo htmlspecialchars($ann['file_url']); ?>" target="_blank" title="<?php echo htmlspecialchars(basename($ann['file_path'] ?? 'Anhang')); ?>">
                                                      üìé Anhang
                                                  </a>
                                              <?php else: ?>
                                                  -
                                              <?php endif; ?>
                                          </td>
                                         <td class="actions">
                                             <?php
                                               // Bestimmt, ob der aktuelle Benutzer diesen Eintrag √§ndern/l√∂schen darf
                                               $canModify = in_array($userRole, ['admin', 'planer']) || ($userRole === 'lehrer' && $ann['user_id'] == $_SESSION['user_id']);
                                             ?>
                                             <?php if ($canModify): ?>
                                                 <!-- <button class="btn btn-warning btn-small edit-announcement">Bearbeiten</button> -->
                                                 <button class="btn btn-danger btn-small delete-announcement">L√∂schen</button>
                                             <?php endif; ?>
                                         </td>
                                     </tr>
                                     <?php endforeach; ?>
                                 </tbody>
                             </table>
                         <?php endif; ?>
                     </div>
                </div>
            </div>
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>

--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\Announcements.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\audit_logs.php ---
<?php
// pages/admin/audit_logs.php
include_once dirname(__DIR__) . '/partials/header.php';
// $availableUsers und $availableActions werden vom Controller √ºbergeben
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">Audit Log (Aktionsprotokoll)</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="audit-log-management">
            
            <!-- Sektion f√ºr Filter -->
            <div class.="dashboard-section" id="filter-section">
                 <div class="form-container" style="background-color: var(--color-surface-alt); margin-bottom: 20px;">
                    <form id="audit-filter-form" class="filter-form">
                        <div class="filter-grid">
                            <!-- Benutzerfilter -->
                            <div class="form-group">
                                <label for="filter-user">Benutzer</label>
                                <select name="user_id" id="filter-user">
                                    <option value="">Alle Benutzer</option>
                                    <?php foreach ($availableUsers as $user): ?>
                                        <option value="<?php echo $user['user_id']; ?>">
                                            <?php echo htmlspecialchars($user['last_name'] . ', ' . $user['first_name'] . ' (' . $user['username'] . ')'); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <!-- Aktionsfilter -->
                            <div class="form-group">
                                <label for="filter-action">Aktion</label>
                                <select name="action" id="filter-action">
                                    <option value="">Alle Aktionen</option>
                                     <?php foreach ($availableActions as $action): ?>
                                        <option value="<?php echo htmlspecialchars($action); ?>">
                                            <?php echo htmlspecialchars($action); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <!-- Datumsfilter (Von) -->
                            <div class="form-group">
                                <label for="filter-date-from">Von Datum</label>
                                <input type="date" name="date_from" id="filter-date-from">
                            </div>
                            <!-- Datumsfilter (Bis) -->
                            <div class="form-group">
                                <label for="filter-date-to">Bis Datum</label>
                                <input type="date" name="date_to" id="filter-date-to">
                            </div>
                        </div>
                        <div class="form-actions" style="margin-top: 10px;">
                            <button type="submit" class="btn btn-primary btn-small" style="width: 150px; margin-bottom: 0;">Filtern</button>
                            <button type="reset" class="btn btn-secondary btn-small" id="filter-reset-btn" style="width: 150px; margin-bottom: 0;">Zur√ºcksetzen</button>
                        </div>
                    </form>
                 </div>
            </div>

            <!-- Sektion f√ºr die Log-Tabelle -->
            <div class="dashboard-section active" id="log-list-section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Protokoll-Eintr√§ge</h3>
                    <div id="pagination-summary" class="pagination-summary" style="font-size: 0.9rem; color: var(--color-text-muted);"></div>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="data-table" id="audit-logs-table">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">Zeitstempel</th>
                                    <th style="width: 180px;">Benutzer</th>
                                    <th style="width: 130px;">Aktion</th>
                                    <th style_width="100px;">Ziel-Typ</th>
                                    <th style="width: 80px;">Ziel-ID</th>
                                    <th>Details</th>
                                    <th style="width: 110px;">IP-Adresse</th>
                                </tr>
                            </thead>
                            <tbody id="audit-logs-tbody">
                                <!-- Inhalt wird per JS geladen -->
                                <tr><td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner"></div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Paginierung -->
                <div class="pagination-controls" id="pagination-controls" style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <!-- Paginierung wird per JS erstellt -->
                </div>
            </div>
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>

--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\audit_logs.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\community_moderation.php ---
<?php
// pages/admin/community_moderation.php
include_once dirname(__DIR__) . '/partials/header.php';
// $pendingPosts und $approvedPosts werden vom CommunityController->index() √ºbergeben
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">Moderation Schwarzes Brett</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="community-moderation">

            <!-- NEU: Tab Navigation -->
            <nav class="tab-navigation">
                <button class="tab-button active" data-target="pending-section">
                    Ausstehend (<?php echo count($pendingPosts); ?>)
                </button>
                <button class="tab-button" data-target="approved-section">
                    Freigegeben (<?php echo count($approvedPosts); ?>)
                </button>
            </nav>

            <!-- NEU: Tab Content Wrapper -->
            <div class="tab-content">

                <!-- Tab 1: Ausstehende Beitr√§ge -->
                <div class="dashboard-section active" id="pending-section">
                    <h3>Ausstehende Beitr√§ge</h3>
                    <p>Diese Beitr√§ge wurden von Sch√ºlern erstellt und warten auf Freigabe.</p>
                    
                    <div id="pending-posts-list" class="posts-list-container">
                        <?php if (empty($pendingPosts)): ?>
                            <p class="message info">Aktuell gibt es keine Beitr√§ge, die moderiert werden m√ºssen.</p>
                        <?php else: ?>
                            <?php foreach ($pendingPosts as $post): ?>
                                <div class="community-post-item moderation-item" data-id="<?php echo $post['post_id']; ?>">
                                    <div class="post-header">
                                        <strong class="post-title"><?php echo htmlspecialchars($post['title']); ?></strong>
                                        <span class="post-meta">
                                            Von: <?php echo htmlspecialchars($post['first_name'] . ' ' . $post['last_name']); ?> (@<?php echo htmlspecialchars($post['username']); ?>)
                                            <br>
                                            Am: <?php echo date('d.m.Y H:i', strtotime($post['created_at'])); ?>
                                        </span>
                                    </div>
                                    <div class="post-content-preview">
                                        <?php echo $post['content_html']; // HTML aus Parsedown (als "safe" markiert) ?>
                                    </div>
                                    <div class="moderation-actions">
                                        <button class="btn btn-success btn-small approve-post-btn" data-id="<?php echo $post['post_id']; ?>">Freigeben</button>
                                        <button class="btn btn-danger btn-small reject-post-btn" data-id="<?php echo $post['post_id']; ?>">Ablehnen & L√∂schen</button>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </div>
                </div> <!-- Ende #pending-section -->
                
                <!-- Tab 2: Freigegebene Beitr√§ge -->
                <div class="dashboard-section" id="approved-section">
                    <h3>Freigegebene Beitr√§ge</h3>
                    <p>Dies sind alle aktuell sichtbaren Beitr√§ge auf dem Schwarzen Brett. Sie k√∂nnen hier bereits freigegebene Beitr√§ge wieder l√∂schen.</p>
                    
                    <div id="approved-posts-list" class="posts-list-container">
                        <?php if (empty($approvedPosts)): ?>
                            <p class="message info">Aktuell sind keine Beitr√§ge freigegeben.</p>
                        <?php else: ?>
                            <?php foreach ($approvedPosts as $post): ?>
                                <div class="community-post-item moderation-item" data-id="<?php echo $post['post_id']; ?>">
                                    <div class="post-header">
                                        <strong class="post-title"><?php echo htmlspecialchars($post['title']); ?></strong>
                                        <span class="post-meta">
                                            Von: <?php echo htmlspecialchars($post['first_name'] . ' ' . $post['last_name']); ?> (@<?php echo htmlspecialchars($post['username']); ?>)
                                            <br>
                                            Am: <?php echo date('d.m.Y H:i', strtotime($post['created_at'])); ?>
                                            <?php if ($post['moderator_id']): // Zeige Moderationsdatum, falls vorhanden ?>
                                                <br><i>Freigegeben am: <?php echo date('d.m.Y H:i', strtotime($post['moderated_at'])); ?></i>
                                            <?php endif; ?>
                                        </span>
                                    </div>
                                    <div class="post-content-preview">
                                        <?php echo $post['content_html']; // HTML aus Parsedown ?>
                                    </div>
                                    <div class="moderation-actions">
                                        <button class="btn btn-danger btn-small delete-approved-btn" data-id="<?php echo $post['post_id']; ?>">Endg√ºltig L√∂schen</button>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </div>
                </div> <!-- Ende #approved-section -->

            </div> <!-- Ende .tab-content -->
            
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>


--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\community_moderation.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\csv_template.php ---
<?php
// pages/admin/csv_template.php
include_once dirname(__DIR__) . '/partials/header.php';
// $templateData wird vom CsvTemplateController √ºbergeben
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">CSV-Importvorlage (Benutzer)</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="csv-template-view">
            <div class="dashboard-section active">
                <div class="section-header">
                    <h3>Vorschau der Vorlagenstruktur</h3>
                    <a href="<?php echo htmlspecialchars(rtrim($config['base_url'], '/')); ?>/assets/templates/user_import_template.csv" download="user_import_template.csv" class="btn btn-primary" style="width: auto; margin-bottom: 0;">
                        Vorlage herunterladen
                    </a>
                </div>
                
                <p>Die CSV-Datei muss exakt diese Spalten in dieser Reihenfolge enthalten. Die erste Zeile muss die Header-Zeile sein. Die Zeilen 2 und 3 sind Beispiele.</p>

                <?php if (isset($templateData['error'])): ?>
                    <p class="message error"><?php echo htmlspecialchars($templateData['error']); ?></p>
                <?php elseif (!empty($templateData['headers'])): ?>
                    <div class="table-container" style="margin-top: 20px;">
                        <div class="table-responsive">
                            <table class="data-table csv-preview-table">
                                <thead>
                                    <tr>
                                        <?php foreach ($templateData['headers'] as $header): ?>
                                            <th><?php echo htmlspecialchars($header); ?></th>
                                        <?php endforeach; ?>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($templateData['rows'] as $row): ?>
                                        <tr>
                                            <?php foreach ($row as $cell): ?>
                                                <td><?php echo htmlspecialchars($cell); ?></td>
                                            <?php endforeach; ?>
                                        </tr>
                                    <?php endforeach; ?>
                                    <?php if (empty($templateData['rows'])): ?>
                                        <tr>
                                            <td colspan="<?php echo count($templateData['headers']); ?>"><i>Die Vorlagendatei enth√§lt keine Beispielzeilen.</i></td>
                                        </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                <?php else: ?>
                     <p class="message error">Die Vorlagendatei ist leer oder konnte nicht korrekt gelesen werden.</p>
                <?php endif; ?>

            </div>
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>

--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\csv_template.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\dashboard.php ---
<?php
// pages/admin/dashboard.php
include_once dirname(__DIR__) . '/partials/header.php';
// $dashboardData wird vom Controller √ºbergeben
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">Admin Dashboard</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="admin-dashboard-overview">

            <?php if (isset($dashboardData['error'])): ?>
                <div class="message error"><?php echo htmlspecialchars($dashboardData['error']); ?></div>
            <?php endif; ?>

            <div class="dashboard-widget-grid" id="dashboard-widget-grid">

                <div class="dashboard-widget widget-stats" draggable="true" id="widget-stats">
                    <h3>üìä System√ºbersicht</h3>
                    
                    <div class="stat-grid">
                        <div class="stat-item main-stat">
                            <span class="stat-value"><?php echo $dashboardData['totalUsers'] ?? 0; ?></span>
                            <span class="stat-label">Benutzer gesamt</span>
                        </div>
                        <div class="stat-item sub-stat">
                            <span class="stat-value"><?php echo $dashboardData['userCounts']['schueler'] ?? 0; ?></span>
                            <span class="stat-label">Sch√ºler</span>
                        </div>
                        <div class="stat-item sub-stat">
                            <span class="stat-value"><?php echo $dashboardData['userCounts']['lehrer'] ?? 0; ?></span>
                            <span class="stat-label">Lehrer</span>
                        </div>
                        <div class="stat-item sub-stat">
                            <span class="stat-value"><?php echo $dashboardData['userCounts']['planer'] ?? 0; ?></span>
                            <span class="stat-label">Planer</span>
                        </div>
                        <div class="stat-item sub-stat">
                            <span class="stat-value"><?php echo $dashboardData['userCounts']['admin'] ?? 0; ?></span>
                            <span class="stat-label">Admins</span>
                        </div>
                    </div>
                    <hr class="stat-divider">
                    <div class="stat-grid bottom-grid">
                        <div class="stat-item">
                            <span class="stat-value"><?php echo $dashboardData['classCount'] ?? 0; ?></span>
                            <span class="stat-label">Klassen</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value"><?php echo $dashboardData['teacherCount'] ?? 0; ?></span>
                            <span class="stat-label">Lehrerprofile</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value"><?php echo $dashboardData['subjectCount'] ?? 0; ?></span>
                            <span class="stat-label">F√§cher</span>
                        </div>
                         <div class="stat-item">
                            <span class="stat-value"><?php echo $dashboardData['roomCount'] ?? 0; ?></span>
                            <span class="stat-label">R√§ume</span>
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget widget-maintenance" draggable="true" id="widget-maintenance">
                    <h3>üîß Wartungsmodus</h3>
                    <div class="setting-control" style="justify-content: space-between;">
                        <label class="toggle-switch">
                            <input type="checkbox"
                                   id="dashboard_maintenance_mode"
                                   name="maintenance_mode"
                                   value="1"
                                   <?php echo($dashboardData['settings']['maintenance_mode'] ? 'checked' : ''); ?>
                                   data-csrf-token="<?php echo htmlspecialchars(\App\Core\Security::getCsrfToken()); ?>"> <?php /* CSRF f√ºr JS */ ?>
                            <span class="slider round"></span>
                        </label>
                        <span id="dashboard-maintenance-status" class="toggle-status" style="font-weight: bold;">
                             <?php echo($dashboardData['settings']['maintenance_mode'] ? 'Aktiviert' : 'Deaktiviert'); ?>
                        </span>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--color-text-muted); margin-top: 10px;">
                        Schaltet den Zugang f√ºr Sch√ºler und Lehrer an/aus.
                        <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/settings')); ?>" style="font-size: inherit;">Nachricht/Whitelist anpassen</a>
                    </p>
                    <span id="maintenance-toggle-spinner" class="loading-spinner small" style="display: none; margin-left: 15px;"></span>
                </div>

                <div class="dashboard-widget widget-publish-status" draggable="true" id="widget-publish-status">
                    <h3>üöÄ Ver√∂ffentlichungsstatus</h3>
                    <div class="publish-status-group">
                        <strong>Aktuelle Woche (KW <?php echo htmlspecialchars($dashboardData['publishStatus']['currentWeekNum'] ?? '-'); ?>):</strong>
                        <div class="status-indicators">
                            <span class="status-indicator <?php echo($dashboardData['publishStatus']['current']['student'] ?? false) ? 'published' : 'not-published'; ?>">
                                Sch√ºler
                            </span>
                            <span class="status-indicator <?php echo($dashboardData['publishStatus']['current']['teacher'] ?? false) ? 'published' : 'not-published'; ?>">
                                Lehrer
                            </span>
                        </div>
                    </div>
                    <div class="publish-status-group">
                        <strong>N√§chste Woche (KW <?php echo htmlspecialchars($dashboardData['publishStatus']['nextWeekNum'] ?? '-'); ?>):</strong>
                        <div class="status-indicators">
                            <span class="status-indicator <?php echo($dashboardData['publishStatus']['next']['student'] ?? false) ? 'published' : 'not-published'; ?>">
                                Sch√ºler
                            </span>
                            <span class="status-indicator <?php echo($dashboardData['publishStatus']['next']['teacher'] ?? false) ? 'published' : 'not-published'; ?>">
                                Lehrer
                            </span>
                        </div>
                    </div>
                    <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('planer/dashboard')); ?>" class="widget-link">Jetzt verwalten &raquo;</a>
                </div>

                <div class="dashboard-widget widget-activity" draggable="true" id="widget-activity">
                    <h3>üïí Letzte Aktivit√§ten</h3>
                    <?php if (!empty($dashboardData['latestLogs'])): ?>
                        <ul class="activity-list">
                            <?php foreach ($dashboardData['latestLogs'] as $log): ?>
                                <li>
                                    <span class="log-time"><?php echo date('d.m. H:i', strtotime($log['timestamp'])); ?>:</span>
                                    <span class="log-user"><?php echo htmlspecialchars($log['username'] ?? 'System'); ?></span>
                                    <span class="log-action"><?php echo htmlspecialchars($log['action']); ?></span>
                                    <?php if ($log['target_type'] || $log['target_id']): ?>
                                        <span class="log-target">(<?php echo htmlspecialchars($log['target_type'] ?? ''); ?> <?php echo htmlspecialchars($log['target_id'] ?? ''); ?>)</span>
                                    <?php endif; ?>
                                </li>
                            <?php endforeach; ?>
                        </ul>
                    <?php else: ?>
                        <p style="margin-bottom: 15px;">Keine Protokolleintr√§ge vorhanden.</p>
                    <?php endif; ?>
                     <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/audit-logs')); ?>" class="widget-link">Vollst√§ndiges Log anzeigen &raquo;</a>
                </div>

                 <div class="dashboard-widget widget-quicklinks" draggable="true" id="widget-quicklinks">
                    <h3>üöÄ Schnellzugriffe</h3>
                    <div class="quicklink-buttons">
                         <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/users')); ?>" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15 14s1 0 1-1-1-4-6-4-6 3-6 4 1 1 1 1zM11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 9a5 5 0 0 0-5 5v1h10v-1a5 5 0 0 0-5-5"/></svg>
                            Benutzer
                         </a>
                         <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/stammdaten')); ?>" class="btn btn-secondary">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>
                            Stammdaten
                        </a>
                         <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('planer/dashboard')); ?>" class="btn btn-secondary">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/></svg>
                            Planer
                        </a>
                         <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/settings')); ?>" class="btn btn-secondary">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                            Einstellungen
                        </a>
                    </div>
                </div>

                <div class="dashboard-widget widget-system-status" draggable="true" id="widget-system-status">
                    <h3>‚úÖ System-Status</h3>
                    <ul class="system-check-list">
                        <?php if (empty($dashboardData['systemChecks'])): ?>
                            <li>Status-Checks konnten nicht geladen werden.</li>
                        <?php else: ?>
                            <?php foreach ($dashboardData['systemChecks'] as $check): ?>
                                <li class="<?php echo $check['status'] ? 'status-ok' : 'status-fail'; ?>"
                                    title="<?php echo htmlspecialchars($check['tooltip'] ?? $check['label']); ?>">
                                    <div class="status-info">
                                        <span class="status-icon"><?php echo $check['status'] ? '‚úî' : '‚ùå'; ?></span>
                                        <span class="status-label"><?php echo htmlspecialchars($check['label']); ?>:</span>
                                    </div>
                                    <span class="status-message"><?php echo htmlspecialchars($check['message']); ?></span>
                                </li>
                            <?php endforeach; ?>
                        <?php endif; ?>
                    </ul>
                     <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 10px; margin-bottom: 0;">
                        Basale √úberpr√ºfung der Systemkomponenten.
                    </p>
                    <div class="widget-action-footer">
                         <button class="btn btn-warning btn-small" id="clear-cache-btn" data-csrf-token="<?php echo htmlspecialchars(\App\Core\Security::getCsrfToken()); ?>">
                            Einstellungen-Cache leeren
                         </button>
                         <span id="cache-clear-spinner" class="loading-spinner small" style="display: none;"></span>
                    </div>
                </div>


                <div class="dashboard-widget widget-system-info" draggable="true" id="widget-system-info">
                    <h3>üñ•Ô∏è System-Info</h3>
                    <div class="system-info-list">
                        <div class="info-item">
                            <span class="info-label">PHP-Version</span>
                            <span class="info-value"><?php echo htmlspecialchars($dashboardData['systemInfo']['php'] ?? 'N/A'); ?></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">DB-Version</span>
                            <span class="info-value"><?php echo htmlspecialchars($dashboardData['systemInfo']['db'] ?? 'N/A'); ?></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Webserver</span>
                            <span class="info-value"><?php echo htmlspecialchars($dashboardData['systemInfo']['webserver'] ?? 'N/A'); ?></span>
                        </div>
                    </div>
                </div>


            </div> </main>
    </div>
</div>

<?php
// F√ºge spezifisches JS f√ºr das Dashboard hinzu (f√ºr Wartungsmodus-Schalter)
// Der Rest wird √ºber main.js gesteuert
?>
<script type="module">
    import { apiFetch } from '<?php echo htmlspecialchars(rtrim($config['base_url'], '/')); ?>/assets/js/api-client.js';
    import { showToast } from '<?php echo htmlspecialchars(rtrim($config['base_url'], '/')); ?>/assets/js/notifications.js';

    // --- Wartungsmodus-Schalter ---
    const maintenanceToggle = document.getElementById('dashboard_maintenance_mode');
    const maintenanceStatus = document.getElementById('dashboard-maintenance-status');
    const maintenanceSpinner = document.getElementById('maintenance-toggle-spinner');

    if (maintenanceToggle && maintenanceStatus) {
        // ... (Wartungsmodus-Logik bleibt unver√§ndert) ...
        maintenanceToggle.addEventListener('change', async () => {
            const isChecked = maintenanceToggle.checked;
            const csrfToken = maintenanceToggle.dataset.csrfToken;

            if (maintenanceSpinner) maintenanceSpinner.style.display = 'inline-block';
            maintenanceToggle.disabled = true;

            const formData = new FormData();
            formData.append('maintenance_mode', isChecked ? '1' : '0');
            formData.append('_csrf_token', csrfToken);
            
            formData.append('site_title', <?php echo json_encode($dashboardData['settings']['site_title'] ?? ''); ?>);
            formData.append('maintenance_message', <?php echo json_encode($dashboardData['settings']['maintenance_message'] ?? ''); ?>);
            formData.append('maintenance_whitelist_ips', <?php echo json_encode($dashboardData['settings']['maintenance_whitelist_ips'] ?? ''); ?>);
            formData.append('default_start_hour', <?php echo json_encode($dashboardData['settings']['default_start_hour'] ?? '1'); ?>);
            formData.append('default_end_hour', <?php echo json_encode($dashboardData['settings']['default_end_hour'] ?? '10'); ?>);
            formData.append('max_login_attempts', <?php echo json_encode($dashboardData['settings']['max_login_attempts'] ?? '5'); ?>);
            formData.append('lockout_minutes', <?php echo json_encode($dashboardData['settings']['lockout_minutes'] ?? '15'); ?>);
            formData.append('default_theme', <?php echo json_encode($dashboardData['settings']['default_theme'] ?? 'light'); ?>);
            formData.append('ical_enabled', '<?php echo $dashboardData['settings']['ical_enabled'] ? '1' : '0'; ?>');
            formData.append('ical_weeks_future', '<?php echo htmlspecialchars($dashboardData['settings']['ical_weeks_future'] ?? '8'); ?>');
            formData.append('pdf_footer_text', <?php echo json_encode($dashboardData['settings']['pdf_footer_text'] ?? ''); ?>);

            try {
                const response = await apiFetch('<?php echo htmlspecialchars(\App\Core\Utils::url('api/admin/settings/save')); ?>', {
                    method: 'POST',
                    body: formData
                });

                if (response.success) {
                    maintenanceStatus.textContent = isChecked ? 'Aktiviert' : 'Deaktiviert';
                    maintenanceStatus.style.color = isChecked ? 'var(--color-success)' : 'var(--color-text-muted)';
                    showToast(`Wartungsmodus ${isChecked ? 'aktiviert' : 'deaktiviert'}.`, 'success');
                    const newToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    if (newToken) maintenanceToggle.dataset.csrfToken = newToken;
                } else {
                    maintenanceToggle.checked = !isChecked;
                }
            } catch (error) {
                 maintenanceToggle.checked = !isChecked;
            } finally {
                if (maintenanceSpinner) maintenanceSpinner.style.display = 'none';
                maintenanceToggle.disabled = false;
            }
        });
    }

    // --- NEU: Cache leeren Button ---
    const clearCacheBtn = document.getElementById('clear-cache-btn');
    const cacheSpinner = document.getElementById('cache-clear-spinner');

    if (clearCacheBtn && cacheSpinner) {
        // ... (Cache-Logik bleibt unver√§ndert) ...
        clearCacheBtn.addEventListener('click', async () => {
            const csrfToken = clearCacheBtn.dataset.csrfToken;
            
            clearCacheBtn.disabled = true;
            cacheSpinner.style.display = 'inline-block';

            try {
                const response = await apiFetch('<?php echo htmlspecialchars(\App\Core\Utils::url('api/admin/cache/clear')); ?>', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken 
                    }
                });

                if (response.success) {
                    showToast(response.message, 'success');
                    const newToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    if (newToken) {
                         clearCacheBtn.dataset.csrfToken = newToken;
                         if (maintenanceToggle) maintenanceToggle.dataset.csrfToken = newToken;
                    }
                }
            } catch (error) {
                // Fehler
            } finally {
                clearCacheBtn.disabled = false;
                cacheSpinner.style.display = 'none';
            }
        });
    }

    // --- KORRIGIERT: Drag-and-Drop f√ºr Widgets (mit Speicherung) ---
    const grid = document.getElementById('dashboard-widget-grid');
    let draggedItem = null;
    let placeholder = null;
    const WIDGET_ORDER_KEY = 'dashboardWidgetOrder';

    /**
     * L√§dt und wendet die gespeicherte Widget-Reihenfolge an.
     */
    function loadWidgetOrder() {
        const savedOrder = localStorage.getItem(WIDGET_ORDER_KEY);
        if (savedOrder && grid) {
            try {
                const order = JSON.parse(savedOrder);
                // Gehe durch die gespeicherte Reihenfolge und f√ºge die Elemente nacheinander an
                order.forEach(id => {
                    const widget = document.getElementById(id);
                    if (widget) {
                        grid.appendChild(widget);
                    }
                });
            } catch (e) {
                console.error("Fehler beim Laden der Widget-Reihenfolge:", e);
                localStorage.removeItem(WIDGET_ORDER_KEY);
            }
        }
    }

    /**
     * Speichert die aktuelle Widget-Reihenfolge im localStorage.
     */
    function saveWidgetOrder() {
        if (!grid) return;
        const widgets = grid.querySelectorAll('.dashboard-widget');
        const order = Array.from(widgets).map(widget => widget.id);
        localStorage.setItem(WIDGET_ORDER_KEY, JSON.stringify(order));
    }
    
    /**
     * Erstellt den visuellen Platzhalter.
     */
    function createPlaceholder() {
        if (!placeholder) {
            placeholder = document.createElement('div');
            placeholder.className = 'widget-placeholder';
            if (draggedItem) {
                // Setze H√∂he UND Breite des Platzhalters auf die des gezogenen Elements
                const rect = draggedItem.getBoundingClientRect();
                placeholder.style.height = `${rect.height}px`;
                // Wichtig: Auch die Breite setzen, um das Grid-Layout zu stabilisieren
                placeholder.style.width = `${rect.width}px`; 
            }
        }
        return placeholder;
    }
    
    /**
     * Entfernt den Platzhalter aus dem DOM.
     */
    function removePlaceholder() {
        if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
        }
        placeholder = null;
    }

    /**
     * Findet das Element, vor dem das gezogene Element eingef√ºgt werden soll.
     * Diese Logik funktioniert f√ºr Grids, die sich horizontal und vertikal f√ºllen.
     */
    function getDragAfterElement(container, clientX, clientY) {
        const draggableElements = [...container.querySelectorAll('.dashboard-widget:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            
            // Berechne die Distanz zum Mittelpunkt des Elements
            const midX = box.left + box.width / 2;
            const midY = box.top + box.height / 2;
            
            // Wir gewichten die Y-Distanz st√§rker, aber ber√ºcksichtigen X
            // Einfachere Logik: Finde das Element, dessen *Mitte* der Maus am n√§chsten ist.
            const distance = Math.sqrt(Math.pow(clientX - midX, 2) + Math.pow(clientY - midY, 2));

            if (distance < (closest.distance || Number.POSITIVE_INFINITY)) {
                return { distance: distance, element: child };
            } else {
                return closest;
            }
        }, { distance: Number.POSITIVE_INFINITY, element: null }).element;
    }


    if (grid) {
        // 1. Gespeicherte Reihenfolge beim Laden anwenden
        loadWidgetOrder();

        grid.addEventListener('dragstart', (e) => {
            // Nur Widgets sollen ziehbar sein
            if (e.target.classList.contains('dashboard-widget')) {
                draggedItem = e.target;
                
                setTimeout(() => {
                    if (draggedItem) {
                        draggedItem.classList.add('dragging');
                    }
                }, 0);
                
                // Erstelle Platzhalter sofort, um die Gr√∂√üe zu fixieren
                placeholder = createPlaceholder();
            } else {
                e.preventDefault();
            }
        });

        grid.addEventListener('dragend', (e) => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            draggedItem = null;
            removePlaceholder();
        });

        grid.addEventListener('dragover', (e) => {
            e.preventDefault(); // Notwendig, um 'drop' zu erlauben
            if (!draggedItem) return;

            // Finde das Element, √ºber dem wir schweben
            const target = e.target.closest('.dashboard-widget');
            
            if (target && target !== draggedItem && target !== placeholder) {
                const rect = target.getBoundingClientRect();
                
                // KORRIGIERTE LOGIK: Pr√ºfe X- und Y-Position
                // Bessere Logik: Finde das *n√§chste* Element, nicht nur das, √ºber dem wir schweben
                const closestElement = getDragAfterElement(grid, e.clientX, e.clientY);

                if (closestElement) {
                     const closestRect = closestElement.getBoundingClientRect();
                     // Entscheide basierend auf der Mausposition relativ zur Mitte des *n√§chsten* Elements
                     const midX = closestRect.left + closestRect.width / 2;
                     const midY = closestRect.top + closestRect.height / 2;

                     // Priorisiere die Grid-Reihenfolge (links/rechts VOR oben/unten)
                    if (e.clientY >= closestRect.top && e.clientY <= closestRect.bottom) {
                        // Wir sind in derselben "visuellen" Zeile
                         if (e.clientX < midX) {
                            grid.insertBefore(placeholder, closestElement);
                         } else {
                            grid.insertBefore(placeholder, closestElement.nextSibling);
                         }
                    } else if (e.clientY < midY) {
                         // Wir sind √ºber dem Element
                         grid.insertBefore(placeholder, closestElement);
                    } else {
                        // Wir sind unter dem Element
                         grid.insertBefore(placeholder, closestElement.nextSibling);
                    }

                } else if (!grid.contains(placeholder)) {
                    // Wenn kein Element gefunden wird (Grid ist leer oder wir sind am Ende),
                    // h√§nge den Platzhalter am Ende an.
                    grid.appendChild(placeholder);
                }

            } else if (!target && grid === e.target && !grid.contains(placeholder)) {
                 // Wenn wir √ºber dem Grid-Container selbst (einer L√ºcke) schweben,
                 // f√ºge den Platzhalter am Ende an
                 grid.appendChild(placeholder);
            }
        });


        grid.addEventListener('drop', (e) => {
            e.preventDefault();
            if (!draggedItem || !placeholder || !placeholder.parentNode) {
                removePlaceholder();
                if(draggedItem) draggedItem.classList.remove('dragging');
                draggedItem = null;
                return;
            }

            // Ersetze den Platzhalter durch das gezogene Element
            placeholder.parentNode.insertBefore(draggedItem, placeholder);
            
            // Aufr√§umen
            removePlaceholder();
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            draggedItem = null;

            // NEU: Anordnung speichern
            saveWidgetOrder();
        });
    }

</script>


<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\dashboard.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\settings.php ---
<?php
// pages/admin/settings.php
include_once dirname(__DIR__) . '/partials/header.php';
// $currentSettings (Array) wird vom SettingsController::index() √ºbergeben
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">Anwendungs-Einstellungen</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="settings-management">
            <div class="dashboard-section active">
                
                <form id="settings-form" data-mode="update" method="POST" enctype="multipart/form-data">
                    <?php \App\Core\Security::csrfInput(); // CSRF-Token ?>

                    <div class="form-container settings-section">
                        <h3>Allgemein</h3>
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="site_title">Seitentitel</label>
                                <p>Der Name der Anwendung, der im Header und im Browser-Tab angezeigt wird.</p>
                            </div>
                            <div class="setting-control">
                                <input type="text"
                                       id="site_title"
                                       name="site_title"
                                       value="<?php echo htmlspecialchars($currentSettings['site_title'] ?? 'PAUSE Portal'); ?>"
                                       required>
                            </div>
                        </div>
                    </div>

                    <div class="form-container settings-section" style="margin-top: 25px;">
                        <h3>Branding &amp; Design</h3>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="site_logo">Logo (Header)</label>
                                <p>Optional. Wird statt dem Seitentitel im Header angezeigt. Empfohlene H√∂he: 40px. (PNG, JPG, SVG, GIF)</p>
                            </div>
                            <div class="setting-control file-upload-control">
                                <input type="file" id="site_logo" name="site_logo" accept="image/png,image/jpeg,image/svg+xml,image/gif">
                                <div class="file-preview" id="logo-preview-container">
                                    <?php if (!empty($currentSettings['site_logo_path'])): ?>
                                        <img src="<?php echo htmlspecialchars(\App\Core\Utils::url($currentSettings['site_logo_path'])); ?>?t=<?php echo time(); ?>" alt="Logo Vorschau" class="logo-preview">
                                        <label class="remove-file-label">
                                            <input type="checkbox" name="remove_site_logo" value="1"> Logo entfernen
                                        </label>
                                    <?php else: ?>
                                        <span class="no-file">Kein Logo festgelegt.</span>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="site_favicon">Favicon</label>
                                <p>Optional. Das Icon, das im Browser-Tab angezeigt wird. (ICO, PNG, SVG)</p>
                            </div>
                            <div class="setting-control file-upload-control">
                                <input type="file" id="site_favicon" name="site_favicon" accept="image/x-icon,image/png,image/svg+xml">
                                <div class="file-preview" id="favicon-preview-container">
                                    <?php if (!empty($currentSettings['site_favicon_path'])): ?>
                                        <img src="<?php echo htmlspecialchars(\App\Core\Utils::url($currentSettings['site_favicon_path'])); ?>?t=<?php echo time(); ?>" alt="Favicon Vorschau" class="favicon-preview">
                                        <label class="remove-file-label">
                                            <input type="checkbox" name="remove_site_favicon" value="1"> Favicon entfernen
                                        </label>
                                    <?php else: ?>
                                        <span class="no-file">Kein Favicon festgelegt.</span>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="default_theme">Standard-Theme</label>
                                <p>Das Farbschema, das f√ºr G√§ste und neue Benutzer standardm√§√üig geladen wird.</p>
                            </div>
                            <div class="setting-control">
                                <select id="default_theme" name="default_theme" style="max-width: 250px;">
                                    <option value="light" <?php echo ($currentSettings['default_theme'] === 'light') ? 'selected' : ''; ?>>
                                        Hell (Light Mode)
                                    </option>
                                    <option value="dark" <?php echo ($currentSettings['default_theme'] === 'dark') ? 'selected' : ''; ?>>
                                        Dunkel (Dark Mode)
                                    </option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <div class="form-container settings-section" style="margin-top: 25px;">
                        <h3>System &amp; Sicherheit</h3>
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="maintenance_mode">Wartungsmodus</label>
                                <p>Wenn aktiv, k√∂nnen sich nur noch Admins und Planer anmelden. Alle anderen Benutzer sehen eine Wartungsseite.</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox"
                                           id="maintenance_mode"
                                           name="maintenance_mode"
                                           value="1"
                                           <?php echo($currentSettings['maintenance_mode'] ? 'checked' : ''); ?>>
                                    <span class="slider round"></span>
                                </label>
                                <span id="maintenance-status" class="toggle-status">
                                    <?php echo($currentSettings['maintenance_mode'] ? 'Aktiviert' : 'Deaktiviert'); ?>
                                </span>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="maintenance_message">Wartungsmeldung</label>
                                <p>Diese Nachricht wird angezeigt, wenn der Wartungsmodus aktiv ist.</p>
                            </div>
                            <div class="setting-control" style="align-items: flex-start;">
                                <textarea id="maintenance_message"
                                          name="maintenance_message"
                                          rows="3"
                                          style="min-height: 80px; width: 100%; max-width: 450px;"
                                          placeholder="Die Anwendung wird gerade gewartet..."><?php echo htmlspecialchars($currentSettings['maintenance_message'] ?? ''); ?></textarea>
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="maintenance_whitelist_ips">IP-Whitelist (Wartungsmodus)</label>
                                <p>Diese IP-Adressen k√∂nnen die Seite auch im Wartungsmodus sehen. Trennen Sie IPs durch ein Komma (,).</p>
                            </div>
                            <div class="setting-control" style="align-items: flex-start;">
                                <textarea id="maintenance_whitelist_ips"
                                          name="maintenance_whitelist_ips"
                                          rows="3"
                                          style="min-height: 80px; width: 100%; max-width: 450px;"
                                          placeholder="127.0.0.1, ::1, 192.168.1.100"><?php echo htmlspecialchars($currentSettings['maintenance_whitelist_ips'] ?? ''); ?></textarea>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <label>Login-Sperre</label>
                                <p>Konfiguriert den Schutz vor Brute-Force-Angriffen beim Login.</p>
                            </div>
                            <div class="setting-control" style="display: flex; gap: 15px;">
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="max_login_attempts" style="font-weight: normal; font-size: 0.9rem;">Max. Fehlversuche</label>
                                    <input type="number"
                                           id="max_login_attempts"
                                           name="max_login_attempts"
                                           min="1" max="100"
                                           value="<?php echo htmlspecialchars($currentSettings['max_login_attempts'] ?? '5'); ?>"
                                           required>
                                    <small class="form-hint">Bevor der Account gesperrt wird.</small>
                                </div>
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="lockout_minutes" style="font-weight: normal; font-size: 0.9rem;">Sperrdauer (Minuten)</label>
                                    <input type="number"
                                           id="lockout_minutes"
                                           name="lockout_minutes"
                                           min="1" max="1440"
                                           value="<?php echo htmlspecialchars($currentSettings['lockout_minutes'] ?? '15'); ?>"
                                           required>
                                    <small class="form-hint">Wie lange der Account gesperrt bleibt.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-container settings-section" style="margin-top: 25px;">
                        <h3>Planer &amp; Module</h3>
                        <div class="setting-row">
                            <div class="setting-info">
                                <label>Standard-Stundenraster</label>
                                <p>Legt die Anzahl der Stunden fest, die im Planer standardm√§√üig angezeigt werden (z.B. 1-10).</p>
                            </div>
                            <div class="setting-control" style="display: flex; gap: 15px;">
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="default_start_hour" style="font-weight: normal; font-size: 0.9rem;">Erste Stunde</label>
                                    <input type="number"
                                           id="default_start_hour"
                                           name="default_start_hour"
                                           min="1" max="12"
                                           value="<?php echo htmlspecialchars($currentSettings['default_start_hour'] ?? '1'); ?>"
                                           required>
                                </div>
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="default_end_hour" style="font-weight: normal; font-size: 0.9rem;">Letzte Stunde</label>
                                    <input type="number"
                                           id="default_end_hour"
                                           name="default_end_hour"
                                           min="1" max="12"
                                           value="<?php echo htmlspecialchars($currentSettings['default_end_hour'] ?? '10'); ?>"
                                           required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="ical_enabled">iCal Kalender-Feeds</label>
                                <p>Erlaubt Benutzern (Sch√ºlern/Lehrern), ihren pers√∂nlichen Stundenplan als iCal-Feed zu abonnieren.</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox"
                                           id="ical_enabled"
                                           name="ical_enabled"
                                           value="1"
                                           <?php echo($currentSettings['ical_enabled'] ? 'checked' : ''); ?>>
                                    <span class="slider round"></span>
                                </label>
                                <span id="ical-status" class="toggle-status">
                                    <?php echo($currentSettings['ical_enabled'] ? 'Aktiviert' : 'Deaktiviert'); ?>
                                </span>
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="ical_weeks_future">iCal-Zeitraum (Zukunft)</label>
                                <p>Anzahl der Wochen, die der iCal-Feed in die Zukunft exportieren soll (Standard: 8).</p>
                            </div>
                            <div class="setting-control">
                                <div class="form-group" style="flex-basis: 150px; margin-bottom: 0;">
                                    <input type="number"
                                           id="ical_weeks_future"
                                           name="ical_weeks_future"
                                           min="1" max="52"
                                           value="<?php echo htmlspecialchars($currentSettings['ical_weeks_future'] ?? '8'); ?>"
                                           required>
                                     <small class="form-hint">Wochen (1-52)</small>
                                </div>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="pdf_footer_text">PDF Export Footer-Text</label>
                                <p>Dieser Text erscheint unten links auf jedem PDF-Stundenplan-Export. (z.B. Schulname & Adresse)</p>
                            </div>
                            <div class="setting-control" style="flex-direction: column; align-items: flex-start;">
                                <textarea id="pdf_footer_text"
                                          name="pdf_footer_text"
                                          rows="3"
                                          style="min-height: 80px; width: 100%; max-width: 450px;"
                                          placeholder="z.B. PAUSE Portal - Deine Schule - Schulstra√üe 1"><?php echo htmlspecialchars($currentSettings['pdf_footer_text'] ?? ''); ?></textarea>
                                <small class="form-hint" style="margin-top: 8px;">Hinweis: Nur Standard-Satzzeichen (ASCII/ISO-8859-1) verwenden. Emojis oder spezielle UTF-8-Zeichen werden im PDF nicht korrekt dargestellt.</small>
                            </div>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <label for="community_board_enabled">Schwarzes Brett (Community)</label>
                                <p>Aktiviert oder deaktiviert das Schwarze Brett f√ºr alle Benutzer (Sch√ºler, Lehrer, Planer).</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox"
                                           id="community_board_enabled"
                                           name="community_board_enabled"
                                           value="1"
                                           <?php echo($currentSettings['community_board_enabled'] ? 'checked' : ''); ?>>
                                    <span class="slider round"></span>
                                </label>
                                <span id="community-board-status" class="toggle-status">
                                    <?php echo($currentSettings['community_board_enabled'] ? 'Aktiviert' : 'Deaktiviert'); ?>
                                </span>
                            </div>
                        </div>
                        
                    </div>

                    <div class="form-actions" style="margin-top: 30px; border-top: 1px solid var(--color-border); padding-top: 25px;">
                        <button type="submit" class="btn btn-primary" id="save-settings-btn">
                            Einstellungen speichern
                        </button>
                        <span id="save-settings-spinner" class="loading-spinner small" style="display: none; margin-left: 15px;"></span>
                    </div>
                </form>
                
                <div class="form-container settings-section" style="margin-top: 30px;">
                    <h3>System-Wartung</h3>
                    
                    <div class="setting-row">
                        <div class="setting-info">
                            <label>Anwendungs-Cache</label>
                            <p>L√∂scht alle zwischengespeicherten Daten (z.B. Stundenpl√§ne, Einstellungen). Dies kann helfen, Anzeigefehler nach √Ñnderungen zu beheben.</p>
                        </div>
                        <div class="setting-control cache-control-section" style="flex-direction: column; align-items: flex-start;">
                            <input type="hidden" id="cache_csrf_token" value="<?php echo htmlspecialchars(\App\Core\Security::getCsrfToken()); ?>">
                            
                            <button type="button" id="clear-cache-btn" class="btn btn-secondary" style="width: auto; margin-bottom: 0;">
                                Cache jetzt leeren
                            </button>
                            <small id="cache-clear-status" class="form-text" style="margin-top: 10px; display: block;"></small>
                        </div>
                    </div>
                </div>
                </div>
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\settings.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\stammdaten.php ---
<?php
// pages/admin/stammdaten.php
include_once dirname(__DIR__) . '/partials/header.php';
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">Stammdatenverwaltung</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="stammdaten-management">
            <nav class="tab-navigation">
                <button class="tab-button active" data-target="subjects-section">F√§cher</button>
                <button class="tab-button" data-target="rooms-section">R√§ume</button>
                <button class="tab-button" data-target="teachers-section">Lehrer</button>
                <button class="tab-button" data-target="classes-section">Klassen</button>
            </nav>

            <div class="tab-content">
                <div class="dashboard-section active" id="subjects-section">
                    <div class="form-container" id="subject-form-container">
                        <h4>Fach anlegen/bearbeiten</h4>
                        <form id="subject-form" data-mode="create">
                             <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                            <input type="hidden" name="subject_id" id="subject_id">
                            <div class="form-group">
                                <label for="subject_name">Fachname*</label>
                                <input type="text" name="subject_name" id="subject_name" required>
                            </div>
                            <div class="form-group">
                                <label for="subject_shortcut">K√ºrzel*</label>
                                <input type="text" name="subject_shortcut" id="subject_shortcut" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Speichern</button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-subject" style="display: none;">Abbrechen</button>
                            </div>
                        </form>
                    </div>
                    <div class="table-container">
                        <h3>Bestandsdaten F√§cher</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="subjects-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Fachname</th>
                                        <th>K√ºrzel</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4">Lade F√§cher...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section" id="rooms-section">
                     <div class="form-container" id="room-form-container">
                        <h4>Raum anlegen/bearbeiten</h4>
                        <form id="room-form" data-mode="create">
                             <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                            <input type="hidden" name="room_id" id="room_id">
                            <div class="form-group">
                                <label for="room_name">Raumname*</label>
                                <input type="text" name="room_name" id="room_name" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Speichern</button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-room" style="display: none;">Abbrechen</button>
                            </div>
                        </form>
                    </div>
                    <div class="table-container">
                        <h3>Bestandsdaten R√§ume</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="rooms-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Raumname</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="3">Lade R√§ume...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section" id="teachers-section">
                    <div class="form-container" id="teacher-form-container">
                        <h4>Lehrer anlegen/bearbeiten</h4>
                        <form id="teacher-form" data-mode="create">
                             <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                            <input type="hidden" name="teacher_id" id="teacher_id">
                             <div class="form-group">
                                <label for="teacher_shortcut">K√ºrzel*</label>
                                <input type="text" name="teacher_shortcut" id="teacher_shortcut" required>
                            </div>
                            <div class="form-group">
                                <label for="first_name">Vorname*</label>
                                <input type="text" name="first_name" id="first_name" required>
                            </div>
                            <div class="form-group">
                                <label for="last_name">Nachname*</label>
                                <input type="text" name="last_name" id="last_name" required>
                            </div>
                            <div class="form-group">
                                <label for="email">E-Mail</label>
                                <input type="email" name="email" id="email">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Speichern</button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-teacher" style="display: none;">Abbrechen</button>
                            </div>
                        </form>
                    </div>
                    <div class="table-container">
                        <h3>Bestandsdaten Lehrer</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="teachers-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>K√ºrzel</th>
                                        <th>Vorname</th>
                                        <th>Nachname</th>
                                        <th>E-Mail</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6">Lade Lehrer...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section" id="classes-section">
                    <div class="form-container" id="class-form-container">
                        <h4>Klasse anlegen/bearbeiten</h4>
                        <form id="class-form" data-mode="create">
                             <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                             <!-- Hidden input for class_id when updating -->
                             <input type="hidden" name="class_id" id="class_id_hidden">
                            <div class="form-group">
                                <label for="class_id_input">Klassennummer (ID)*</label>
                                <input type="number" name="class_id_input" id="class_id_input" required> <!-- Name changed to avoid conflict -->
                                <small class="form-hint">Diese ID ist eindeutig und kann nach dem Erstellen nicht mehr ge√§ndert werden.</small>
                            </div>
                            <div class="form-group">
                                <label for="class_name">Klassen-Akronym*</label>
                                <input type="text" name="class_name" id="class_name" required>
                            </div>
                            <div class="form-group">
                                <label for="class_teacher_id">Klassenlehrer</label>
                                <select name="class_teacher_id" id="class_teacher_id">
                                    <option value="">Kein Klassenlehrer</option>
                                    </select>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Speichern</button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-class" style="display: none;">Abbrechen</button>
                            </div>
                        </form>
                    </div>
                    <div class="table-container">
                        <h3>Bestandsdaten Klassen</h3>
                        <div class="table-responsive">
                            <table class="data-table" id="classes-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Klassen-Akronym</th>
                                        <th>Klassenlehrer</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4">Lade Klassen...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>


--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\stammdaten.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\system_health.php ---
<?php
// pages/admin/system_health.php
// NEU ERSTELLT
include_once dirname(__DIR__) . '/partials/header.php';
// $data (Array) wird vom SystemHealthController::index() √ºbergeben
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">System-Status</h1>
    <div class="dashboard-grid">
        
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>

        <main class="dashboard-content" id="system-health-management">
            <div class="dashboard-section active">
                
                <div class="health-grid">

                    <div class="health-widget widget-server">
                        <h3>Server & Datenbank</h3>
                        <ul class="health-list">
                            <li>
                                <span class="health-label">PHP Version</span>
                                <span class="health-value"><?php echo htmlspecialchars($data['phpVersion']); ?></span>
                            </li>
                            <li>
                                <span class="health-label">Server Software</span>
                                <span class="health-value"><?php echo htmlspecialchars($data['serverSoftware']); ?></span>
                            </li>
                            <li>
                                <span class="health-label">Datenbank-Status</span>
                                <?php if ($data['dbStatus']['status'] === 'ok'): ?>
                                    <span class="health-value status-ok">
                                        <i class="icon-check"></i> <?php echo htmlspecialchars($data['dbStatus']['message']); ?>
                                    </span>
                                <?php else: ?>
                                    <span class="health-value status-error">
                                        <i class="icon-x"></i> <?php echo htmlspecialchars($data['dbStatus']['message']); ?>
                                    </span>
                                <?php endif; ?>
                            </li>
                             <li>
                                <span class="health-label">Wartungsmodus</span>
                                <?php if ($data['settings']['maintenance_mode']): ?>
                                    <span class="health-value status-warn">
                                        <i class="icon-tool"></i> Aktiviert
                                    </span>
                                <?php else: ?>
                                    <span class="health-value status-ok">
                                        <i class="icon-check"></i> Deaktiviert
                                    </span>
                                <?php endif; ?>
                            </li>
                        </ul>
                    </div>

                    <div class="health-widget widget-extensions">
                        <h3>PHP-Erweiterungen</h3>
                        <ul class="health-list">
                            <?php foreach ($data['extensions'] as $ext => $isLoaded): ?>
                            <li>
                                <span class="health-label"><?php echo htmlspecialchars($ext); ?></span>
                                <?php if ($isLoaded): ?>
                                    <span class="health-value status-ok">
                                        <i class="icon-check"></i> Geladen
                                    </span>
                                <?php else: ?>
                                    <span class="health-value status-error">
                                        <i class="icon-x"></i> Nicht geladen
                                    </span>
                                <?php endif; ?>
                            </li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                    
                    <div class="health-widget widget-permissions">
                        <h3>Verzeichnis-Berechtigungen</h3>
                        <ul class="health-list">
                             <?php foreach ($data['directoryStatus'] as $name => $dir): ?>
                            <li>
                                <span class="health-label"><?php echo htmlspecialchars($name); ?></span>
                                <?php if ($dir['status'] === 'ok'): ?>
                                    <span class="health-value status-ok">
                                        <i class="icon-check"></i> <?php echo htmlspecialchars($dir['message']); ?>
                                    </span>
                                <?php else: ?>
                                    <span class="health-value status-error">
                                        <i class="icon-x"></i> <?php echo htmlspecialchars($dir['message']); ?>
                                    </span>
                                <?php endif; ?>
                            </li>
                            <?php endforeach; ?>
                        </ul>
                    </div>

                </div>
            </div>
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\system_health.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\users.php ---
<?php
// pages/admin/users.php
include_once dirname(__DIR__) . '/partials/header.php';
?>

<div class="page-wrapper admin-dashboard-wrapper">
    <h1 class="main-title">Benutzerverwaltung</h1>
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; ?>
        <main class="dashboard-content" id="user-management">

            <div class="dashboard-section active" id="user-import-section">
                <div class="section-header">
                    <h3>Benutzer-Massenimport (CSV)</h3>
                </div>
                <div class="form-container" style="background-color: var(--color-surface-alt);">
                    <form id="user-import-form" enctype="multipart/form-data" method="POST">
                        <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                        <div class="form-group">
                            <label for="csv_file">CSV-Datei ausw√§hlen*</label>
                            <input type="file" name="csv_file" id="csv_file" accept=".csv" required>
                            <small class="form-hint">
                                Die CSV-Datei muss exakt die Spalten der Vorlage enthalten.
                                <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/csv-template')); ?>" target="_blank" class="template-download-link">
                                    CSV-Vorlage
                                </a>
                            </small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="user-import-btn">Import starten</button>
                        </div>
                    </form>
                    <div id="import-results-container" style="display: none; margin-top: 20px;">
                        <h4>Importergebnisse:</h4>
                        <pre id="import-results" class="import-results-box"></pre>
                    </div>
                </div>
            </div>

            <div class="dashboard-section active" id="user-list-section">
                <div class="section-header">
                    <h3>Alle Benutzer</h3>
                </div>
                <div>
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="data-table" id="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Rolle</th>
                                        <th>Details</th>
                                        <th>Community</th> <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6">Lade Benutzer...</td></tr> </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="form-container">
                        <h4 id="user-form-title">Neuen Benutzer anlegen</h4>
                        <form id="user-form" data-mode="create">
                            <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                            <input type="hidden" name="user_id" id="user_id">

                            <div class="form-grid-col-2">
                                <div class="form-group">
                                    <label for="first_name">Vorname*</label>
                                    <input type="text" name="first_name" id="first_name" required>
                                </div>
                                <div class="form-group">
                                    <label for="last_name">Nachname*</label>
                                    <input type="text" name="last_name" id="last_name" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="username">Benutzername*</label>
                                <input type="text" name="username" id="username" required>
                            </div>
                            <div class="form-group">
                                <label for="email">E-Mail*</label>
                                <input type="email" name="email" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Passwort</label>
                                <input type="password" name="password" id="password" placeholder="Beim Bearbeiten leer lassen">
                                <small class="form-hint">Mindestens 8 Zeichen. Nur beim Erstellen erforderlich.</small>
                            </div>
                            <div class="form-group">
                                <label for="birth_date">Geburtsdatum</label>
                                <input type="date" name="birth_date" id="birth_date">
                            </div>

                            <hr>

                            <div class="form-group">
                                <label for="role">Rolle*</label>
                                <select name="role" id="role" required>
                                </select>
                            </div>

                            <div id="role-specific-fields">
                                <div class="form-group" id="class-select-container" style="display: none;">
                                    <label for="class_id">Klasse</label>
                                    <select name="class_id" id="class_id">
                                    </select>
                                </div>
                                <div class="form-group" id="teacher-select-container" style="display: none;">
                                    <label for="teacher_id">Lehrerprofil</label>
                                    <select name="teacher_id" id="teacher_id">
                                    </select>
                                </div>
                                <div class="form-group" id="community-ban-container" style="display: none;">
                                    <label class="checkbox-label" for="is_community_banned">
                                        <input type="checkbox" name="is_community_banned" id="is_community_banned" value="1">
                                        F√ºr Schwarzes Brett sperren
                                    </label>
                                    <small class="form-hint">Wenn angehakt, kann dieser Sch√ºler keine Beitr√§ge sehen oder erstellen.</small>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" id="cancel-edit-user" style="display: none;">Abbrechen</button>
                                <button type="submit" class="btn btn-primary">Speichern</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<?php
include_once dirname(__DIR__) . '/partials/footer.php';
?>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\admin\users.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\auth\login.php ---
<?php
// pages/auth/login.php

// Der Pfad verweist jetzt auf den korrekten Ordner `pages/partials`.
include_once __DIR__ . '/../partials/header.php';
?>

<div class="page-wrapper" style="padding-top: 100px;">
    <div class="auth-container">

        <h1 class="main-title">Login</h1>

        <?php if (!empty($message)): ?>
            <p class="message error"><?php echo htmlspecialchars($message); ?></p>
        <?php endif; ?>

        <form action="<?php echo \App\Core\Utils::url('login/process'); ?>" method="post">
            <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
            <p>
                <label for="identifier">Benutzername oder E-Mail</label>
                <input type="text" id="identifier" name="identifier" required>
            </p>
            <p>
                <label for="password">Passwort</label>
                <input type="password" id="password" name="password" required>
            </p>
            <p>
                <input type="submit" value="Anmelden" class="btn btn-primary" style="width: 100%;">
            </p>
        </form>
    </div>
</div>

<?php
// Der Pfad verweist jetzt auf den korrekten Ordner `pages/partials`.
include_once __DIR__ . '/../partials/footer.php';
?>


--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\auth\login.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\errors\404.php ---
<?php
// pages/errors/404.php
global $config;
?>
<div class="container text-center">
    <h1 class="main-title" style="font-size: 5rem; margin-bottom: 0;">404</h1>
    <p style="font-size: 1.5rem; color: var(--color-text-muted); margin-top: 0;">Stunde entfallen!</p>
    <p>Ups! Diese Seite scheint heute auszufallen. Bitte beachten Sie den digitalen Vertretungsplan und kehren Sie zur Startseite zur√ºck.</p>
    <a href="<?php echo htmlspecialchars($config['base_url']); ?>/" class="btn btn-primary" style="width: auto; margin-top: 20px;">Zur√ºck zum Stundenplan</a>
</div>

--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\errors\404.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\errors\503.php ---
<?php
// pages/errors/503.php
// Zeigt die Wartungsseite an.
// $maintenance_message wird von index.php √ºbergeben.
global $config;
?>
<div class="page-wrapper" style="padding-top: 100px;">
    <div class="auth-container" style="max-width: 600px; text-align: center;">
        <h1 class="main-title" style="font-size: 2.5rem; color: var(--color-warning);">üîß Wartungsarbeiten</h1>
        <p style="font-size: 1.1rem; line-height: 1.6; color: var(--color-text-muted);">
            <?php echo nl2br(htmlspecialchars($maintenance_message ?? 'Die Anwendung wird gerade gewartet. Bitte versuchen Sie es sp√§ter erneut.')); ?>
        </p>
        
        <?php // Admins einen einfachen Weg zum Login geben ?>
         <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('login')); ?>" class="btn btn-secondary" style="width: auto; margin-top: 25px;">
             Zum Admin-Login
         </a>
    </div>
</div>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\errors\503.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\partials\footer.php ---
</main> <?php // Closes <main class="page-wrapper"> from header.php ?>

    <footer class="site-footer">
        <div class="footer-content container">
            <div class="copyright">
                 &copy; <?php echo date('Y'); ?> <?php echo htmlspecialchars(\App\Core\Utils::getSettings()['site_title']); ?>
                 - Ein Produkt des PMI.
            </div>

            <div class="imprint">
                <button id="imprint-toggle" class="imprint-toggle">Impressum &amp; Rechtliches</button>
                <div id="imprint-details" class="imprint-details">
                    <p>
                        <strong>Angaben gem√§√ü ¬ß 5 TMG:</strong><br>
                        Der Ultramodulare, Responsiv-Agile Kognitionsarchitekt und Interaktionsoptimierer f√ºr Gro√üsprachmodelle ‚Äì Prompt-Engineering-Meisterschafts-Zentrum<br>
                        kurz: <strong>PMI - Prompt Meister Institut</strong>
                    </p>
                    <p>
                        Future-Allee 1<br>
                        69115 Heidelberg<br>
                        Deutschland
                        </p>
                    <p>
                        <strong>Vertreten durch:</strong><br>
                        [Name des Vertretungsberechtigten]
                        </p>
                    <p>
                        <strong>Kontakt:</strong><br>
                        Telefon: +49 (0) 6221 / [Ihre Nummer]<br>
                        E-Mail: kontakt@prompt-meister-institut.de
                        </p>
                    <p>
                        <strong>Registereintrag:</strong><br>
                         Eintragung im Handelsregister.<br>
                        Registergericht: Amtsgericht Mannheim<br>
                        Registernummer: HRB [Ihre Nummer]
                         </p>
                    <p>
                        <strong>Umsatzsteuer-ID:</strong><br>
                         Umsatzsteuer-Identifikationsnummer gem√§√ü ¬ß27a Umsatzsteuergesetz:<br>
                        DE[Ihre USt-IdNr.]
                         </p>
                    <p>
                        <a href="#placeholder-privacy">Datenschutzerkl√§rung</a> |
                        <a href="#placeholder-terms">Nutzungsbedingungen</a>
                         </p>
                     <button id="imprint-close" class="imprint-close">&times; Schlie√üen</button>
                </div>
            </div>
        </div>
    </footer>

    <script type="module" src="<?php echo rtrim($config['base_url'], '/'); ?>/assets/js/main.js"></script>

</body>
</html>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\partials\footer.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\partials\header.php ---
<?php
// pages/partials/header.php
// KORRIGIERT: Fehlende IDs (user-menu-btn und user-menu-dropdown) 
// in Zeile 90 & 94 wieder hinzugef√ºgt, damit das JavaScript-Dropdown funktioniert.

$settings = \App\Core\Utils::getSettings();
global $config; // Ensure $config is accessible

// NEU: Bereite Logo- und Favicon-Pfade vor
$faviconPath = !empty($settings['site_favicon_path'])
    ? htmlspecialchars(\App\Core\Utils::url($settings['site_favicon_path']))
    : null; // Oder ein Pfad zu einem Standard-Favicon

$logoPath = !empty($settings['site_logo_path'])
    ? htmlspecialchars(\App\Core\Utils::url($settings['site_logo_path']))
    : null;

// F√ºge einen Cache-Buster hinzu, um √Ñnderungen sofort sichtbar zu machen
$cacheBuster = "?v=" . time();
if ($faviconPath) $faviconPath .= $cacheBuster;
if ($logoPath) $logoPath .= $cacheBuster;

?>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<?php echo htmlspecialchars(\App\Core\Security::getCsrfToken()); ?>">
    <title><?php echo htmlspecialchars($page_title ?? $settings['site_title']); ?></title>

    <?php // NEU: Dynamisches Favicon ?>
    <?php if ($faviconPath): ?>
        <link rel="icon" href="<?php echo $faviconPath; ?>">
    <?php endif; ?>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@700&display=swap" rel="stylesheet">

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script>
        // Immediately set theme before rendering to prevent flash
        (function() {
            // KORRIGIERT: Bevorzuge das Admin-Setting als Fallback
            const defaultTheme = <?php echo json_encode($settings['default_theme'] ?? 'light'); ?>;
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : defaultTheme);
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();

        window.APP_CONFIG = {
            baseUrl: '<?php echo rtrim($config['base_url'], '/'); ?>',
            userRole: '<?php echo $_SESSION['user_role'] ?? ''; ?>',
            userId: <?php echo $_SESSION['user_id'] ?? 'null'; ?>, // Added userId for potential JS checks
            settings: <?php echo json_encode($settings); ?>
        };
    </script>

    <link rel="stylesheet" href="<?php echo htmlspecialchars(rtrim($config['base_url'], '/')); ?>/assets/css/main.css">
</head>
<body class="<?php echo htmlspecialchars($body_class ?? ''); ?> role-<?php echo htmlspecialchars($_SESSION['user_role'] ?? 'guest'); ?>"> <?php /* Added role class to body */ ?>
    
    <?php // Impersonation Banner ?>
    <?php if (isset($_SESSION['impersonator_id'])): ?>
        <div class="impersonation-banner">
            <div class="page-wrapper" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px;">
                <span>
                    <strong>Achtung:</strong> Sie sind angemeldet als 
                    <strong><?php echo htmlspecialchars($_SESSION['username'] ?? 'Benutzer'); ?></strong> 
                    (Rolle: <?php echo htmlspecialchars($_SESSION['user_role'] ?? 'N/A'); ?>).
                </span>
                <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('logout/revert')); ?>" class="btn btn-secondary btn-small" style="width: auto; margin-bottom: 0;">
                    Zur√ºck zum Admin-Konto
                </a>
            </div>
        </div>
    <?php endif; ?>

    <header class="page-header">
        <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('/')); ?>" class="site-logo">
            <?php // NEU: Logo-Logik ?>
            <?php if ($logoPath): ?>
                <img src="<?php echo $logoPath; ?>" alt="<?php echo htmlspecialchars($settings['site_title']); ?> Logo" class="site-logo-image" id="header-logo-img">
            <?php else: ?>
                <span id="header-logo-text"><?php echo htmlspecialchars($settings['site_title']); ?></span>
            <?php endif; ?>
        </a>

        <nav class="header-nav" id="header-nav">
            <div class="nav-right">
                <button id="theme-toggle" class="theme-toggle" title="Theme umschalten">
                    <img class="sun-icon" src="<?php echo htmlspecialchars(rtrim($config['base_url'], '/')); ?>/assets/images/sun.png" alt="Light Mode">
                    <img class="moon-icon" src="<?php echo htmlspecialchars(rtrim($config['base_url'], '/')); ?>/assets/images/moon.png" alt="Dark Mode">
                </button>
                <span class="nav-separator"></span> <?php if (isset($_SESSION['user_id'])):
                    $userRole = $_SESSION['user_role'] ?? '';
                ?>
                    <div class="user-menu">
                        <?php // KORREKTUR: id="user-menu-btn" hinzugef√ºgt ?>
                        <button id="user-menu-btn" class="user-menu-toggle" aria-haspopup="true" aria-expanded="false">
                            <span>Hallo, <?php echo htmlspecialchars($_SESSION['username']); ?></span>
                            <svg class="chevron-down" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                        </button>
                        <?php // KORREKTUR: id="user-menu-dropdown" hinzugef√ºgt ?>
                        <div id="user-menu-dropdown" class="user-menu-dropdown">
                            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('dashboard')); ?>">Mein Dashboard</a>

                            <?php if ($userRole === 'admin'): ?>
                                 <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/dashboard')); ?>">Admin Bereich</a>
                            <?php elseif ($userRole === 'planer'): ?>
                                 <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('planer/dashboard')); ?>">Planer Bereich</a>
                            <?php endif; ?>

                            <?php if (in_array($userRole, ['admin', 'planer', 'lehrer'])): ?>
                                 <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/announcements')); ?>">Ank√ºndigungen</a>
                            <?php endif; ?>

                            <div class="dropdown-divider"></div>
                            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('logout')); ?>">Abmelden</a>
                        </div>
                    </div>
                <?php else: ?>
                    <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('login')); ?>" class="header-link">Anmelden</a>
                    <?php endif; ?>
            </div>
        </nav>
        <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-controls="header-nav" aria-expanded="false">
            <span class="visually-hidden">Men√º</span>
            <span class="hamburger-box"><span class="hamburger-inner"></span></span>
        </button>
    </header>
    <main class="page-wrapper">
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\partials\header.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\partials\_timetable_grid.php ---
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\partials\_timetable_grid.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\planer\partials\_sidebar.php ---
<?php
// pages/planer/partials/_sidebar.php
// NEU: Eigene Sidebar f√ºr den Planer-Bereich
?>
<aside class="dashboard-sidebar">
    <h2>Planer-Werkzeuge</h2>
    <nav class="dashboard-nav">
        <?php
        $currentUrl = $_SERVER['REQUEST_URI'];
        $userRole = $_SESSION['user_role'] ?? '';
        ?>

        <?php if (in_array($userRole, ['admin', 'planer'])): ?>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('planer/dashboard')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'planer/dashboard') ? 'active' : ''); ?>">
                Stundenplan-Editor
            </a>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('planer/absences')); ?>"
               class="dashboard-nav-item <?php echo (str_contains($currentUrl, 'planer/absences') ? 'active' : ''); ?>">
                Lehrer-Abwesenheiten
            </a>
            <!-- Zuk√ºnftige Planer-Links k√∂nnen hier hinzugef√ºgt werden -->
        <?php endif; ?>
         
        <?php if (in_array($userRole, ['admin'])): ?>
             <div class="dropdown-divider" style="margin: 15px 0; border-color: var(--color-border);"></div>
            <a href="<?php echo htmlspecialchars(\App\Core\Utils::url('admin/dashboard')); ?>"
               class="dashboard-nav-item">
                &laquo; Zur√ºck zum Admin-Dashboard
            </a>
        <?php endif; ?>
    </nav>
</aside>

--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\planer\partials\_sidebar.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\planer\absences.php ---
<?php
// pages/planer/absences.php
// NEU: Diese Datei erstellt die Seite f√ºr die Abwesenheitsverwaltung.
include_once dirname(__DIR__) . '/partials/header.php';

// $availableTeachers und $absenceTypes werden vom AbsenceController->index() √ºbergeben
?>

<div class="page-wrapper planer-dashboard-wrapper">
    <h1 class="main-title">Lehrer-Abwesenheiten</h1>

    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; // Planer-Sidebar einbinden ?>

        <main class="dashboard-content" id="absence-management">
            
            <div class="dashboard-section active">
                <div class="dashboard-widget-grid" id="absence-grid">

                    <div class="dashboard-widget" id="widget-add-absence" style="grid-column: 1 / -1;">
                        <h3 id="absence-form-title">Neue Abwesenheit eintragen</h3>
                        <div class="form-container" style="background: transparent; border: none; padding: 0; box-shadow: none; margin: 0;">
                            <form id="absence-form" data-mode="create" class="absence-form-layout">
                                <?php \App\Core\Security::csrfInput(); // CSRF-Token ?>
                                
                                <div class="form-group" id="absence-teacher-group">
                                    <label for="absence-teacher-id">Lehrer*</label>
                                    <select name="teacher_id" id="absence-teacher-id" required>
                                        <option value="">-- Lehrer w√§hlen --</option>
                                        <?php foreach ($availableTeachers as $teacher): ?>
                                            <?php // SGL herausfiltern ?>
                                            <?php if ($teacher['teacher_shortcut'] !== 'SGL'): ?>
                                                <option value="<?php echo htmlspecialchars($teacher['teacher_id']); ?>">
                                                    <?php echo htmlspecialchars($teacher['last_name'] . ', ' . $teacher['first_name'] . ' (' . $teacher['teacher_shortcut'] . ')'); ?>
                                                </option>
                                            <?php endif; ?>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="absence-start-date">Von Datum*</label>
                                    <input type="date" name="start_date" id="absence-start-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="absence-end-date">Bis Datum*</label>
                                    <input type="date" name="end_date" id="absence-end-date" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="absence-reason">Grund*</label>
                                    <select name="reason" id="absence-reason" required>
                                        <option value="">-- Grund w√§hlen --</option>
                                        <?php foreach ($absenceTypes as $type): ?>
                                            <option value="<?php echo htmlspecialchars($type); ?>">
                                                <?php echo htmlspecialchars($type); ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="absence-comment-group">
                                    <label for="absence-comment">Kommentar (optional)</label>
                                    <input type="text" name="comment" id="absence-comment" placeholder="z.B. Details zur Fortbildung...">
                                </div>
                                
                                <input type="hidden" name="absence_id" id="absence-id">

                                <div class="form-actions" id="absence-actions-group" style="margin-top: 0; display: flex; gap: 10px;">
                                    <button type="submit" class="btn btn-primary" id="absence-save-btn">Speichern</button>
                                    <button type="button" class="btn btn-secondary" id="absence-cancel-edit-btn" style="display: none;">Abbrechen</button>
                                    <button type="button" class="btn btn-danger" id="absence-delete-btn" style="display: none; margin-left: auto;">L√∂schen</button>
                                    <span id="absence-save-spinner" class="loading-spinner small" style="display: none; margin-left: 10px;"></span>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="dashboard-widget" id="widget-absence-calendar" style="grid-column: 1 / -1;">
                        <h3>Abwesenheits-Kalender</h3>
                        <div id="absence-calendar" style="min-height: 600px; margin-top: 20px;">
                            <div class="loading-spinner"></div>
                            </div>
                    </div>

                </div>
            </div>
        </main>
    </div> </div> <?php
// Include the footer partial
include_once dirname(__DIR__) . '/partials/footer.php';
?>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\planer\absences.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\planer\dashboard.php ---
<?php
// pages/planer/dashboard.php
include_once dirname(__DIR__) . '/partials/header.php';
?>

<div class="page-wrapper planer-dashboard-wrapper">
    <!-- Main header section for the planner view -->
    <div class="planer-header">
        <h1 class="main-title">Stundenplan-Verwaltung</h1>

        <!-- Wrapper for all control elements on the right side -->
        <div class="planer-actions-wrapper">

            <!-- Filter controls section -->
            <div class="planer-controls">
                <!-- View mode switcher (Class/Teacher) -->
                <div class="form-group view-switcher">
                    <label for="view-mode-selector">Ansicht:</label>
                    <select id="view-mode-selector">
                        <option value="class" selected>Klassenansicht</option>
                        <option value="teacher">Lehreransicht</option>
                    </select>
                </div>
                 <!-- Class selector dropdown -->
                <div class="form-group" id="class-selector-container">
                    <label for="class-selector">Klasse:</label>
                    <select id="class-selector"></select>
                </div>
                 <!-- Teacher selector dropdown (initially hidden) -->
                <div class="form-group hidden" id="teacher-selector-container">
                    <label for="teacher-selector">Lehrer:</label>
                    <select id="teacher-selector"></select>
                </div>
                 <!-- Year selector -->
                <div class="form-group">
                    <label for="year-selector">Jahr:</label>
                    <select id="year-selector"></select>
                </div>
                <!-- Week selector -->
                <div class="form-group">
                    <label for="week-selector">KW:</label>
                    <select id="week-selector"></select>
                </div>
                <!-- Date selector (for viewing specific day's substitutions) -->
                <div class="form-group">
                    <label for="date-selector">Datum f√ºr Vertr.:</label>
                    <input type="date" id="date-selector">
                </div>
            </div> <!-- End planer-controls -->

            <!-- Publish controls section -->
            <div class="publish-controls">
                 <!-- Display area for the current week's publish status -->
                 <div class="publish-status">
                    Status KW <span id="publish-week-label">--</span>:
                    <span id="publish-status-student" class="status-indicator">Sch√ºler: ?</span>
                    <span id="publish-status-teacher" class="status-indicator">Lehrer: ?</span>
                 </div>
                 <!-- Action buttons for publishing/unpublishing -->
                 <div class="publish-actions">
                    <button id="publish-student-btn" class="btn btn-success btn-small">F√ºr Sch√ºler ver√∂ffentlichen</button>
                    <button id="publish-teacher-btn" class="btn btn-success btn-small">F√ºr Lehrer ver√∂ffentlichen</button>
                    <button id="unpublish-student-btn" class="btn btn-warning btn-small hidden">Sch√ºler zur√ºckziehen</button>
                    <button id="unpublish-teacher-btn" class="btn btn-warning btn-small hidden">Lehrer zur√ºckziehen</button>
                 </div>
            </div> <!-- End publish-controls -->

        </div> <!-- End planer-actions-wrapper -->
    </div> <!-- End planer-header -->

    <!-- NEU: Grid-Layout f√ºr Sidebar und Hauptinhalt -->
    <div class="dashboard-grid">
        <?php include_once __DIR__ . '/partials/_sidebar.php'; // NEU: Planer-Sidebar einbinden ?>

        <main class="dashboard-content" id="planer-main-content">
            <!-- Container where the timetable grid will be rendered -->
            <div class="timetable-container" id="timetable-container">
                <div class="loading-spinner"></div> <!-- Loading indicator -->
            </div>

            <!-- Massenbearbeitung MOVED HERE -->
            <div class="bulk-actions-controls" style="margin-top: 20px;"> <!-- Added margin-top for spacing -->
                <button id="copy-week-btn" class="btn btn-secondary btn-small">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/></svg>
                    Woche kopieren...
                </button>
                <!-- NEUE Buttons f√ºr Vorlagen -->
                <button id="create-template-btn" class="btn btn-secondary btn-small">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1m1 4h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1m0 2h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1m0 2h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1"/></svg>
                    Vorlage erstellen...
                </button>
                <button id="apply-template-btn" class="btn btn-secondary btn-small">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0zM5 5.5A1.5 1.5 0 0 0 3.5 7v1A1.5 1.5 0 0 0 5 9.5h6a1.5 1.5 0 0 0 1.5-1.5v-1A1.5 1.5 0 0 0 11 5.5zM3.5 11A1.5 1.5 0 0 0 2 12.5v1A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5v-1A1.5 1.5 0 0 0 12.5 11z"/></svg>
                    Vorlage anwenden...
                </button>
                <button id="manage-templates-btn" class="btn btn-secondary btn-small">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 1v3H1V1zM1 0a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1zm14 12v3H10v-3zm-1-1a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1zM6 8v7H1V8zM1 7a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1zm14-6v7H10V1zm-1-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1z"/></svg>
                    Vorlagen verwalten...
                </button>
                <!-- Platzhalter f√ºr zuk√ºnftige Aktionen wie "Drucken" -->
            </div>
        </main>
    </div> <!-- Ende .dashboard-grid -->


    <!-- Modal for editing/creating timetable entries -->
     <div id="timetable-modal" class="modal-overlay">
         <div class="modal-box">
             <h2 id="modal-title">Eintrag bearbeiten</h2>
             <form id="timetable-entry-form">
                 <?php \App\Core\Security::csrfInput(); // Add CSRF input field ?>
                 <!-- Hidden fields to store context -->
                 <input type="hidden" id="entry_id" name="entry_id">
                 <input type="hidden" id="block_id" name="block_id">
                 <input type="hidden" id="substitution_id" name="substitution_id">
                 <input type="hidden" id="modal_day_of_week" name="day_of_week">
                 <input type="hidden" id="modal_period_number" name="period_number">
                 <input type="hidden" id="original_subject_id" name="original_subject_id">
                 <input type="hidden" id="modal_editing_template" name="editing_template" value="false"> <!-- NEU: Flag f√ºr Template-Editor -->


                 <!-- Tabs to switch between regular entry and substitution -->
                 <div class="modal-tabs">
                     <button type="button" class="tab-button active" data-mode="regular">Regul√§re Stunde</button>
                     <button type="button" class="tab-button" data-mode="substitution">Vertretung/√Ñnderung</button>
                 </div>

                 <!-- Fields for regular timetable entry -->
                 <div id="regular-fields" class="modal-tab-content active">
                     <!-- Klassen-Auswahl f√ºr Template-Editor (wird nur dort angezeigt) -->
                     <div class="form-group" id="template-class-select-container" style="display: none;">
                         <!-- KORRIGIERTES LABEL UND HILFETEXT -->
                         <label for="template_class_id">Standard-Klasse (f√ºr Lehrer-Vorlagen)</label>
                         <select id="template_class_id" name="class_id" class="conflict-check"></select>
                         <small class="form-hint">N√∂tig, wenn Vorlage auf Lehrer angewendet wird. Wird ignoriert, wenn Vorlage auf Klasse angewendet wird.</small>
                     </div>
                    <div class="form-group">
                        <label for="subject_id">Fach</label>
                        <select id="subject_id" name="subject_id" class="conflict-check" required></select>
                    </div>
                    <div class="form-group">
                        <label for="teacher_id">Lehrer</label>
                        <select id="teacher_id" name="teacher_id" class="conflict-check" required></select>
                    </div>
                    <div class="form-group">
                        <label for="room_id">Raum</label>
                        <select id="room_id" name="room_id" class="conflict-check" required></select>
                    </div>
                    <div class="form-group">
                        <label for="regular_comment">Kommentar (optional)</label>
                        <input type="text" id="regular_comment" name="comment" placeholder="z.B. Klausur, Besonderheit">
                    </div>
                 </div>

                 <!-- Fields for substitution entry -->
                 <div id="substitution-fields" class="modal-tab-content">
                     <!-- Substitution Fields bleiben wie gehabt -->
                      <div class="form-group">
                        <label for="substitution_type">Art der √Ñnderung</label>
                        <select id="substitution_type" name="substitution_type">
                            <option value="Vertretung">Vertretung</option>
                            <option value="Raum√§nderung">Raum√§nderung</option>
                            <option value="Entfall">Entfall</option>
                            <option value="Sonderevent">Sonderevent</option>
                        </select>
                    </div>
                    <!-- Dynamically shown fields based on substitution type -->
                    <div id="substitution-details">
                        <div class="form-group sub-field" data-types='["Vertretung", "Sonderevent"]'>
                            <label for="new_subject_id">Neues Fach (optional)</label>
                            <select id="new_subject_id" name="new_subject_id"></select>
                        </div>
                        <div class="form-group sub-field" data-types='["Vertretung"]'>
                            <label for="new_teacher_id">Neuer Lehrer</label>
                            <select id="new_teacher_id" name="new_teacher_id"></select>
                        </div>
                        <div class="form-group sub-field" data-types='["Vertretung", "Raum√§nderung", "Sonderevent"]'>
                            <label for="new_room_id">Neuer Raum</label>
                            <select id="new_room_id" name="new_room_id"></select>
                        </div>
                         <div class="form-group sub-field" data-types='["Vertretung", "Sonderevent", "Entfall", "Raum√§nderung"]'>
                            <label for="substitution_comment">Kommentar</label>
                            <input type="text" id="substitution_comment" name="comment" placeholder="z.B. Aula-Veranstaltung, Grund f√ºr Entfall">
                        </div>
                    </div>
                 </div>

                 <!-- Konflikt-Warnungs-Box (wird im Template-Editor deaktiviert) -->
                 <div class="modal-conflict-warning" id="modal-conflict-warning" style="display: none;">
                     <!-- Konfliktmeldungen werden hier per JS eingef√ºgt -->
                 </div>


                 <!-- Modal action buttons -->
                 <div class="modal-actions">
                     <button type="button" class="btn btn-danger" id="delete-entry-btn" style="display: none;">L√∂schen</button>
                     <button type="button" class="btn btn-secondary" id="modal-cancel-btn">Abbrechen</button>
                     <button type="submit" class="btn btn-primary" id="modal-save-btn">Speichern</button>
                 </div>
             </form>
         </div>
     </div> <!-- End timetable-modal -->


    <!-- Modal f√ºr Wochenkopie -->
    <div id="copy-week-modal" class="modal-overlay">
        <!-- Inhalt bleibt unver√§ndert -->
         <div class="modal-box">
             <h2 id="copy-week-modal-title">Stundenplan kopieren</h2>
             <form id="copy-week-form">
                 <p>Kopiere den Plan von der aktuell ausgew√§hlten Woche nach:</p>

                 <div class="copy-week-form">
                     <div class="form-group copy-from">
                         <label>Von (Quelle):</label>
                         <input type="text" id="copy-source-display" readonly disabled>
                     </div>
                     <div class="arrow-separator">&rarr;</div>
                     <div class="form-group">
                         <label for="copy-target-year">Ziel-Jahr*</label>
                         <select id="copy-target-year" required></select>
                     </div>
                      <div class="form-group">
                         <label for="copy-target-week">Ziel-KW*</label>
                         <select id="copy-target-week" required></select>
                     </div>
                 </div>

                 <div class="modal-conflict-warning" id="copy-week-warning">
                     <strong>Achtung:</strong> Alle vorhandenen Stundenplan-Eintr√§ge f√ºr die ausgew√§hlte Klasse/Lehrer in der Zielwoche werden √ºberschrieben. Vertretungen werden nicht kopiert.
                 </div>

                 <div class="modal-actions">
                     <button type="button" class="btn btn-secondary" id="copy-week-cancel-btn">Abbrechen</button>
                     <button type="submit" class="btn btn-primary" id="copy-week-confirm-btn">Kopieren & √úberschreiben</button>
                 </div>
             </form>
         </div>
     </div>
     <!-- ENDE Modal f√ºr Wochenkopie -->

    <!-- Modal zum Erstellen/Verwalten von Vorlagen -->
    <div id="manage-templates-modal" class="modal-overlay">
        <div class="modal-box"> <!-- Style wurde in planer.css angepasst (breiter) -->
            <h2 id="manage-templates-modal-title">Vorlagen verwalten</h2>

            <!-- Container f√ºr die Ansichten: Liste vs. Editor -->
            <div id="manage-templates-view-container">

                <!-- Ansicht 1: Liste der Vorlagen + Erstellen-Optionen -->
                <div id="template-list-view" class="manage-templates-view active">
                    <form id="create-template-form">
                         <h4>Neue Vorlage aus aktueller Woche erstellen</h4>
                         <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 15px;">
                             <div class="form-group" style="flex-grow: 1;">
                                 <label for="template-name">Vorlagenname*</label>
                                 <input type="text" id="template-name" name="template-name" required placeholder="z.B. Standardwoche A, Projektwoche">
                             </div>
                             <div class="form-group" style="flex-grow: 2;">
                                 <label for="template-description">Beschreibung (optional)</label>
                                 <input type="text" id="template-description" name="template-description" placeholder="Kurze Info, was diese Vorlage enth√§lt">
                                 <!-- Ersetzt Textarea durch Input f√ºr Einzeiligkeit -->
                             </div>
                             <div class="form-actions" style="margin-top: 0; margin-bottom: 0;">
                                 <button type="submit" class="btn btn-success">Aus Woche speichern</button>
                             </div>
                         </div>
                    </form>

                    <hr style="margin: 25px 0;">

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                         <h4>Bestehende Vorlagen</h4>
                         <button type="button" id="create-empty-template-btn" class="btn btn-primary btn-small">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zM2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/></svg>
                             Neue leere Vorlage
                         </button>
                    </div>

                    <div id="templates-list-container" style="max-height: 300px; overflow-y: auto;">
                         <!-- Liste wird per JS gef√ºllt -->
                         <p>Lade Vorlagen...</p>
                    </div>
                </div>

                <!-- Ansicht 2: Editor f√ºr eine neue/bestehende Vorlage (Initial hidden) -->
                <div id="template-editor-view" class="manage-templates-view" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                         <h4 id="template-editor-title">Leere Vorlage erstellen</h4>
                         <div>
                             <button type="button" id="back-to-template-list-btn" class="btn btn-secondary btn-small">Zur√ºck zur Liste</button>
                             <button type="button" id="save-template-editor-btn" class="btn btn-success btn-small">Vorlage speichern</button>
                         </div>
                    </div>
                    <!-- Vorlagen-Details (Name, Beschreibung) -->
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                         <div class="form-group" style="flex-grow: 1;">
                             <label for="template-editor-name">Vorlagenname*</label>
                             <input type="text" id="template-editor-name" required>
                         </div>
                         <div class="form-group" style="flex-grow: 2;">
                             <label for="template-editor-description">Beschreibung</label>
                             <input type="text" id="template-editor-description">
                         </div>
                    </div>

                    <p style="color: var(--color-text-muted); font-size: 0.9em; margin-top: 10px;">
                         Klicken Sie auf eine Zelle, um einen Eintrag hinzuzuf√ºgen/zu bearbeiten. Die Klasse wird beim Anwenden der Vorlage auf eine Klasse automatisch angepasst.
                         Wenn Sie die Vorlage auf einen Lehrer anwenden, wird die hier gew√§hlte Klasse verwendet (relevant f√ºr Vertretungen etc.).
                    </p>
                    <!-- Container f√ºr das simplifizierte Grid -->
                    <div id="template-editor-grid-container" style="margin-top: 15px; border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden;">
                         <!-- Grid wird hier per JS eingef√ºgt -->
                         <div class="loading-spinner"></div>
                    </div>
                </div>

            </div> <!-- Ende View Container -->

            <div class="modal-actions" style="margin-top: 25px;">
                <button type="button" class="btn btn-secondary" id="manage-templates-close-btn">Schlie√üen</button>
            </div>
        </div>
    </div>
    <!-- ENDE Modal zum Erstellen/Verwalten -->

    <!-- Modal zum Anwenden einer Vorlage -->
    <div id="apply-template-modal" class="modal-overlay">
        <!-- Inhalt bleibt unver√§ndert -->
        <div class="modal-box">
            <h2 id="apply-template-modal-title">Vorlage anwenden</h2>
            <form id="apply-template-form">
                 <p>W√§hle eine Vorlage aus, die auf die aktuell ausgew√§hlte Woche angewendet werden soll.</p>
                 <div class="form-group">
                     <label for="apply-template-select">Vorlage ausw√§hlen*</label>
                     <select id="apply-template-select" name="templateId" required>
                         <option value="">Lade Vorlagen...</option>
                         <!-- Optionen werden per JS gef√ºllt -->
                     </select>
                 </div>
                 <div class="modal-conflict-warning">
                     <strong>Achtung:</strong> Alle vorhandenen Stundenplan-Eintr√§ge f√ºr die ausgew√§hlte Klasse/Lehrer in der aktuellen Woche werden durch die Vorlage √ºberschrieben. Vertretungen bleiben unber√ºhrt.
                 </div>
                 <div class="modal-actions">
                     <button type="button" class="btn btn-secondary" id="apply-template-cancel-btn">Abbrechen</button>
                     <button type="submit" class="btn btn-primary" id="apply-template-confirm-btn">Vorlage anwenden & √úberschreiben</button>
                 </div>
            </form>
        </div>
    </div>
    <!-- ENDE Modal zum Anwenden -->

</div> <!-- End page-wrapper -->

<?php
// Include the footer partial
include_once dirname(__DIR__) . '/partials/footer.php';
?>

--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\planer\dashboard.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\pages\dashboard.php ---
<?php
// pages/dashboard.php
// KORRIGIERT: Alle Referenzen zum "Schwarzen Brett" (Tabs UND Inhalt)
// wurden aus dem 'lehrer'-Block entfernt.

include_once __DIR__ . '/partials/header.php';
// $today, $dayOfWeekName, $dateFormatted, $icalSubscriptionUrl werden vom Controller √ºbergeben
// $settings wird automatisch vom header.php geladen
$role = $_SESSION['user_role'] ?? 'guest'; // Rolle holen
?>

<div class="page-wrapper dashboard-wrapper">
    <h1 class="main-title">Mein Dashboard</h1>

    <nav class="tab-navigation">
        <button class="tab-button active" data-target="section-my-day">üóìÔ∏è Mein Tag</button>
        <button class="tab-button" data-target="section-weekly-plan">üìÖ Wochenplan</button>
        <button class="tab-button" data-target="section-announcements">üì¢ Ank√ºndigungen</button>
        
        <?php // NEU: Pr√ºfe, ob das Community Board global aktiviert ist ?>
        <?php if ($role === 'schueler' && $settings['community_board_enabled']): ?>
            <button class="tab-button" data-target="section-community-board">üì∞ Schwarzes Brett</button>
            <button class="tab-button" data-target="section-my-posts">‚úçÔ∏è Deine Beitr√§ge</button>
        <?php endif; ?>

        <?php if ($role === 'schueler' && !$settings['community_board_enabled']): // Nur wenn Sch√ºler, aber Board deaktiviert ?>
             <?php endif; ?>

        <?php if ($role === 'lehrer'): ?>
            <button class="tab-button" data-target="section-attendance">‚úÖ Anwesenheit</button>
            <button class="tab-button" data-target="section-events">üìö Aufgaben/Klausuren</button>
            <button class="tab-button" data-target="section-office-hours">üó£Ô∏è Sprechzeiten</button>
            <button class="tab-button" data-target="section-colleague-search">üßë‚Äçü§ù‚Äçüßë Kollegensuche</button>
            
            <?php // KORREKTUR: Der 'Schwarzes Brett'-Tab f√ºr Lehrer wurde hier entfernt (war Zeile 26-28). ?>
            
        <?php endif; ?>
    </nav>

    <div class="tab-content">

        <div class="dashboard-section active" id="section-my-day">
            <h2 class="section-title-hidden">Mein Tag <small>(<?php echo $dayOfWeekName . ', ' . $dateFormatted; ?>)</small></h2>
            <div id="today-schedule-container" class="today-schedule-container">
                <div class="loading-spinner small"></div>
            </div>
        </div>

        <div class="dashboard-section" id="section-weekly-plan">
            <section class="weekly-timetable-section" id="weekly-timetable-section-printable">
                <div class="dashboard-header">
                    <h2 class="section-title-hidden">Mein Wochenplan</h2>
                    <div class="plan-controls">
                        <div class="form-group">
                            <label for="year-selector">Jahr:</label>
                            <select id="year-selector"></select>
                        </div>
                        <div class="form-group">
                            <label for="week-selector">KW:</label>
                            <select id="week-selector"></select>
                        </div>
                        <div class="print-export-actions form-group">
                            <button id="export-pdf-btn" class="btn btn-primary" title="Als PDF exportieren">
                                PDF Export
                            </button>
                        </div>
                    </div>
                </div>

                <div id="plan-header-info" class="plan-header-info"></div>
                <div class="timetable-container" id="timetable-container">
                    <div class="loading-spinner"></div>
                </div>
            </section>
            
            <?php if (isset($icalSubscriptionUrl)): ?>
            <div class="ical-subscription-box" style="margin-top: 25px;">
                <label for="ical-url">Dein pers√∂nlicher Kalender-Feed:</label>
                <div class="input-group">
                    <input type="text" id="ical-url" value="<?php echo htmlspecialchars($icalSubscriptionUrl); ?>" readonly>
                    <button id="copy-ical-url" class="btn btn-secondary btn-small" title="Link kopieren">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M13 0H6a2 2 0 0 0-2 2 2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2 2 2 0 0 0 2-2V2a2 2 0 0 0-2-2Zm0 13a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v9ZM2 2a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v1H2V2Z"/>
                        </svg>
                    </button>
                </div>
                <small class="form-hint">F√ºge diese URL zu deiner Kalender-App hinzu (z.B. Google Kalender, Outlook, Apple Kalender), um deinen Stundenplan zu abonnieren.</small>
            </div>
            <?php endif; ?>
        </div>

        <div class="dashboard-section" id="section-announcements">
            <div id="announcements-list" class="sidebar-widget-content">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <?php if ($role === 'schueler' && $settings['community_board_enabled']): ?>
            <div class="dashboard-section" id="section-community-board">
                <h4>Digitales Schwarzes Brett</h4>
                <p class="form-hint" style="margin-bottom: 20px;">Informeller Feed f√ºr Fundsachen, AGs, Nachhilfe, etc. Beitr√§ge von Sch√ºlern werden vor der Ver√∂ffentlichung gepr√ºft.</p>

                <form id="community-post-form" class="form-container" style="background-color: var(--color-surface-alt); padding: 15px; margin-bottom: 25px;">
                    <?php \App\Core\Security::csrfInput(); ?>
                    <h5>Neuen Beitrag erstellen</h5>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label for="post-title">Titel*</label>
                        <input type="text" id="post-title" name="title" required placeholder="z.B. Nachhilfe in Mathe gesucht">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="post-content">Inhalt*</label>
                        <textarea id="post-content" name="content" rows="4" required placeholder="Beschreibe dein Anliegen..."></textarea>
                        <small class="form-hint">Sie k√∂nnen <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">Markdown</a> f√ºr die Formatierung verwenden.</small>
                    </div>
                    <div class="form-actions" style="margin-top: 0; justify-content: flex-end;">
                        <button type="submit" class="btn btn-primary btn-small" id="create-post-btn" style="width: auto;">Beitrag einreichen</button>
                        <span id="post-create-spinner" class="loading-spinner small" style="display: none; margin-left: 10px;"></span>
                    </div>
                </form>

                <div id="community-posts-list" class="posts-list-container" style="max-height: 60vh; overflow-y: auto;">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <div class="dashboard-section" id="section-my-posts">
                <h4>Deine Beitr√§ge</h4>
                <p class="form-hint" style="margin-bottom: 20px;">Hier siehst du den Status deiner eingereichten Beitr√§ge und kannst sie bearbeiten. Bearbeitete Beitr√§ge werden erneut zur Moderation vorgelegt.</p>
                
                <div id="my-posts-list" class="posts-list-container my-posts-container" style="max-height: 60vh; overflow-y: auto;">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <?php endif; ?>


        <?php if ($role === 'lehrer'): ?>
            <div id="teacher-cockpit" style="display: contents;">
                <div class="dashboard-section" id="section-attendance">
                    <div class="cockpit-feature" id="attendance-feature">
                        <h4>Digitale Anwesenheit</h4>
                        <div id="attendance-current-lesson">
                            <div class="loading-spinner small"></div>
                        </div>
                        <div class="attendance-list-container" id="attendance-list-container" style="display: none;">
                            <div class="attendance-list-header">
                                <span>Sch√ºler/in</span>
                                <span>Status</span>
                            </div>
                            <ul id="attendance-student-list" class="attendance-student-list"></ul>
                            <div class="form-actions" style="margin-top: 15px;">
                                <button class="btn btn-primary" id="save-attendance-btn" style="width: 100%;">
                                    Anwesenheit speichern
                                </button>
                                <span id="attendance-save-spinner" class="loading-spinner small" style="display: none; margin-left: 10px;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section" id="section-events">
                    <div class="cockpit-feature" id="academic-events-feature">
                        <h4>Aufgaben & Klausuren verwalten</h4>
                        <form id="academic-event-form" class="form-container" style="background-color: var(--color-surface-alt); padding: 15px; margin-bottom: 20px;">
                            <?php \App\Core\Security::csrfInput(); ?>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="event-type">Typ*</label>
                                <select name="event_type" id="event-type" required>
                                    <option value="aufgabe">Aufgabe</option>
                                    <option value="klausur">Klausur / Test</option>
                                    <option value="info">Info</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="event-class-id">Klasse*</label>
                                <select name="class_id" id="event-class-id" required>
                                    <option value="">Lade Klassen...</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="event-subject-id">Fach (optional)</label>
                                <select name="subject_id" id="event-subject-id">
                                    <option value="">Kein Fach</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="event-title">Titel* (Kurzbeschreibung)</label>
                                <input type="text" name="title" id="event-title" required placeholder="z.B. Test: 1. Quartal, S. 42 lesen">
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="event-due-date">Datum* (F√§lligkeit/Termin)</label>
                                <input type="date" name="due_date" id="event-due-date" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="event-description">Beschreibung (optional)</label>
                                <textarea name="description" id="event-description" rows="2" placeholder="Weitere Details..."></textarea>
                            </div>
                            <div class="form-actions" style="margin-top: 0;">
                                <button type="submit" class="btn btn-primary btn-small" id="save-event-btn" style="width: auto;">Eintrag erstellen</button>
                                <span id="event-save-spinner" class="loading-spinner small" style="display: none;"></span>
                            </div>
                        </form>
                        
                        <h5>Meine Eintr√§ge (N√§chste 14 Tage):</h5>
                        <div class="event-list-container" id="teacher-event-list">
                            <div class="loading-spinner small"></div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section" id="section-office-hours">
                    <div class="cockpit-feature" id="office-hours-feature">
                        <h4>Sprechstunden verwalten</h4>
                        <p class="form-hint" style="margin-bottom: 15px; margin-top: 0;">Definieren Sie hier Ihre w√∂chentlich wiederkehrenden Zeitfenster, die Sch√ºler buchen k√∂nnen.</p>
                        <form id="office-hours-form" class="form-container" style="background-color: var(--color-surface-alt); padding: 15px; margin-bottom: 20px;">
                            <?php \App\Core\Security::csrfInput(); ?>
                            <div class="form-grid-col-3">
                                <div class="form-group">
                                    <label for="office-day">Wochentag*</label>
                                    <select name="day_of_week" id="office-day" required>
                                        <option value="1">Montag</option>
                                        <option value="2">Dienstag</option>
                                        <option value="3">Mittwoch</option>
                                        <option value="4">Donnerstag</option>
                                        <option value="5">Freitag</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="office-start-time">Von*</label>
                                    <input type="time" name="start_time" id="office-start-time" step="900" required>
                                </div>
                                <div class="form-group">
                                    <label for="office-end-time">Bis*</label>
                                    <input type="time" name="end_time" id="office-end-time" step="900" required>
                                </div>
                            </div>
                            <div class="form-group" style="max-width: 150px;">
                                <label for="office-slot-duration">Slot-Dauer (Min)*</label>
                                <input type="number" name="slot_duration" id="office-slot-duration" value="15" min="5" max="60" step="5" required>
                            </div>
                            <div class="form-actions" style="margin-top: 0;">
                                <button type="submit" class="btn btn-primary btn-small" id="save-office-hours-btn" style="width: auto;">Fenster hinzuf√ºgen</button>
                                <span id="office-hours-save-spinner" class="loading-spinner small" style="display: none;"></span>
                            </div>
                        </form>
                        <h5>Meine Sprechzeitenfenster:</h5>
                        <div class="office-hours-list-container" id="teacher-office-hours-list">
                            <div class="loading-spinner small"></div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section" id="section-colleague-search">
                    <div class="cockpit-feature" id="find-colleague-feature">
                        <h4>Wo ist...? (Kollegensuche)</h4>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="colleague-search-input">Kollege/Kollegin suchen:</label>
                            <input type="text" id="colleague-search-input" placeholder="Name oder K√ºrzel suchen...">
                            <div class="search-results-dropdown" id="colleague-search-results">
                            </div>
                        </div>
                        <div class="search-result-display" id="colleague-result-display" style="display: none;">
                            <div class="loading-spinner small" style="display: none;"></div>
                            <p></p>
                        </div>
                    </div>
                </div>
                
                <?php // KORREKTUR: Der 'Schwarzes Brett'-INHALT f√ºr Lehrer wurde hier entfernt (war Zeile 247-279). ?>
                
            </div> <?php // End #teacher-cockpit ?>
        <?php endif; ?>
        
    </div> <?php // End .tab-content ?>
</div> <?php // End .page-wrapper ?>


<?php // --- Modal f√ºr Stundenplan-Details (GILT F√úR ALLE) --- ?>
<div id="plan-detail-modal" class="modal-overlay">
    <div class="modal-box small-modal">
        <h2 id="plan-detail-title">Stunden-Details</h2>
        <div class="plan-detail-content">
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span id="detail-status" class="detail-value"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Zeit:</span>
                <span id="detail-time" class="detail-value"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Fach:</span>
                <span id="detail-subject" class="detail-value"></span>
            </div>
            
            <?php // Dynamisch anzeigen, je nach Rolle ?>
            <?php if ($role === 'schueler'): ?>
            <div class="detail-row">
                <span class="detail-label">Lehrer:</span>
                <span id="detail-teacher" class="detail-value"></span>
            </div>
            <?php elseif ($role === 'lehrer'): ?>
             <div class="detail-row">
                <span class="detail-label">Klasse:</span>
                <span id="detail-class" class="detail-value"></span>
            </div>
            <?php endif; ?>
            
            <div class="detail-row">
                <span class="detail-label">Raum:</span>
                <span id="detail-room" class="detail-value"></span>
            </div>
            <div class="detail-row detail-comment" id="detail-comment-row" style="display: none;">
                <span class="detail-label">Kommentar:</span>
                <span id="detail-comment" class="detail-value"></span>
            </div>
            
            <?php // --- NEU: Platzhalter f√ºr Notizen (nur f√ºr Sch√ºler) --- ?>
            <?php if ($role === 'schueler'): ?>
            <div class_alias="detail-row detail-notes" id="detail-notes-row" style="display: none; flex-direction: column; align-items: stretch; border-bottom: none; padding-bottom: 0;">
                <label for="detail-notes-input" class="detail-label" style="margin-bottom: 8px;">Meine private Notiz:</label>
                <textarea id="detail-notes-input" rows="3" placeholder="Notiz hinzuf√ºgen (z.B. Hausaufgaben, Material)..."></textarea>
                <span id="note-save-spinner" class="loading-spinner small" style="display: none; margin-top: 5px;"></span>
            </div>
            <?php endif; ?>
            
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
            <button type="button" class="btn btn-secondary" id="plan-detail-close-btn">Schlie√üen</button>
            <?php // --- NEU: Notiz-Speichern-Button (nur f√ºr Sch√ºler) --- ?>
            <?php if ($role === 'schueler'): ?>
            <button type="button" class="btn btn-primary" id="plan-detail-save-note-btn">Notiz speichern</button>
            <?php endif; ?>
        </div>
    </div>
</div>
<?php // --- ENDE Modal --- ?>


<?php // --- NEU: Modal f√ºr "Meine Beitr√§ge" (Bearbeiten) --- ?>
<?php if ($role === 'schueler' && $settings['community_board_enabled']): ?>
<div id="my-post-edit-modal" class="modal-overlay">
    <div class="modal-box">
        <button type="button" class="modal-close-btn" id="my-post-edit-close-btn">&times;</button>
        <h2 id="my-post-edit-title">Beitrag bearbeiten</h2>
        <form id="my-post-edit-form" class="form-container" style="padding: 0; border: none; background: none; box-shadow: none;">
            <input type="hidden" name="post_id" id="edit-post-id">
            
            <div class="form-group" style="margin-bottom: 10px;">
                <label for="edit-post-title">Titel*</label>
                <input type="text" id="edit-post-title" name="title" required>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="edit-post-content">Inhalt*</label>
                <textarea id="edit-post-content" name="content" rows="6" required></textarea>
                <small class="form-hint">Der Beitrag wird nach dem Speichern erneut zur Moderation vorgelegt.</small>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="my-post-edit-cancel-btn">Abbrechen</button>
                <button type="submit" class="btn btn-primary" id="my-post-edit-save-btn">Speichern & Einreichen</button>
                <span id="my-post-edit-spinner" class="loading-spinner small" style="display: none; margin-left: 10px;"></span>
            </div>
        </form>
    </div>
</div>
<?php endif; ?>
<?php // --- ENDE Modal --- ?>


<?php
include_once __DIR__ . '/partials/footer.php';
?>
--- END FILE: C:\xampp\htdocs\files\PAUSE\pages\dashboard.php ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\base\_globals.css ---
body {
    background-color: var(--color-background);
    color: var(--color-text);
    font-family: var(--font-body);
    margin: 0;
    padding-top: 80px; /* Platz f√ºr den fixierten Header */
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 80px);
}

.main-title {
    color: var(--color-primary);
    font-family: var(--font-display);
}

a {
    color: var(--color-primary);
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\base\_globals.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\base\_print.css ---
@media print {
    body {
        padding-top: 0 !important;
        background-color: #fff !important; /* Force white background */
        color: #000 !important; /* Force black text */
        font-size: 7pt !important; /* FURTHER REDUCED base font size */
        line-height: 1.1 !important; /* FURTHER TIGHTENED line height */
        -webkit-print-color-adjust: exact !important; /* Ensure background/colors print */
        print-color-adjust: exact !important;
    }

    /* Hide non-printable elements */
    .page-header,
    .site-footer,
    .dashboard-sidebar-content, /* Student/Teacher sidebar */
    .planer-header,
    .bulk-actions-controls,
    .print-export-actions, /* Hide the print/pdf buttons themselves */
    .modal-overlay,
    .toast-notification,
    .ical-subscription-box,
    .my-day-section, /* Hide "Mein Tag" section */
    .section-divider,
    #imprint-details {
        display: none !important;
        visibility: hidden !important;
    }

    /* Adjust main content area */
    .page-wrapper {
        max-width: none !important;
        padding: 5mm !important; /* Keep reduced margin */
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
    }
    .dashboard-container,
    .dashboard-main-content,
    .dashboard-section,
    .timetable-container {
        display: block !important; /* Override grid/flex */
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        background-color: transparent !important;
    }

    /* Title before the timetable */
    .dashboard-header .section-title, /* Keep title */
    #plan-header-info { /* Keep subtitle */
        display: block !important;
        text-align: center !important;
        margin-bottom: 3mm !important; /* Slightly reduced margin */
        border-bottom: none !important;
        padding-bottom: 0 !important;
        font-size: 10pt !important; /* FURTHER REDUCED font size */
        color: #000 !important;
        page-break-after: avoid; /* Prevent break after header */
    }
     .dashboard-header .plan-controls {
         display: none !important; /* Hide week selectors in print */
     }

    /* Style the timetable grid for print */
    .timetable-grid {
        display: grid !important;
        grid-template-columns: 40px repeat(5, 1fr) !important; /* FURTHER REDUCED time column width */
        grid-auto-rows: minmax(18mm, auto); /* ADDED: Try to constrain row height */
        gap: 0.5px !important; /* Keep reduced lines */
        border: 0.5px solid #aaa !important; /* Keep thinner border */
        background-color: #aaa !important;
        overflow: hidden !important; /* CHANGE: Hide overflow instead of visible */
        page-break-inside: avoid !important; /* *** CRITICAL: Try to keep table on one page *** */
    }

    .grid-header,
    .grid-cell {
        padding: 1px !important; /* FURTHER REDUCED padding */
        border: none !important; /* Borders handled by grid gap */
        background-color: #fff !important;
        color: #000 !important;
        font-size: 6pt !important; /* FURTHER REDUCED font size */
        line-height: 1.0 !important; /* FURTHER TIGHTENED line height */
        overflow: hidden !important; /* *** Ensure content clipping *** */
        page-break-inside: avoid !important; /* Prevent breaks inside cells */
        word-wrap: break-word; /* Allow text wrapping */
        display: flex; /* ADDED: Use flex for better vertical alignment */
        flex-direction: column; /* ADDED: Stack content vertically */
        justify-content: center; /* ADDED: Center content vertically */
    }

    .grid-header {
        font-weight: bold;
        background-color: #f0f0f0 !important; /* Slightly lighter gray */
    }
    .grid-header.period-header {
        font-size: 5pt !important; /* FURTHER REDUCED font size */
        white-space: normal; /* Allow time to wrap if needed */
        text-align: center;
        padding: 1px 0 !important; /* Minimal vertical padding */
    }

    .cell-entry {
        background-color: transparent !important;
        border: none !important;
        padding: 0 !important; /* No padding needed within flex */
        font-size: inherit !important;
        color: inherit !important;
        text-decoration: none !important; /* Remove strikethrough for Entfall */
        opacity: 1 !important;
        height: auto !important;
        min-height: 0 !important;
        /* align-items: center !important; */ /* Controlled by parent flex */
        display: block !important; /* Allow content to flow naturally */
        text-align: center;
        overflow: hidden; /* Hide overflow within the entry itself */
    }

    .grid-cell strong { font-size: 6pt !important; font-weight: bold !important; display: block; margin-bottom: 0px; line-height: 1.1; }
    .grid-cell span { font-size: 5pt !important; color: #333 !important; display: block; line-height: 1.1; }
    .grid-cell small { font-size: 4pt !important; color: #555 !important; display: block; white-space: normal; line-height: 1.1; } /* Allow comments to wrap */
    .grid-cell small.entry-comment { font-style: italic; }

    /* Remove specific background colors, keep borders */
    .grid-cell.substitution-Vertretung,
    .grid-cell.substitution-Raum√§nderung,
    .grid-cell.substitution-Sonderevent,
    .grid-cell.substitution-Entfall {
        background-color: #fff !important;
        border-left-width: 2px !important; /* THINNER left border */
        border-left-style: solid !important;
        padding-left: 1px !important; /* Adjust padding slightly */
    }
    .grid-cell.substitution-Vertretung { border-left-color: #dc3545 !important; }
    .grid-cell.substitution-Raum√§nderung { border-left-color: #ffc107 !important; }
    .grid-cell.substitution-Sonderevent { border-left-color: #0d6efd !important; }
    .grid-cell.substitution-Entfall { border-left-color: #6c757d !important; }

    /* Add "Entf√§llt" text again, since strikethrough is removed */
     .grid-cell.substitution-Entfall .cell-entry strong::before { /* Add before subject */
         content: "Entf√§llt: ";
         font-weight: bold;
         color: #6c757d;
     }
     /* Hide other details for cancellation */
     .grid-cell.substitution-Entfall .cell-entry span,
     .grid-cell.substitution-Entfall .cell-entry small.entry-room {
          display: none;
     }


    /* Hide empty cell content placeholder (like FU) if not needed */
    .grid-cell.default-entry .cell-entry {
        display: none; /* Hide FU text */
    }
    /* Make empty cells visually smaller if needed */
    .grid-cell.empty {
        background-color: #fdfdfd !important; /* Slightly off-white */
        min-height: 1.5em; /* Set a minimal height */
        padding: 0 !important; /* Remove padding */
    }


     /* Ensure links are printed (optional) */
     a[href^="http"]::after {
         /* content: " (" attr(href) ")"; */ /* Uncomment to print URLs */
         font-size: 5pt;
         color: #555;
     }

     /* Avoid page breaks inside cells or headers - already set above */
     /* .grid-header, .grid-cell, .cell-entry { page-break-inside: avoid; } */

     /* Add a title at the top of the printed page */
     @page {
         margin: 8mm !important; /* FURTHER REDUCED margins */
         size: A4 landscape !important; /* Ensure landscape */
     }

     /* Add print info header - needs JS to update content dynamically */
     #print-header-info {
         display: block !important;
         text-align: center;
         margin-bottom: 3mm; /* Keep reduced margin */
         font-weight: bold;
         font-size: 10pt !important; /* Keep reduced font size */
         page-break-after: avoid;
     }

} /* End @media print */

/* Specific styles for the Print/Export buttons container */
.print-export-actions {
    display: flex;
    gap: 10px;
    align-items: flex-end; /* Align with other controls */
    margin-left: auto; /* Push to the right in planer dashboard */
}
.print-export-actions .btn-small {
    padding: 6px 12px;
    font-size: 0.85rem;
    height: 38px; /* Match other control heights */
    width: auto;
    display: inline-flex;
    gap: 6px;
    align-items: center;
    background-color: #f8f9fa;
    color: var(--color-text);
    border: 1px solid var(--color-border);
    margin-bottom: 0;
}
.print-export-actions .btn-small:hover {
    background-color: #e9ecef;
    color: var(--color-primary);
}
.dark-mode .print-export-actions .btn-small {
    background-color: var(--color-surface-alt);
    color: var(--color-text);
    border-color: var(--color-border);
}
.dark-mode .print-export-actions .btn-small:hover {
    background-color: #343a40;
    color: var(--color-primary);
}
.print-export-actions .btn-small svg {
    margin-top: -2px; /* Visual alignment */
}

/* Hide print/export for Admin */
body.role-admin .print-export-actions {
    display: none !important;
}


--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\base\_print.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\base\_variables.css ---
:root {
    /* Farben aus dem Theater-Projekt √ºbernommen */
    --color-primary: #390099;   /* Duke Blue */
    --color-secondary: #9e0059;  /* Murrey */
    --color-danger: #ff0054;    /* Folly */
    --color-success: #28a745;    /* Strahlendes Gr√ºn f√ºr Erfolg */
    --color-warning: #ffbd00;    /* Amber */

    /* Schriftarten aus dem Theater-Projekt √ºbernommen */
    --font-display: 'Oswald', sans-serif;
    --font-body: 'Inter', sans-serif;

    /* Allgemeine Farben - Light Mode (Default) */
    --color-background: #f4f7f6; /* Leicht k√ºhles Grau */
    --color-surface: #ffffff; /* Wei√üer Hintergrund f√ºr Karten etc. */
    --color-surface-alt: #f8f9fa; /* Alternativer, leicht grauer Hintergrund */
    --color-text: #212529; /* Dunkles Grau f√ºr Text */
    --color-text-muted: #6c757d; /* Helleres Grau f√ºr sekund√§ren Text */
    --color-border: #dee2e6; /* Heller Rand */
}

/* Dark Mode Farben */
.dark-mode {
    --color-primary: #a972ff; /* Helleres Lila f√ºr Dark Mode */
    --color-secondary: #f07167; /* Angepasstes Rot/Orange */
    --color-danger: #f85149;
    --color-success: #3fb950;
    --color-warning: #ffca2c; /* Etwas helleres Gelb */

    --color-background: #0d1117; /* GitHub Dark - Sehr dunkel */
    --color-surface: #161b22; /* GitHub Dark - Etwas heller f√ºr Karten */
    --color-surface-alt: #21262d; /* Alternativer Dark Surface */
    --color-text: #e6edf3; /* Heller Text */
    --color-text-muted: #8b949e; /* Ged√§mpfter Text */
    --color-border: #30363d; /* Dunkler Rand */
}

/* Ensure body background uses the variable */
body {
    background-color: var(--color-background);
    color: var(--color-text);
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\base\_variables.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_buttons.css ---
.btn {
    position: relative;
    overflow: hidden;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    color: white;
    padding: 15px 20px;
    margin-bottom: 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    transition: background-color 0.3s;
    width: 100%;
    box-sizing: border-box;
    min-height: 44px;
}

.btn:last-child {
    margin-bottom: 0;
}

.btn-primary {
    background-color: var(--color-primary);
    color: white;
}
.btn-primary:hover {
    background-color: #2d007a;
}

.btn-success {
    background-color: var(--color-success);
}
.btn-success:hover {
    background-color: #218838;
}

.btn-warning {
    background-color: var(--color-warning);
    color: #333;
}
.btn-warning:hover {
    background-color: #e6ac00;
}

.btn-danger {
    background-color: var(--color-danger);
}
.btn-danger:hover {
    background-color: #d60047;
}

.btn-secondary {
    background-color: var(--color-secondary);
}
.btn-secondary:hover {
    background-color: #84004a;
}


--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_buttons.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_form-elements.css ---
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

/* Gemeinsame Stile f√ºr alle Formular-Eingabefelder */
input[type="text"],
input[type="password"],
input[type="email"],
input[type="date"],
input[type="number"],
select,
textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-sizing: border-box;
    background-color: var(--color-surface);
    color: var(--color-text);
    font-family: var(--font-body);
    font-size: 1rem;
    min-height: 44px; /* Einheitliche Mindesth√∂he */
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

textarea {
    min-height: 120px;
    resize: vertical;
}


input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(57, 0, 153, 0.15);
}


/* Spezifisches Styling f√ºr Select-Elemente, um den Pfeil anzupassen */
select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px; /* Platz f√ºr den Pfeil */
}

.form-actions {
    margin-top: 30px;
    display: flex;
    gap: 10px;
}

.form-hint {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    display: block;
    margin-top: 5px;
}

/* Styling f√ºr Checkbox-Container */
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: normal; /* Normale Schriftst√§rke f√ºr den Label-Text */
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 8px;
}
.dark-mode .checkbox-label {
    background-color: #21262d;
}

.checkbox-label input[type="checkbox"] {
    width: 1.2em; /* Gr√∂√üe der Checkbox */
    height: 1.2em;
    margin: 0;
    flex-shrink: 0;
}

--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_form-elements.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_messages.css ---
/* Generelle Nachrichtenboxen */
.message {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    text-align: center;
    border: 1px solid transparent;
}

.message.error {
    background-color: #f8d7da;
    color: var(--color-danger);
    border-color: #f5c6cb;
}
.message.info {
    background-color: #cce5ff;
    color: #004085;
    border-color: #b8daff;
}

/* Toast-Benachrichtigungen */
.toast-notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translate(-50%, 100px);
    padding: 15px 25px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 2000;
    transition: transform 0.4s ease-in-out;
    opacity: 0;
}
.toast-notification.visible {
    transform: translate(-50%, 0);
    opacity: 1;
}
.toast-notification.toast-success { background-color: var(--color-success); }
.toast-notification.toast-error { background-color: var(--color-danger); }
.toast-notification.toast-info { background-color: var(--color-primary); }

/* Best√§tigungsdialog */
.confirm-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    z-index: 1999;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.confirm-overlay.visible {
    opacity: 1;
}
.confirm-box {
    background: var(--color-surface);
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    text-align: center;
}
.confirm-box h2 { margin-top: 0; }
.confirm-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
}

/* NEU: Buttons im Best√§tigungsdialog gleich gro√ü machen */
.confirm-actions .btn {
    flex-grow: 1; /* Erlaubt Wachstum */
    flex-basis: 0; /* Sorgt f√ºr gleichm√§√üige Verteilung */
    width: 0; /* Unterst√ºtzt flex-basis */
    margin-bottom: 0; /* Kein Margin in Flexbox */
}

--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_messages.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_mobile_menu.css ---
/* public/assets/css/components/_mobile_menu.css */

/* === Mobile Menu Toggle Button (Hamburger) === */

.mobile-menu-toggle {
    display: block; /* Hidden on desktop via media query */
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 10px;
    margin: -10px; /* Offset padding to align visually */
    z-index: 1002; /* Above the overlay nav */
}

.hamburger-box {
    width: 30px;
    height: 24px;
    display: inline-block;
    position: relative;
}

.hamburger-inner,
.hamburger-inner::before,
.hamburger-inner::after {
    width: 100%;
    height: 3px;
    background-color: #fff; /* White lines */
    border-radius: 4px;
    position: absolute;
    transition-property: transform;
    transition-duration: 0.15s;
    transition-timing-function: ease;
}

.hamburger-inner::before,
.hamburger-inner::after {
    content: "";
    display: block;
    /* Adjusted transition for a smoother animation */
    transition: top 0.1s 0.15s ease-in, bottom 0.1s 0.15s ease-in, transform 0.15s cubic-bezier(0.55, 0.055, 0.675, 0.19), opacity 0s 0.15s;
}

.hamburger-inner {
    top: 50%;
    transform: translateY(-50%);
    /* Adjusted transition for middle bar */
    transition: background-color 0s 0.15s linear;
}

.hamburger-inner::before {
    top: -10px;
}

.hamburger-inner::after {
    bottom: -10px;
}

/* --- Hamburger Animation --- */
.mobile-menu-toggle.is-open .hamburger-inner {
    transform: rotate(225deg); /* Adjusted rotation */
    transition-delay: 0s;
    transition-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
    background-color: var(--color-warning); /* Change color on open */
}

.mobile-menu-toggle.is-open .hamburger-inner::before {
    top: 0;
    transform: rotate(-45deg); /* Rotate opposite */
    opacity: 0; /* Fade out */
    transition: top 0.1s ease-out, opacity 0.1s ease-out;
}

.mobile-menu-toggle.is-open .hamburger-inner::after {
    bottom: 0;
    transform: rotate(-90deg); /* Rotate to form X */
    transition: bottom 0.1s ease-out, transform 0.15s 0.15s cubic-bezier(0.215, 0.61, 0.355, 1);
}


/* Hide mobile toggle on larger screens */
@media (min-width: 769px) {
    .mobile-menu-toggle {
        display: none;
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_mobile_menu.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_theme_toggle.css ---
/* public/assets/css/components/_theme_toggle.css */

.theme-toggle {
    background: none;
    border: none;
    padding: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
    width: 34px; /* Fixed size */
    height: 34px;
}

.theme-toggle:hover {
    background-color: rgba(255, 255, 255, 0.15);
}

.theme-toggle img {
    width: 20px; /* Icon size */
    height: 20px;
    display: block;
}

/* Initially hide moon icon, show sun */
.theme-toggle .moon-icon {
    display: none;
}
.theme-toggle .sun-icon {
    display: block;
}

/* When dark mode is active, hide sun, show moon */
.dark-mode .theme-toggle .moon-icon {
    display: block;
}
.dark-mode .theme-toggle .sun-icon {
    display: none;
}

/* Add a separator only on desktop */
.nav-separator {
    display: none; /* Hidden by default / mobile */
}

@media (min-width: 769px) {
    .nav-separator {
        display: block;
        width: 1px;
        height: 20px;
        background-color: rgba(255, 255, 255, 0.2);
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_theme_toggle.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_user_menu.css ---
/* public/assets/css/components/_user_menu.css */

/* User Menu Styles (Primarily for Desktop) */

.user-menu {
    position: relative; /* Needed for absolute positioning of dropdown */
}

.user-menu-toggle {
    display: none; /* Hidden by default, shown on desktop */
    align-items: center;
    gap: 8px;
    background: none;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    color: #fff;
    font-weight: 600;
    padding: 5px; /* Add some padding for easier clicking */
    border-radius: 4px;
    transition: background-color 0.2s ease;
}
.user-menu-toggle:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.user-menu-toggle span {
    white-space: nowrap; /* Prevent username from wrapping */
}

.user-menu-toggle .chevron-down {
    transition: transform 0.2s ease-in-out;
    stroke: #fff; /* White chevron */
}

.user-menu-toggle[aria-expanded="true"] .chevron-down {
    transform: rotate(180deg);
}

.user-menu-dropdown {
    display: none; /* Hidden by default */
    position: absolute;
    flex-direction: column;
    align-items: stretch; /* Links take full width */
    gap: 0; /* No gap needed, padding on links */
    top: calc(100% + 10px); /* Position below the toggle */
    right: 0;
    background-color: #4a0072; /* Darker dropdown background */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    min-width: 200px; /* Minimum width */
    padding: 8px;
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
}

.user-menu-dropdown.is-open {
    display: flex; /* Show when open */
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.user-menu-dropdown a {
    color: rgba(255, 255, 255, 0.85);
    text-decoration: none;
    padding: 10px 15px; /* Consistent padding */
    border-radius: 5px;
    font-size: 0.95rem;
    font-weight: 500;
    transition: background-color 0.2s ease, color 0.2s ease;
    white-space: nowrap;
}

.user-menu-dropdown a:hover {
    background-color: var(--color-primary); /* Use primary color for hover */
    color: #ffffff;
    text-decoration: none;
}

.dropdown-divider {
    display: block;
    height: 1px;
    background-color: rgba(255, 255, 255, 0.15);
    margin: 8px 0; /* Add vertical margin */
}

/* Styles for Mobile Overlay */
@media (max-width: 768px) {
    .user-menu {
        width: 100%; /* Take full width in mobile overlay */
        display: flex; /* Needed for column layout */
        flex-direction: column;
        align-items: center;
    }
    .user-menu-toggle {
        display: none; /* Hide the button itself */
    }
    .user-menu-dropdown {
        display: flex; /* Always display in mobile overlay */
        position: static; /* Not absolute */
        background: none;
        border: none;
        box-shadow: none;
        width: 100%;
        padding: 0;
        opacity: 1;
        visibility: visible;
        transform: none;
        align-items: center; /* Center links */
        gap: 1.5rem; /* Same gap as other mobile links */
    }
    .user-menu-dropdown a {
        font-size: 1.2rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
        padding: 5px; /* Minimal padding for mobile */
    }
    .user-menu-dropdown a:hover {
        background: none; /* No background hover in mobile */
        color: var(--color-warning);
    }
    .dropdown-divider {
        display: none; /* Hide divider in mobile */
    }
}


/* Show desktop elements only on larger screens */
@media (min-width: 769px) {
    .user-menu-toggle {
        display: flex; /* Show toggle button on desktop */
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\components\_user_menu.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\layout\_footer.css ---
/* public/assets/css/layout/_footer.css */

.site-footer {
    background-color: #1a1a1a; /* Very dark background */
    color: #a0a0a0; /* Muted text color */
    padding: 30px 0;
    margin-top: auto; /* Pushes footer to bottom */
    font-size: 0.9rem;
    line-height: 1.6;
}

.dark-mode .site-footer {
     background-color: #080808; /* Even darker for dark mode */
     color: #888;
}


.footer-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    max-width: 800px; /* Limit width for readability */
    margin: 0 auto;
    padding: 0 20px;
    text-align: center;
}

.copyright {
    opacity: 0.8;
}

.imprint {
    position: relative; /* For positioning the details */
}

.imprint-toggle {
    background: none;
    border: none;
    color: var(--color-primary); /* Use primary color */
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.9rem;
    padding: 5px;
    transition: color 0.2s ease;
}
.imprint-toggle:hover {
    color: var(--color-secondary); /* Use secondary color on hover */
    text-decoration: none;
}
.dark-mode .imprint-toggle {
     color: var(--color-primary); /* Use bright primary in dark mode */
}
.dark-mode .imprint-toggle:hover {
     color: var(--color-secondary);
}


.imprint-details {
    display: none; /* Hidden by default */
    position: fixed; /* Overlay effect */
    bottom: 0;
    left: 50%;
    transform: translateX(-50%) translateY(100%); /* Start below screen */
    width: 90%;
    max-width: 600px;
    max-height: 70vh; /* Limit height */
    overflow-y: auto;
    background-color: var(--color-surface);
    color: var(--color-text);
    padding: 30px;
    border-radius: 12px 12px 0 0; /* Rounded top corners */
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
    z-index: 1050; /* Above most content */
    text-align: left;
    transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); /* Smooth slide up */
}
.imprint-details.visible {
    transform: translateX(-50%) translateY(0); /* Slide into view */
    display: block;
}

.dark-mode .imprint-details {
     background-color: #1e1e1e; /* Slightly lighter dark surface */
     color: var(--color-text);
     box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
}


.imprint-details p {
    margin-bottom: 1rem;
}
.imprint-details strong {
    color: var(--color-primary);
}
.dark-mode .imprint-details strong {
    color: var(--color-primary);
}

.imprint-details a {
    color: var(--color-secondary);
    text-decoration: none;
}
.imprint-details a:hover {
    text-decoration: underline;
}

.imprint-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.8rem;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: 5px;
    line-height: 1;
}
.imprint-close:hover {
    color: var(--color-danger);
}


/* Responsive adjustments if needed */
@media (min-width: 769px) {
    .footer-content {
        flex-direction: row;
        justify-content: space-between;
        text-align: left;
    }
     .copyright {
         order: 1; /* Copyright first on desktop */
     }
     .imprint {
         order: 2;
     }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\layout\_footer.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\layout\_general.css ---
.page-wrapper {
    width: 100%;
    max-width: 1600px; /* Increased from 1200px */
    margin: 0 auto;
    padding: 20px;
    flex-grow: 1;
    box-sizing: border-box;
}

.container {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    margin: 20px auto;
    max-width: 500px;
}

.text-center {
    text-align: center;
}

.auth-container {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: 30px 40px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    margin: 40px auto;
    max-width: 400px;
    width: 90%;
}


--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\layout\_general.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\layout\_header.css ---
/* public/assets/css/layout/_header_new.css */

.page-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    padding: 10px 20px;
    box-sizing: border-box;
    z-index: 1002;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 60px; /* Ensure minimum height */

    /* --- Frosted Glass Effect --- */
    /* Updated background color to primary with opacity */
    background-color: rgba(57, 0, 153, 0.85); /* PAUSE primary color (#390099) with 85% opacity */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px); /* Safari */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border */
    /* --- End Effect --- */
}

.site-logo {
    font-size: 1.6rem;
    font-weight: bold;
    color: white;
    text-decoration: none;
    font-family: var(--font-display);
    transition: transform 0.3s ease;
    display: flex; /* NEU: F√ºr Bildausrichtung */
    align-items: center; /* NEU: F√ºr Bildausrichtung */
}
.site-logo:hover {
    transform: scale(1.03);
    text-decoration: none;
}

/* NEU: Styling f√ºr das Logo-Bild */
.site-logo-image {
    height: 40px; /* H√∂he begrenzen */
    width: auto; /* Breite automatisch anpassen */
    max-width: 150px; /* Maximale Breite, falls Logo sehr breit ist */
    margin-right: 10px; /* Abstand, falls Text folgt (obwohl wir nur Bild ODER Text haben) */
    object-fit: contain;
}


.page-header .header-link {
    color: #ffffff;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s ease;
    white-space: nowrap;
}
.page-header .header-link:hover {
    color: var(--color-warning);
    text-decoration: none;
}
.page-header .header-link.active {
    color: var(--color-warning);
    font-weight: 700;
}


/* === Mobile Navigation Styles (Default) === */

.header-nav {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(42, 0, 75, 0.95); /* Darker purple overlay, slightly transparent */
    backdrop-filter: blur(5px); /* Blur background behind overlay */
    -webkit-backdrop-filter: blur(5px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 1001;
}

.header-nav.is-open {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
}

/* Only nav-right is used in PAUSE */
.nav-left, .nav-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    width: 100%; /* Take full width in mobile overlay */
}

/* Style the right part (user menu / login) differently in mobile */
.nav-right {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(255,255,255,0.1);
    width: 80%;
    max-width: 300px;
}

.header-nav .header-link {
    font-size: 1.5rem; /* Larger font for mobile overlay links */
    font-family: var(--font-body);
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    padding: 10px;
}
.header-nav .header-link:hover {
    color: #fff;
}
.header-nav .header-link.active {
    color: var(--color-warning);
}


/* --- Desktop Navigation (Overrides) --- */
@media (min-width: 769px) {
    .page-header {
        padding: 10px 40px; /* More padding on desktop */
        min-height: 70px; /* Slightly taller header */
    }
    .site-logo {
        font-size: 1.8rem;
    }
    /* NEU: H√∂he des Logos im Desktop-Header anpassen */
    .site-logo-image {
        height: 50px; /* Etwas gr√∂√üer im Desktop-Header */
    }


    .header-nav {
        position: static;
        width: auto;
        height: auto;
        background: none;
        backdrop-filter: none; /* Remove filter for desktop nav container */
        -webkit-backdrop-filter: none;
        padding: 0;
        z-index: auto;
        border: none;
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        flex-direction: row;
        justify-content: flex-end; /* Align nav to the right */
        gap: 25px;
    }

    .nav-left, .nav-right {
        flex-direction: row;
        width: auto;
        gap: 25px;
        margin-top: 0;
        padding-top: 0;
        border-top: none;
        align-items: center; /* Align items vertically center */
    }

    .header-nav .header-link {
        font-size: 1rem;
        font-family: var(--font-body);
    }
}

/* Utility for visually hidden elements (used for screen readers) */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Prevent scrolling when mobile menu is open */
body.menu-open {
    overflow: hidden;
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\layout\_header.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\pages\_admin.css ---
/* public/assets/css/pages/_admin.css */

/* Stellt sicher, dass Admin-Seiten immer einen dunkleren, fokussierten Hintergrund haben */
body.admin-dashboard-body {
    background-color: #f4f7f9; /* Ein etwas k√ºhleres, professionelleres Grau */
}

.dark-mode body.admin-dashboard-body {
    background-color: #0d1117; /* GitHub-Dark Hintergrund */
}

.dashboard-grid {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 30px;
    align-items: start;
}

.dashboard-sidebar {
    position: sticky;
    top: 100px;
    background-color: var(--color-surface);
    border-radius: 12px; /* Weichere Ecken */
    padding: 20px;
    border: none;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.05);
}

.dashboard-sidebar h2 {
    font-size: 1.4rem;
    color: var(--color-text);
    margin-top: 0;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--color-border);
}

.dashboard-nav {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.dashboard-nav-item {
    display: block;
    padding: 12px 18px;
    text-decoration: none;
    color: #4a5568; /* Subtilerer Text */
    font-weight: 600;
    border-radius: 8px;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    position: relative;
}
.dark-mode .dashboard-nav-item {
    color: var(--color-text-muted);
}


.dashboard-nav-item:hover {
    background-color: #f1f5f9;
    color: var(--color-primary);
    transform: translateX(5px);
}
.dark-mode .dashboard-nav-item:hover {
    background-color: #ffffff0d;
    color: #fff;
}

.dashboard-nav-item.active {
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    color: white;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(158, 0, 89, 0.2);
}
.dark-mode .dashboard-nav-item.active {
    box-shadow: 0 4px 15px rgba(169, 114, 255, 0.2);
}


.dashboard-content {
    background-color: var(--color-surface);
    border-radius: 12px;
    padding: 0; /* No padding on container, handled by sections */
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    border: none;
}

/* --- TAB NAVIGATION (√úBERARBEITET) --- */
.tab-navigation {
    display: flex;
    background-color: #f8f9fa; /* Hellerer Hintergrund f√ºr die Navigationsleiste */
    padding: 0 20px;
    border-bottom: 1px solid var(--color-border);
}
.dark-mode .tab-navigation {
    background-color: #161b22;
}

.tab-button {
    padding: 15px 25px;
    font-weight: 600;
    font-size: 1rem;
    border: none;
    border-bottom: 3px solid transparent; /* Wichtig f√ºr den Hover/Aktiv-Effekt */
    background-color: transparent;
    cursor: pointer;
    color: #6c757d; /* Inaktive Tabs sind grau */
    transition: all 0.2s ease-in-out;
    position: relative;
    top: 1px;
}
.dark-mode .tab-button {
    color: var(--color-text-muted);
}

.tab-button:hover {
    color: var(--color-primary);
    border-bottom-color: #d1d5db; /* Leichter Indikator bei Hover */
}
.dark-mode .tab-button:hover {
    color: #fff;
    border-bottom-color: #444;
}

.tab-button.active {
    color: var(--color-primary);
    font-weight: 700;
    border-bottom-color: var(--color-primary); /* Klarer Indikator f√ºr den aktiven Tab */
}
.dark-mode .tab-button.active {
    color: #fff;
    border-bottom-color: var(--color-primary);
}


/* --- TAB CONTENT --- */
.tab-content .dashboard-section,
.dashboard-content > .dashboard-section { /* Added rule for non-tabbed content */
    display: none; /* Hide sections by default */
    padding: 25px 30px;
    animation: fadeIn 0.4s ease;
}
.tab-content .dashboard-section.active,
.dashboard-content > .dashboard-section.active { /* Added rule for non-tabbed content */
    display: block; /* Show active section */
}

/* Speziell f√ºr das Admin-Dashboard (das keine Tabs hat) */
#admin-dashboard-overview {
    display: block; /* Immer anzeigen */
    padding: 15px; /* Reduziertes Padding f√ºr Widget-Container */
}


@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.dashboard-content h3 {
    font-size: 1.8rem;
    margin-top: 0;
    margin-bottom: 25px;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 15px;
}
/* Section Header specifically for non-tabbed content like user management */
.dashboard-content .section-header h3 {
     margin-bottom: 5px; /* Less margin if it's just a header */
     padding-bottom: 10px;
}
.dashboard-content .section-header small {
    display: block;
    margin-bottom: 20px;
    color: var(--color-text-muted);
    font-size: 0.9rem;
}


.dashboard-content p {
    margin-top: 0;
    margin-bottom: 30px;
    color: var(--color-text-muted);
}
.dashboard-content h4 {
    font-size: 1.3rem;
    margin-bottom: 20px;
}

/* Standard Layout: Formular unter der Tabelle */
.form-container {
    background-color: #f8f9fa;
    padding: 25px;
    border-radius: 8px;
    border: 1px solid var(--color-border);
    margin-top: 30px; /* Add margin *above* the form */
    margin-bottom: 0; /* Remove bottom margin if it was there */
}
.dark-mode .form-container {
    background-color: var(--color-background);
}


.table-responsive { overflow-x: auto; }
.data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.data-table th, .data-table td { padding: 12px 15px; border-bottom: 1px solid var(--color-border); text-align: left; vertical-align: middle; } /* Vertikal zentrieren */
.data-table th { background-color: transparent; font-weight: 600; font-size: 0.9rem; color: var(--color-text-muted); }
.data-table tbody tr:nth-child(even) { background-color: #fcfdff; }
.dark-mode .data-table tbody tr:nth-child(even) { background-color: #ffffff05; }
.data-table tbody tr:hover { background-color: #f1f5f9; }
.dark-mode .data-table tbody tr:hover { background-color: #ffffff0d; }

.data-table .actions {
    display: flex;
    gap: 8px;
    align-items: center;
}
.data-table .actions .btn-small {
    padding: 5px 10px;
    font-size: 0.8rem;
    width: auto;
    border-radius: 5px;
    flex-grow: 1;
    flex-basis: 0;
    text-align: center;
    margin-bottom: 0;
}


/* Responsive Anpassungen */
@media (max-width: 992px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    .dashboard-sidebar {
        position: static;
    }
    .tab-navigation {
        overflow-x: auto;
    }
}

/* User Management Form Specifics */
.form-grid-col-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive Spalten */
    gap: 15px;
}

/* Announcements Admin Form Specifics */
#announcement-form textarea {
    min-height: 120px;
    font-family: inherit;
    font-size: 1rem;
    padding: 10px 12px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-sizing: border-box;
    background-color: var(--color-surface);
    color: var(--color-text);
    width: 100%;
}
#announcement-form textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(57, 0, 153, 0.15);
}

/* File Attachment Display */
#current-attachment-info a {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
}
#current-attachment-info a:hover {
    text-decoration: underline;
}
#current-attachment-info label {
    font-weight: normal;
    margin-left: 5px; /* Spacing for checkbox */
    cursor: pointer;
}


/* KORRIGIERT: Speichern/Abbrechen Buttons im User/Announcement-Formular gleich breit UND HOCH */
#user-form .form-actions,
#announcement-form .form-actions {
    justify-content: flex-end; /* Buttons rechts ausrichten */
}
#user-form .form-actions .btn-secondary,
#user-form .form-actions .btn-primary,
#announcement-form .form-actions .btn-secondary,
#announcement-form .form-actions .btn-primary {
    flex-grow: 1;
    flex-basis: 0;
    width: 0;
    height: 44px;
    padding-top: 0;
    padding-bottom: 0;
}
#user-form .form-actions .btn-danger,
#announcement-form .form-actions .btn-danger { /* Falls L√∂schen-Button im Formular ist */
    flex-grow: 0;
    width: auto;
}

/* --- NEU: STILE F√úR COMMUNITY-MODERATION --- */

/* Verwendet das gleiche Card-Design wie Ank√ºndigungen */
.posts-list-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 5px; /* Kleines Padding, damit Schatten sichtbar sind */
}

.community-post-item {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    transition: box-shadow 0.2s ease;
}
.community-post-item:hover {
     box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.dark-mode .community-post-item {
    background-color: var(--color-surface-alt);
}


.post-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
}
.post-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--color-primary);
}
.post-meta {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    text-align: right;
    flex-shrink: 0;
    line-height: 1.5;
}

.post-content-preview {
    padding: 20px;
    font-size: 0.95rem;
    line-height: 1.6;
}
/* Styling f√ºr Markdown-Inhalt (√§hnlich wie Ank√ºndigungen) */
.post-content-preview p:first-child { margin-top: 0; }
.post-content-preview p:last-child { margin-bottom: 0; }
.post-content-preview ul, .post-content-preview ol { padding-left: 1.5em; margin-bottom: 1em; }
.post-content-preview a { color: var(--color-primary); }

.moderation-actions {
    padding: 15px 20px;
    background-color: #f8f9fa;
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-radius: 0 0 7px 7px;
}
.dark-mode .moderation-actions {
     background-color: var(--color-background);
}

.moderation-actions .btn-small {
    width: auto;
    flex-grow: 0;
    margin-bottom: 0;
}

/* --- ENDE COMMUNITY-MODERATION --- */


/* --- NEU: STILE F√úR SETTINGS-SEITE --- */
/* ... (Stile von settings.php bleiben unver√§ndert) ... */
.settings-section.form-container {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: 25px;
    margin-top: 0; 
    margin-bottom: 25px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
}
.dark-mode .settings-section.form-container {
    background-color: var(--color-surface-alt);
    border-color: var(--color-border);
}
#settings-management .form-container:not(.settings-section) {
    padding: 0; margin: 0; background: transparent; border: none; box-shadow: none;
}
.setting-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
    padding: 25px 0; border-bottom: 1px solid var(--color-border); align-items: center;
}
.setting-row:first-of-type { padding-top: 10px; }
.setting-row:last-of-type { border-bottom: none; padding-bottom: 10px; }
.setting-info label { font-size: 1.1rem; font-weight: 600; color: var(--color-text); }
.setting-info p { font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 0; line-height: 1.5; }
.setting-control { display: flex; align-items: center; gap: 15px; }
.setting-control input[type="text"],
.setting-control input[type="number"],
.setting-control textarea,
.setting-control select {
    max-width: 450px; margin-bottom: 0; width: 100%;
}
.setting-control.file-upload-control { flex-direction: column; align-items: flex-start; gap: 10px; }
.setting-control input[type="file"] { width: 100%; max-width: 450px; }
.file-preview { font-size: 0.9rem; color: var(--color-text-muted); display: flex; align-items: center; gap: 10px; min-height: 30px; }
.file-preview img.logo-preview { max-height: 40px; width: auto; border: 1px solid var(--color-border); border-radius: 4px; background: #f8f9fa; }
.dark-mode .file-preview img.logo-preview { background: #30363d; }
.file-preview img.favicon-preview { height: 24px; width: 24px; border: 1px solid var(--color-border); border-radius: 4px; background: #f8f9fa; }
.dark-mode .file-preview img.favicon-preview { background: #30363d; }
.remove-file-label { font-size: 0.8rem; color: var(--color-danger); cursor: pointer; font-weight: 600; }
.remove-file-label input { margin-right: 4px; }
.toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.dark-mode .slider { background-color: #30363d; }
.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--color-success); }
.dark-mode input:checked + .slider { background-color: var(--color-success); }
input:checked + .slider:before { transform: translateX(26px); }
.toggle-status { font-weight: 600; font-size: 0.9rem; color: var(--color-text-muted); transition: color 0.4s; }
input:checked ~ .toggle-status { color: var(--color-success); }
@media (max-width: 768px) {
    .setting-row { grid-template-columns: 1fr; gap: 15px; }
    .setting-control input[type="text"],
    .setting-control input[type="number"],
    .setting-control textarea,
    .setting-control select { max-width: 100%; }
}

/* --- NEU: Admin Dashboard Widgets --- */
.dashboard-widget-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-top: 15px;
    padding: 10px;
}
.dashboard-widget {
    background-color: var(--color-surface);
    border-radius: 10px;
    padding: 20px 25px; 
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
    border: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    position: relative; 
    user-select: none;
}
.dark-mode .dashboard-widget {
    background-color: var(--color-surface-alt);
}
.dashboard-widget[draggable="true"] { cursor: move; }
.dashboard-widget h3, .dashboard-widget p, .dashboard-widget .stat-list, .dashboard-widget .system-info-list, .dashboard-widget .activity-list, .dashboard-widget .btn, .dashboard-widget .toggle-switch, .dashboard-widget a {
    cursor: auto; user-select: text;
}
.dashboard-widget .slider { cursor: pointer; }
.dashboard-widget.dragging { opacity: 0.5; transform: scale(0.98); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.widget-placeholder {
    background: rgba(57, 0, 153, 0.05); border: 2px dashed var(--color-primary);
    border-radius: 10px; margin: 0; padding: 0; transition: height 0.1s ease-out; box-sizing: border-box;
}
.dark-mode .widget-placeholder { background: rgba(169, 114, 255, 0.1); border-color: var(--color-primary); }
.dashboard-widget h3 {
    font-size: 1.2rem; margin-top: 0; margin-bottom: 20px; padding-bottom: 15px;
    border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: 8px;
}
.widget-link { display: block; text-align: right; font-size: 0.85rem; font-weight: 600; margin-top: auto; color: var(--color-primary); }
.widget-link:hover { text-decoration: underline; }
.widget-stats .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 15px; margin-bottom: 10px; }
.widget-stats .stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 10px 5px; background-color: var(--color-surface-alt); border-radius: 8px; border: 1px solid var(--color-border); }
.dark-mode .widget-stats .stat-item { background-color: var(--color-surface); }
.widget-stats .stat-value { font-size: 2.2rem; font-weight: 700; font-family: var(--font-display); color: var(--color-primary); line-height: 1.1; }
.widget-stats .stat-label { font-size: 0.8rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.widget-stats .stat-item.main-stat { grid-column: 1 / -1; padding: 15px; background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
.widget-stats .stat-item.main-stat .stat-value { font-size: 2.8rem; color: white; }
.widget-stats .stat-item.main-stat .stat-label { color: rgba(255, 255, 255, 0.8); }
.widget-stats .stat-item.sub-stat .stat-value { font-size: 1.8rem; color: var(--color-secondary); }
.dark-mode .widget-stats .stat-item.sub-stat .stat-value { color: var(--color-secondary); }
.widget-stats .stat-divider { border: 0; height: 1px; background-color: var(--color-border); margin: 10px 0 15px 0; }
.widget-stats .bottom-grid { grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); }
.widget-stats .bottom-grid .stat-value { font-size: 1.8rem; color: var(--color-text); }
.dark-mode .widget-stats .bottom-grid .stat-value { color: var(--color-text); }
.widget-maintenance .setting-control { margin-bottom: 5px; }
.widget-maintenance .toggle-status { font-size: 1rem; }
.widget-maintenance p { margin-bottom: 10px; line-height: 1.5; }
.widget-activity .activity-list { list-style: none; padding: 0; margin: 0 0 15px 0; font-size: 0.85rem; max-height: 160px; overflow-y: auto; }
.widget-activity .activity-list li { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed var(--color-border); line-height: 1.4; }
.widget-activity .activity-list li:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
.widget-activity .log-time { color: var(--color-text-muted); margin-right: 5px; font-weight: 600; }
.widget-activity .log-user { font-weight: 600; color: var(--color-primary); margin-right: 5px; }
.dark-mode .widget-activity .log-user { color: var(--color-primary); }
.widget-activity .log-action { color: var(--color-text); }
.widget-activity .log-target { color: #6c757d; font-style: italic; margin-left: 5px; }
.widget-quicklinks .quicklink-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.widget-quicklinks .quicklink-buttons .btn { width: 100%; margin: 0; padding: 10px; font-size: 0.9rem; background-color: #f8f9fa; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; gap: 8px; }
.widget-quicklinks .quicklink-buttons .btn svg { width: 16px; height: 16px; flex-shrink: 0; }
.widget-quicklinks .quicklink-buttons .btn:hover { background-color: #e9ecef; color: var(--color-primary); border-color: #dee2e6; }
.dark-mode .widget-quicklinks .quicklink-buttons .btn { background-color: var(--color-surface); color: var(--color-text); border-color: var(--color-border); }
.dark-mode .widget-quicklinks .quicklink-buttons .btn:hover { background-color: #343a40; color: #fff; border-color: #495057; }
.widget-system-info .system-info-list { display: flex; flex-direction: column; gap: 12px; margin: 0; padding: 0; }
.widget-system-info .info-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; padding-bottom: 8px; border-bottom: 1px dashed var(--color-border); }
.widget-system-info .info-item:last-child { border-bottom: none; padding-bottom: 0; }
.widget-system-info .info-label { font-weight: 600; color: var(--color-text-muted); }
.widget-system-info .info-value { font-weight: 600; color: var(--color-text); background-color: var(--color-surface-alt); padding: 3px 8px; border-radius: 5px; font-family: monospace; font-size: 0.85rem; }
.dark-mode .widget-system-info .info-value { background-color: var(--color-surface); color: var(--color-text); }
.widget-publish-status .publish-status-group { margin-bottom: 15px; }
.widget-publish-status .publish-status-group strong { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--color-text); }
.widget-publish-status .status-indicators { display: flex; gap: 10px; }
.status-indicator { display: inline-block; padding: 4px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: 600; }
.status-indicator.published { background-color: var(--color-success); color: white; }
.status-indicator.not-published { background-color: #e9ecef; color: #6c757d; }
.dark-mode .status-indicator.not-published { background-color: #343a40; color: #adb5bd; }
.widget-system-status .system-check-list { list-style: none; padding: 0; margin: 0 0 15px 0; cursor: help; }
.widget-system-status .system-check-list li { display: flex; align-items: flex-start; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed var(--color-border); gap: 15px; }
.widget-system-status .system-check-list li:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
.widget-system-status .status-info { display: flex; align-items: flex-start; flex-shrink: 0; margin-right: 10px; flex-basis: auto; min-width: 0; word-break: break-word; }
.widget-system-status .status-icon { font-size: 1.1rem; margin-right: 10px; flex-shrink: 0; margin-top: 2px; }
.widget-system-status .status-label { font-weight: 600; color: var(--color-text); }
.widget-system-status .status-message { color: var(--color-text-muted); font-weight: 600; margin-left: auto; text-align: right; word-break: break-word; flex-shrink: 0; padding-left: 10px; }
.widget-system-status li.status-ok .status-icon { color: var(--color-success); }
.widget-system-status li.status-fail .status-icon { color: var(--color-danger); }
.widget-system-status li.status-fail .status-message { color: var(--color-danger); font-weight: 700; }
.widget-action-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--color-border); display: flex; align-items: center; gap: 15px; }
.widget-action-footer .btn-small { padding: 6px 12px; font-size: 0.85rem; width: auto; margin-bottom: 0; }
@media (max-width: 768px) {
    .dashboard-widget-grid { grid-template-columns: 1fr; }
    .widget-quicklinks .quicklink-buttons { grid-template-columns: 1fr; }

}

/* --- NEU: STILE F√úR SYSTEM-HEALTH-SEITE --- */
.health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
    padding: 10px;
}

.health-widget {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
}
.dark-mode .health-widget {
    background-color: var(--color-surface-alt);
}

.health-widget h3 {
    font-size: 1.3rem;
    margin: 0;
    padding: 20px 25px;
    border-bottom: 1px solid var(--color-border);
}

.health-list {
    list-style: none;
    padding: 25px;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.health-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    padding-bottom: 18px;
    border-bottom: 1px dashed var(--color-border);
}
.health-list li:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.health-label {
    font-weight: 600;
    color: var(--color-text-muted);
}

.health-value {
    font-weight: 600;
    font-family: var(--font-display);
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Status-Indikatoren */
.health-value .icon-check,
.health-value.status-ok {
    color: var(--color-success);
}
.health-value .icon-x,
.health-value.status-error {
    color: var(--color-danger);
}
.health-value .icon-tool,
.health-value.status-warn {
    color: var(--color-warning);
}

.health-widget.widget-permissions .health-label {
    font-family: monospace;
    font-size: 0.9rem;
    color: var(--color-text);
}
.dark-mode .health-widget.widget-permissions .health-label {
     color: var(--color-text-muted);
}

/* --- NEU: STILE F√úR IMPERSONATION-BANNER --- */
.impersonation-banner {
    background-color: var(--color-warning);
    color: #000;
    padding: 12px 0;
    font-size: 0.9rem;
    position: sticky;
    top: 0;
    z-index: 1050; /* Muss √ºber dem Header liegen */
    border-bottom: 2px solid rgba(0,0,0,0.2);
}
.impersonation-banner strong {
    font-weight: 700;
}
.impersonation-banner a.btn {
    background-color: rgba(255,255,255,0.8);
    color: #000;
    border-color: rgba(0,0,0,0.2);
    font-weight: 700;
}
.impersonation-banner a.btn:hover {
    background-color: #fff;
    color: #000;
}

/* KORREKTUR: Erzwingt, dass der Header *unter* dem Banner beginnt */
body:has(.impersonation-banner) .main-header {
    top: 52px; /* H√∂he des Banners */
}
/* KORREKTUR: Erzwingt, dass die Admin-Sidebar *unter* dem Banner beginnt */
body:has(.impersonation-banner) .dashboard-sidebar {
    top: 152px; /* 100px (Basis) + 52px (Banner) */
}


/* --- NEU: Icons f√ºr Admin-Buttons (falls Sie Feather-Icons o.√§. verwenden) --- */
/* Wenn Sie keine Icon-Schriftart haben, k√∂nnen Sie diese ignorieren oder SVGs verwenden */
.btn .icon-user-check,
.btn .icon-edit,
.btn .icon-trash {
    display: inline-block;
    width: 1em;
    height: 1em;
    margin-right: 5px;
    /* Hier w√ºrden die SVG-Hintergr√ºnde oder Schriftart-Codes hinkommen */
    /* Beispiel (setzt voraus, dass Sie eine Icon-Lib haben): */
    font-family: 'feather'; /* Annahme */
}
/* Beispiel-Icons (m√ºssen durch Ihre Icon-Bibliothek ersetzt werden) */
.icon-user-check:before { content: '\e8a0'; } 
.icon-edit:before { content: '\e890'; }
.icon-trash:before { content: '\e891'; }
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\pages\_admin.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\pages\_dashboard.css ---
/* public/assets/css/pages/_dashboard.css */

/* --- NEU: Tab-Layout (ersetzt altes Grid/Sidebar-Layout) --- */
.dashboard-wrapper {
    max-width: 100%; /* Volle Breite f√ºr das Layout nutzen */
    padding: 20px 30px;
}
.dark-mode .dashboard-wrapper {
    background-color: #0d1117; /* Dunklerer Hintergrund f√ºr die ganze Seite */
}

/* Entfernt das alte 2-Spalten-Layout */
.dashboard-container {
    display: block; /* Einfaches Block-Layout statt Grid */
}
/* Entfernt das alte Sidebar-Styling */
.dashboard-sidebar-content,
.dashboard-main-content {
    display: block;
    width: 100%;
    position: static;
    max-height: none;
    overflow-y: visible;
    box-shadow: none;
    border: none;
    padding: 0;
    margin: 0;
}

/* --- NEU: Tab Navigation Styling (Inspiriert von _admin.css) --- */
.tab-navigation {
    display: flex;
    flex-wrap: wrap; /* Erlaube Umbruch auf kleinen Ger√§ten */
    background-color: var(--color-surface-alt);
    padding: 0 10px;
    border: 1px solid var(--color-border);
    border-radius: 10px 10px 0 0;
    margin-top: 20px;
}
.dark-mode .tab-navigation {
    background-color: var(--color-surface-alt);
    border-color: var(--color-border);
}

.tab-button {
    padding: 15px 20px;
    font-weight: 600;
    font-size: 0.95rem;
    border: none;
    border-bottom: 3px solid transparent;
    background-color: transparent;
    cursor: pointer;
    color: var(--color-text-muted);
    transition: all 0.2s ease-in-out;
    position: relative;
    top: 1px;
    white-space: nowrap;
}
.dark-mode .tab-button {
    color: var(--color-text-muted);
}

.tab-button:hover {
    color: var(--color-primary);
    background-color: #ffffff;
}
.dark-mode .tab-button:hover {
    color: #fff;
    background-color: var(--color-surface);
}

.tab-button.active {
    color: var(--color-primary);
    font-weight: 700;
    border-bottom-color: var(--color-primary);
    background-color: var(--color-surface);
}
.dark-mode .tab-button.active {
    color: #fff;
    border-bottom-color: var(--color-primary);
    background-color: var(--color-surface);
}

/* --- NEU: Tab Content Styling --- */
.tab-content {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.05);
}

.tab-content .dashboard-section {
    display: none; /* Hide sections by default */
    padding: 25px 30px;
    animation: fadeIn 0.4s ease;
}
.tab-content .dashboard-section.active {
    display: block; /* Show active section */
}

/* Versteckt den (jetzt √ºberfl√ºssigen) Titel in den Sektionen */
.dashboard-section .section-title-hidden {
    display: none; 
}
/* Zeigt H4-Titel in Sektionen (z.B. im Community Board) */
.dashboard-section h4 {
    font-size: 1.5rem;
    font-family: var(--font-display);
    margin: 0 0 10px 0;
    color: var(--color-text);
}


@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- ENDE Tab Layout --- */


/* --- Anpassungen f√ºr Widget-Inhalte (jetzt in Sektionen) --- */

/* Ank√ºndigungen im Tab */
#section-announcements {
    padding: 0; /* Entferne Sektions-Padding, Liste √ºbernimmt */
}
#announcements-list {
    max-height: 80vh; /* H√∂he f√ºr Scrollen */
    overflow-y: auto;
    padding: 0; 
}
.announcement-item {
    padding: 15px 25px;
    border-bottom: 1px solid var(--color-border);
}
.announcement-item:last-child {
    border-bottom: none;
}
.announcement-item:hover {
    background-color: rgba(57, 0, 153, 0.03);
}
.dark-mode .announcement-item:hover {
    background-color: rgba(169, 114, 255, 0.08);
}
#announcements-list .loading-spinner { margin-top: 20px; }


/* "Mein Tag" im Tab */
#section-my-day {
    background-color: var(--color-surface-alt);
}
.dark-mode #section-my-day {
    background-color: var(--color-background);
}
#today-schedule-container {
    margin-top: 0; 
    max-height: none; /* Keine H√∂henbegrenzung mehr */
    overflow-y: visible;
    padding-right: 0;
}
/* Storno-Button in "Mein Tag" */
.today-entry {
    display: grid;
    grid-template-columns: 60px 1fr auto; 
    gap: 10px 15px;
    padding: 12px 15px;
    border-radius: 8px;
    background-color: var(--color-surface); /* Heller als Sektions-BG */
    border-left: 4px solid var(--color-primary);
    align-items: center;
}
.dark-mode .today-entry {
    background-color: var(--color-surface);
    border-left-color: var(--color-primary);
}
.today-entry .entry-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: flex-end;
}
.today-entry .cancel-appointment-btn {
    padding: 2px 6px;
    font-size: 0.9rem;
    line-height: 1;
    height: 24px;
    width: 24px;
    margin-left: 5px;
    background-color: transparent;
    border: 1px solid transparent;
    color: var(--color-text-muted);
}
.today-entry .cancel-appointment-btn:hover {
    color: var(--color-danger);
    background-color: rgba(255, 0, 84, 0.1);
    border-color: rgba(255, 0, 84, 0.3);
}
/* NEU: .btn-ics Styling */
.today-entry .btn-ics {
    display: inline-flex; /* Flex f√ºr Zentrierung */
    align-items: center;
    justify-content: center;
    padding: 2px 6px;
    height: 24px;
    width: 24px;
    font-size: 0.9rem;
    line-height: 1;
    color: var(--color-text-muted);
    background-color: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    text-decoration: none;
    transition: all 0.2s ease;
}
.today-entry .btn-ics:hover {
    color: var(--color-primary);
    background-color: rgba(57, 0, 153, 0.1);
    border-color: rgba(57, 0, 153, 0.3);
    text-decoration: none;
}
.today-entry .btn-ics svg {
    width: 14px;
    height: 14px;
    /* vertical-align: middle; (Nicht mehr n√∂tig bei flex) */
}


/* Wochenplan-Tab */
#section-weekly-plan .dashboard-header {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 15px;
}
#section-weekly-plan .plan-header-info { margin-bottom: 15px; }


/* iCal-Box (jetzt im Wochenplan-Tab) */
.ical-subscription-box {
    margin-top: 25px; 
    margin-bottom: 0; /* Kein Rand nach unten */
    padding: 15px;
    background-color: var(--color-surface-alt); 
    border-radius: 8px;
    border: 1px solid var(--color-border);
}
.dark-mode .ical-subscription-box {
    background-color: var(--color-surface-alt);
    border-color: var(--color-border);
}

/* (Die Stile f√ºr ical inputs, input-group etc. bleiben gleich) */


/* Lehrer-Cockpit Tabs */
.cockpit-feature {
    position: relative; 
    margin-bottom: 20px;
}
.cockpit-feature h4 {
    font-size: 1.5rem;
    font-family: var(--font-display);
    margin: 0 0 20px 0;
    color: var(--color-text);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 10px;
}
.cockpit-widget .stat-divider { /* (Alt, aber ggf. n√ºtzlich) */
    display: none; 
}
/* Styling f√ºr Formulare in Cockpit-Tabs */
.cockpit-feature .form-container {
    margin: 0 0 20px 0; 
    border: 1px solid var(--color-border);
    padding: 20px;
    background-color: var(--color-surface-alt);
    border-radius: 8px; /* NEU */
}
.dark-mode .cockpit-feature .form-container {
    background-color: var(--color-background);
}

/* 3-Spalten-Grid f√ºr Sprechstunden-Formular */
.form-grid-col-3 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
    gap: 15px;
}
/* Liste der Sprechzeiten-Fenster */
.office-hours-list-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 10px;
    background-color: var(--color-surface-alt);
}
.dark-mode .office-hours-list-container {
    background-color: var(--color-background);
}
.office-hours-list-container .message {
    margin-bottom: 0; 
}
.office-hour-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.9rem;
}
.office-hour-item:last-child {
    border-bottom: none;
}
.office-hour-item strong {
    color: var(--color-primary);
    font-weight: 600;
}
.office-hour-item .delete-office-hour-btn {
    padding: 2px 8px;
    font-size: 1rem;
    line-height: 1;
    height: 28px;
    width: 28px;
}
/* --- ENDE Sprechstunden --- */


/* --- NEU: Community Board (Schwarzes Brett) Styling --- */
.posts-list-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    overflow-y: auto;
    padding: 5px;
}
.community-post-item {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    transition: box-shadow 0.2s ease;
}
.community-post-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.dark-mode .community-post-item {
    background-color: var(--color-surface-alt);
}
.post-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
    flex-wrap: wrap; /* Erlaube Umbruch f√ºr lange Titel */
}
.post-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--color-primary);
}
.post-meta {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    text-align: right;
    flex-shrink: 0;
    line-height: 1.5;
}
.post-meta a {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
}
.post-meta a:hover {
    text-decoration: underline;
}
.dark-mode .post-meta a {
    color: var(--color-primary);
}
.post-content-preview {
    padding: 20px;
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--color-text);
    word-wrap: break-word;
}
.dark-mode .post-content-preview {
    color: var(--color-text);
}
.post-content-preview p:first-child { margin-top: 0; }
.post-content-preview p:last-child { margin-bottom: 0; }
.post-content-preview ul, .post-content-preview ol { padding-left: 1.5em; margin-bottom: 1em; }
.post-content-preview a { color: var(--color-primary); }
.post-content-preview a:hover { color: var(--color-secondary); }
.dark-mode .post-content-preview a { color: var(--color-primary); }
.dark-mode .post-content-preview a:hover { color: var(--color-warning); }

/* --- NEU: Styling f√ºr "Meine Beitr√§ge" --- */
.my-posts-container {
    max-height: 70vh; /* H√∂he f√ºr Scrollen */
}
.my-post-item {
    /* Erbt .community-post-item */
    /* Trennt Inhalt und Meta/Aktionen */
    display: flex;
    flex-direction: column;
}
.my-post-item .post-content-preview {
    flex-grow: 1;
}
.my-post-meta {
    padding: 12px 20px;
    background-color: var(--color-surface-alt);
    border-top: 1px solid var(--color-border);
    display: flex;
    flex-wrap: wrap; /* Erlaube Umbruch auf kleinen Schirmen */
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    border-radius: 0 0 7px 7px;
}
.dark-mode .my-post-meta {
    background-color: var(--color-surface);
}
.my-post-meta .post-status {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
    color: var(--color-text-muted);
    flex-wrap: wrap; /* Erlaube Umbruch, falls n√∂tig */
}
.my-post-meta .post-actions {
    display: flex;
    gap: 10px;
}
/* KORREKTUR: Buttons sollen nicht 100% Breite haben, sondern Auto-Breite */
.my-post-meta .btn-small { 
    margin-bottom: 0;
    width: auto; /* KORRIGIERT: Setzt Breite auf Auto */
    padding: 6px 12px;
    flex-grow: 0; /* KORRIGIERT: Kein Wachsen erlauben */
}
.status-badge {
    font-size: 0.75rem;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 5px;
    text-transform: uppercase;
}
/* KORREKTUR: Farbe f√ºr "Ausstehend" hinzugef√ºgt */
.status-badge.status-pending { 
    background-color: var(--color-warning);
    color: #333;
}
.status-badge.status-approved {
    background-color: var(--color-success);
    color: white;
}
.status-badge.status-rejected {
    background-color: var(--color-danger);
    color: white;
}
/* --- ENDE "Meine Beitr√§ge" --- */


/* --- ENDE Community Board --- */


/* (Styling f√ºr Kollegensuche, Anwesenheit, Events bleibt gleich) */
.search-results-dropdown {
    display: none; position: absolute; top: 100%; left: 0; right: 0;
    background-color: var(--color-surface); border: 1px solid var(--color-border);
    border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.08);
    z-index: 100; max-height: 250px; overflow-y: auto;
}
.search-results-dropdown.visible { display: block; }
.search-result-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--color-border); font-size: 0.9rem; }
.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover { background-color: var(--color-surface-alt); color: var(--color-primary); }
.dark-mode .search-result-item:hover { background-color: #ffffff0d; }
.search-result-item.none { color: var(--color-text-muted); cursor: default; }
.search-result-display { margin-top: 15px; padding: 15px; background-color: var(--color-surface-alt); border-radius: 8px; border: 1px solid var(--color-border); min-height: 60px; display: flex; align-items: center; gap: 10px; }
.dark-mode .search-result-display { background-color: var(--color-background); }
.search-result-display p { margin: 0; line-height: 1.5; color: var(--color-text); }
.search-result-display p strong { color: var(--color-primary); }
.search-result-display .loading-spinner.small { height: 24px; width: 24px; flex-shrink: 0; }
#attendance-current-lesson { padding: 15px; background-color: var(--color-surface-alt); border-radius: 8px; border: 1px solid var(--color-border); margin-bottom: 15px; min-height: 50px; display: flex; align-items: center; }
.dark-mode #attendance-current-lesson { background-color: var(--color-background); }
#attendance-current-lesson .lesson-info { font-size: 1.1rem; font-weight: 600; }
#attendance-current-lesson .lesson-info strong { color: var(--color-primary); font-family: var(--font-display); font-size: 1.3rem; }
#attendance-current-lesson .message.info { margin: 0; padding: 0; background: transparent; border: none; text-align: left; }
.attendance-list-container { border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; }
.attendance-list-header { display: flex; justify-content: space-between; padding: 10px 15px; background-color: var(--color-surface-alt); border-bottom: 1px solid var(--color-border); font-weight: 600; font-size: 0.8rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.dark-mode .attendance-list-header { background-color: var(--color-background); }
.attendance-student-list { list-style: none; margin: 0; padding: 0; max-height: 400px; overflow-y: auto; }
.student-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--color-border); }
.student-row:last-child { border-bottom: none; }
.student-row .student-name { font-weight: 600; color: var(--color-text); }
.attendance-toggles { display: flex; gap: 5px; }
.attendance-toggles .btn-toggle { font-size: 0.8rem; font-weight: 700; padding: 5px 10px; border: 1px solid var(--color-border); background-color: var(--color-surface); color: var(--color-text-muted); border-radius: 5px; cursor: pointer; transition: all 0.2s ease; }
.dark-mode .attendance-toggles .btn-toggle { background-color: var(--color-surface-alt); border-color: #444; }
.attendance-toggles .btn-toggle:hover { background-color: #f0f0f0; }
.dark-mode .attendance-toggles .btn-toggle:hover { background-color: #333; }
.attendance-toggles .btn-toggle.status-anwesend.active { background-color: var(--color-success); color: white; border-color: var(--color-success); }
.attendance-toggles .btn-toggle.status-abwesend.active { background-color: var(--color-danger); color: white; border-color: var(--color-danger); }
.attendance-toggles .btn-toggle.status-verspaetet.active { background-color: var(--color-warning); color: #333; border-color: var(--color-warning); }
.attendance-toggles .btn-toggle.status-entschuldigt.active { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
#academic-events-feature .form-container { border: 1px solid var(--color-border); background-color: var(--color-surface-alt); }
.dark-mode #academic-events-feature .form-container { background-color: var(--color-background); }
#academic-events-feature h5 { font-size: 1rem; font-weight: 600; color: var(--color-text-muted); margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--color-border); }
.event-list-container { max-height: 300px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: 8px; }
.event-group { margin-bottom: 10px; }
.event-group:last-child { margin-bottom: 0; }
.event-group-date { font-size: 0.85rem; font-weight: 600; color: var(--color-text-muted); padding: 8px 12px; background-color: var(--color-surface-alt); border-bottom: 1px solid var(--color-border); position: sticky; top: 0; z-index: 1; }
.dark-mode .event-group-date { background-color: var(--color-background); }
.event-list-items { list-style: none; padding: 0; margin: 0; }
.event-list-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid var(--color-border); }
.event-list-item:last-child { border-bottom: none; }
.event-list-item .event-icon { font-size: 1.2rem; flex-shrink: 0; width: 24px; text-align: center; }
.event-list-item .event-details { flex-grow: 1; font-size: 0.9rem; line-height: 1.4; }
.event-list-item .event-details strong { display: block; color: var(--color-text); }
.event-list-item .event-details span { font-size: 0.8rem; color: var(--color-text-muted); }
.event-list-item .event-details small { font-size: 0.8rem; color: #555; font-style: italic; display: block; margin-top: 3px; }
.dark-mode .event-list-item .event-details small { color: #aaa; }
.event-list-item .delete-event-btn { flex-shrink: 0; padding: 2px 8px; font-size: 1rem; line-height: 1; height: 28px; width: 28px; background-color: transparent; border: 1px solid transparent; color: var(--color-text-muted); }
.event-list-item .delete-event-btn:hover { color: var(--color-danger); background-color: rgba(255, 0, 84, 0.1); border-color: rgba(255, 0, 84, 0.3); }
.event-list-item.type-klausur .event-icon { color: var(--color-danger); }
.event-list-item.type-aufgabe .event-icon { color: var(--color-primary); }
.event-list-item.type-info .event-icon { color: var(--color-success); }
.my-day-section .section-title { margin-bottom: 15px; }
.today-schedule-container { display: flex; flex-direction: column; gap: 10px; min-height: 50px; }
.today-entry .time { font-weight: 600; font-size: 0.85rem; color: var(--color-text-muted); text-align: right; }
.today-entry .details strong { font-size: 1rem; display: block; margin-bottom: 2px; }
.today-entry .details span { font-size: 0.85rem; color: var(--color-text-muted); }
.today-entry .details span + span::before { content: " ‚Ä¢ "; margin: 0 4px; }
.today-entry .details small.entry-comment { display: block; font-size: 0.8rem; color: var(--color-secondary); margin-top: 3px; font-style: italic; }
.today-entry.type-appointment .details small.entry-comment { color: var(--color-text-muted); font-style: normal; }
/* NEU: Styling f√ºr Notiz-Icon im "Mein Tag"-Feed */
.today-entry .details small.entry-note {
    display: block;
    font-size: 0.8rem;
    color: var(--color-primary);
    font-style: italic;
    margin-top: 4px;
    font-weight: 600;
}
.today-entry .details small.entry-note svg {
    width: 12px;
    height: 12px;
    margin-right: 4px;
    vertical-align: -2px;
}
.dark-mode .today-entry .details small.entry-note {
    color: var(--color-primary);
}


.today-entry .type-badge { font-size: 0.7rem; font-weight: bold; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; white-space: nowrap; }
.today-entry.type-regular { border-left-color: var(--color-primary); }
.today-entry.type-Vertretung { border-left-color: var(--color-danger); background-color: #fff0f1; }
.today-entry.type-Raum√§nderung { border-left-color: var(--color-warning); background-color: #fff9e6; }
.today-entry.type-Sonderevent { border-left-color: #007bff; background-color: #e7f5ff; }
.today-entry.type-Entfall { border-left-color: #6c757d; background-color: #f8f9fa; text-decoration: line-through; opacity: 0.7; }
.dark-mode .today-entry.type-Vertretung { background-color: rgba(255, 0, 84, 0.1); }
.dark-mode .today-entry.type-Raum√§nderung { background-color: rgba(255, 189, 0, 0.1); }
.dark-mode .today-entry.type-Sonderevent { background-color: rgba(0, 123, 255, 0.1); }
.dark-mode .today-entry.type-Entfall { background-color: rgba(108, 117, 125, 0.1); }
.today-entry .type-badge.type-regular { background-color: var(--color-primary); color: white; }
.today-entry .type-badge.type-Vertretung { background-color: var(--color-danger); color: white; }
.today-entry .type-badge.type-Raum√§nderung { background-color: var(--color-warning); color: #333; }
.today-entry .type-badge.type-Sonderevent { background-color: #007bff; color: white; }
.today-entry .type-badge.type-Entfall { background-color: #6c757d; color: white; }
.today-entry.type-klausur { border-left-color: var(--color-danger); background-color: #fff0f1; }
.dark-mode .today-entry.type-klausur { background-color: rgba(255, 0, 84, 0.1); }
.today-entry .type-badge.type-klausur { background-color: var(--color-danger); color: white; }
.today-entry.type-klausur .time { color: var(--color-danger); font-weight: 700; font-size: 0.8rem; }
.today-entry.type-aufgabe { border-left-color: var(--color-primary); background-color: #f0f0ff; }
.dark-mode .today-entry.type-aufgabe { background-color: rgba(57, 0, 153, 0.1); }
.today-entry .type-badge.type-aufgabe { background-color: var(--color-primary); color: white; }
.today-entry.type-aufgabe .time { color: var(--color-primary); font-weight: 700; font-size: 0.8rem; }
.today-entry.type-info { border-left-color: var(--color-success); background-color: #e6f7ec; }
.dark-mode .today-entry.type-info { background-color: rgba(40, 167, 69, 0.1); }
.today-entry .type-badge.type-info { background-color: var(--color-success); color: white; }
.today-entry.type-info .time { color: var(--color-success); font-weight: 700; font-size: 0.8rem; }
.today-entry.type-appointment { border-left-color: var(--color-secondary); background-color: #fdf0f7; }
.dark-mode .today-entry.type-appointment { background-color: rgba(158, 0, 89, 0.1); }
.today-entry .type-badge.type-appointment { background-color: var(--color-secondary); color: white; }
.today-entry .type-appointment .time { color: var(--color-secondary); font-weight: 700; }
.today-schedule-container .loading-spinner.small { height: 30px; width: 30px; margin: 10px auto; }
.today-schedule-container .message.info { padding: 15px; margin: 0; text-align: center; }
.dashboard-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--color-border); }
.dashboard-header .section-title { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
.plan-controls { display: flex; gap: 15px; }
.plan-controls .form-group { margin-bottom: 0; }
.plan-controls .form-group label { font-size: 0.8rem; }
.plan-controls select, .plan-controls input { min-height: 38px; padding-top: 0; padding-bottom: 0; }
.ical-subscription-box label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: var(--color-text); }
.input-group { display: flex; align-items: center; }
.input-group input[type="text"] { flex-grow: 1; border-top-right-radius: 0; border-bottom-right-radius: 0; font-size: 0.85rem; background-color: var(--color-surface); color: var(--color-text-muted); border-right: none; min-height: 38px; padding: 8px 10px; }
.dark-mode .input-group input[type="text"] { background-color: var(--color-background); color: var(--color-text-muted); border-color: var(--color-border); }
.input-group .btn-small { flex-shrink: 0; border-top-left-radius: 0; border-bottom-left-radius: 0; padding: 0 12px; height: 38px; width: auto; display: flex; align-items: center; justify-content: center; border: 1px solid var(--color-border); border-left: none; }
.input-group .btn-secondary { background-color: #e9ecef; color: var(--color-text); border-color: var(--color-border); }
.input-group .btn-secondary:hover { background-color: #dee2e6; }
.dark-mode .input-group .btn-secondary { background-color: var(--color-surface-alt); color: var(--color-text-muted); border-color: var(--color-border); }
.dark-mode .input-group .btn-secondary:hover { background-color: #343a40; color: var(--color-text); }
.ical-subscription-box .form-hint { margin-top: 8px; font-size: 0.8rem; }
.plan-header-info { font-weight: 600; color: var(--color-text-muted); margin-bottom: 1.5rem; text-align: center; font-size: 0.9rem; }

/* KORREKTUR: Cursor-Pointer f√ºr klickbare Zellen im Wochenplan */
.timetable-grid .grid-cell.has-entry {
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.timetable-grid .grid-cell.has-entry:hover {
    background-color: #f1f5f9;
    transform: scale(1.02);
    z-index: 5;
}
.dark-mode .timetable-grid .grid-cell.has-entry:hover {
    background-color: #ffffff1a;
}
/* (Kein Hover f√ºr leere Zellen oder FU) */
.timetable-grid .grid-cell.empty { cursor: default; }
.timetable-grid .grid-cell.default-entry { cursor: default; }
.timetable-grid .grid-cell.empty:hover { background-color: var(--color-surface); transform: none; }
.dark-mode .timetable-grid .grid-cell.empty:hover { background-color: var(--color-surface); }
.timetable-grid .grid-cell.default-entry:hover { background-color: #f8f9fa; transform: none; }
.dark-mode .timetable-grid .grid-cell.default-entry:hover { background-color: #21262d; }


.timetable-grid { display: grid; grid-template-columns: 80px repeat(5, 1fr); grid-auto-rows: minmax(70px, auto); gap: 3px; background-color: var(--color-border); border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; }
.grid-header { background-color: #f8f9fa; font-weight: bold; text-align: center; padding: 8px; font-size: 0.85rem; }
.dark-mode .grid-header { background-color: #21262d; }
.grid-header.period-header { grid-column: 1; font-size: 0.75rem; }
.grid-cell { display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; gap: 3px; padding: 3px; position: relative; background-color: var(--color-surface); }
.dark-mode .grid-cell { background-color: var(--color-surface); }
.grid-cell[data-day="1"] { grid-column: 2; }
.grid-cell[data-day="2"] { grid-column: 3; }
.grid-cell[data-day="3"] { grid-column: 4; }
.grid-cell[data-day="4"] { grid-column: 5; }
.grid-cell[data-day="5"] { grid-column: 6; }
.cell-entry { background: rgba(255, 255, 255, 0.9); border-radius: 3px; padding: 3px 5px; border: 1px solid var(--color-border); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; word-break: break-word; flex-grow: 1; height: 100%; box-sizing: border-box; }
.dark-mode .cell-entry { background: rgba(40, 48, 54, 0.9); border-color: #444c56; }
.grid-cell strong { font-size: 0.9rem; font-weight: 700; }
.grid-cell span { font-size: 0.75rem; color: var(--color-text-muted); }
.grid-cell small { font-size: 0.7rem; color: var(--color-text-muted); }
.grid-cell small.entry-room { color: #555; }
.dark-mode .grid-cell small.entry-room { color: #bbb; }
.grid-cell small.entry-comment { display: block; font-style: italic; color: var(--color-secondary); margin-top: 2px; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90%; }
/* NEU: Styling f√ºr Notiz-Icon im Wochenplan */
.grid-cell.has-note .cell-entry {
    position: relative;
}
.grid-cell .cell-entry .entry-note {
    position: absolute;
    top: 2px;
    left: 4px;
    font-size: 0.7rem;
    color: var(--color-primary);
}
.grid-cell .cell-entry .entry-note svg {
    width: 10px;
    height: 10px;
}
.dark-mode .grid-cell .cell-entry .entry-note {
    color: var(--color-primary);
}


.dashboard-wrapper .grid-cell.default-entry { background-color: #f8f9fa; color: #6c757d; justify-content: center; align-items: center; }
.dashboard-wrapper .grid-cell.default-entry .cell-entry { flex-grow: 0; height: auto; background: transparent; border: none; }
.dark-mode .dashboard-wrapper .grid-cell.default-entry { background-color: #21262d; color: var(--color-text-muted); }
.dashboard-wrapper .grid-cell.default-entry strong, .dashboard-wrapper .grid-cell.default-entry span { text-align: center; }
.dashboard-wrapper .grid-cell.substitution-Vertretung { background-color: #fff0f1; border-left: 3px solid var(--color-danger); }
.dashboard-wrapper .grid-cell.substitution-Raum√§nderung { background-color: #fff9e6; border-left: 3px solid var(--color-warning); }
.dashboard-wrapper .grid-cell.substitution-Sonderevent { background-color: #e7f5ff; border-left: 3px solid #007bff; }
.dashboard-wrapper .grid-cell.substitution-Entfall { background-color: #f8f9fa; border-left: 3px solid #6c757d; }
.dashboard-wrapper .grid-cell.substitution-Entfall > .cell-entry { text-decoration: line-through; color: #6c757d; opacity: 0.8; }
.dark-mode .dashboard-wrapper .grid-cell.substitution-Vertretung { background-color: rgba(255, 0, 84, 0.1); }
.dark-mode .dashboard-wrapper .grid-cell.substitution-Raum√§nderung { background-color: rgba(255, 189, 0, 0.1); }
.dark-mode .dashboard-wrapper .grid-cell.substitution-Sonderevent { background-color: rgba(0, 123, 255, 0.1); }
.dark-mode .dashboard-wrapper .grid-cell.substitution-Entfall { background-color: rgba(108, 117, 125, 0.1); }
.dashboard-wrapper .grid-cell.block-start { padding: 0; justify-content: center; }
.dashboard-wrapper .grid-cell.block-start .cell-entry { border-radius: 0; border: none; width: 100%; height: 100%; padding: 6px 5px; }
.dashboard-wrapper .grid-cell.substitution-Vertretung.block-start, .dashboard-wrapper .grid-cell.substitution-Raum√§nderung.block-start, .dashboard-wrapper .grid-cell.substitution-Sonderevent.block-start, .dashboard-wrapper .grid-cell.substitution-Entfall.block-start { }
.dashboard-wrapper .grid-cell.substitution-Vertretung.block-start .cell-entry, .dashboard-wrapper .grid-cell.substitution-Raum√§nderung.block-start .cell-entry, .dashboard-wrapper .grid-cell.substitution-Sonderevent.block-start .cell-entry, .dashboard-wrapper .grid-cell.substitution-Entfall.block-start .cell-entry { }

/* Sprechstunden-Widget im Sch√ºler-Dashboard */
#appointment-booking-widget .form-group {
    position: relative; /* Wichtig f√ºr das Dropdown */
}
.available-slots-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    background-color: var(--color-background);
    border-radius: 8px;
    min-height: 40px;
}
.dark-mode .available-slots-container {
    background-color: var(--color-surface-alt);
}
.available-slots-container .form-hint {
    margin: auto;
}
.btn-slot {
    padding: 8px 12px;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 6px;
    background-color: var(--color-surface);
    color: var(--color-primary);
    border: 1px solid var(--color-primary);
    cursor: pointer;
    transition: all 0.2s ease;
}
.dark-mode .btn-slot {
    background-color: var(--color-surface);
    border-color: var(--color-primary);
}
.btn-slot:hover {
    background-color: rgba(57, 0, 153, 0.1);
}
.dark-mode .btn-slot:hover {
    background-color: rgba(169, 114, 255, 0.1);
}
.btn-slot.selected {
    background-color: var(--color-primary);
    color: white;
    font-weight: 700;
    transform: scale(1.05);
}


@media (max-width: 992px) {
    .dashboard-sidebar-content {
        max-height: none; 
        overflow-y: visible;
    }
    
    /* NEU: "Meine Beitr√§ge" responsiv */
    .my-post-meta {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    .my-post-meta .post-status {
        align-items: flex-start;
        flex-direction: column;
        gap: 8px;
    }
    /* KORRIGIERT: Responsives Button-Layout */
    .my-post-meta .post-actions {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
    }
    /* KORREKTUR: Stelle sicher, dass Buttons im Grid die Auto-Breite verlieren */
    .my-post-meta .post-actions .btn-small {
        width: 100%; 
    }
}

@media (max-width: 768px) {
    .dashboard-wrapper {
        padding: 15px;
    }
    .tab-navigation {
        padding: 0 5px;
    }
    .tab-button {
        font-size: 0.85rem;
        padding: 12px 10px;
    }
    .tab-content .dashboard-section {
        padding: 15px;
    }
    .dashboard-header {
        flex-direction: column;
        align-items: stretch;
    }
    .plan-controls {
       flex-direction: column;
       align-items: stretch;
    }
    .plan-controls .form-group {
        flex-basis: 100%;
    }
    .print-export-actions {
        justify-content: center;
    }
    .timetable-grid {
        grid-template-columns: 50px repeat(5, 1fr);
    }
    .grid-cell strong { font-size: 0.8rem; }
    .grid-cell span { font-size: 0.7rem; }
    .grid-cell small { font-size: 0.65rem; }

    .today-entry {
        grid-template-columns: 45px 1fr auto;
        gap: 8px 10px;
        padding: 10px;
    }
    .today-entry .time { font-size: 0.75rem; }
    .today-entry .details strong { font-size: 0.9rem; }
    .today-entry .details span { font-size: 0.8rem; }
    
    .student-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    .form-grid-col-3 {
        grid-template-columns: 1fr;
    }
}


.print-export-actions {
    display: flex;
    gap: 10px;
    align-items: flex-end; 
}
.print-export-actions .btn {
    margin-bottom: 0; 
    width: auto; 
    padding: 8px 15px; 
    height: 38px;
    font-size: 0.9rem;
}
#export-pdf-btn {
    /* Styling kommt von .btn .btn-primary */
}
body.role-admin .print-export-actions {
    display: none !important;
}

/* --- (Kopierte Stile von _admin.css f√ºr Community Board) --- */
.posts-list-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    overflow-y: auto;
    padding: 5px;
}
.community-post-item {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    transition: box-shadow 0.2s ease;
}
.community-post-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.dark-mode .community-post-item {
    background-color: var(--color-surface-alt);
}
.post-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 15px;
    flex-wrap: wrap; /* Erlaube Umbruch f√ºr lange Titel */
}
.post-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--color-primary);
}
.post-meta {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    text-align: right;
    flex-shrink: 0;
    line-height: 1.5;
}
.post-meta a {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
}
.post-meta a:hover {
    text-decoration: underline;
}
.dark-mode .post-meta a {
    color: var(--color-primary);
}
.post-content-preview {
    padding: 20px;
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--color-text);
    word-wrap: break-word;
}
.dark-mode .post-content-preview {
    color: var(--color-text);
}
.post-content-preview p:first-child { margin-top: 0; }
.post-content-preview p:last-child { margin-bottom: 0; }
.post-content-preview ul, .post-content-preview ol { padding-left: 1.5em; margin-bottom: 1em; }
.post-content-preview a { color: var(--color-primary); }
.post-content-preview a:hover { color: var(--color-secondary); }
.dark-mode .post-content-preview a { color: var(--color-primary); }
.dark-mode .post-content-preview a:hover { color: var(--color-warning); }
/* --- ENDE Community Board Stile --- */

/* --- NEU: Plan-Detail-Modal --- */
.modal-box.small-modal {
    max-width: 450px; /* Schmaleres Modal f√ºr Details */
    /* max-height: 80vh; */ /* H√∂he passt sich Inhalt an */
    overflow-y: auto;
}
.plan-detail-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.detail-row {
    display: flex;
    font-size: 1rem;
    padding-bottom: 10px;
    border-bottom: 1px dashed var(--color-border);
}
.detail-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
}
.detail-label {
    font-weight: 600;
    color: var(--color-text-muted);
    width: 100px; /* Feste Breite f√ºr Labels */
    flex-shrink: 0;
}
.detail-value {
    color: var(--color-text);
    font-weight: 500;
    word-break: break-word;
}
/* Hervorhebung f√ºr Status */
.detail-value.status-vertretung,
.detail-value.status-sonderevent {
    color: var(--color-danger);
    font-weight: 700;
}
.detail-value.status-raum√§nderung {
    color: var(--color-warning);
    font-weight: 700;
}
.detail-value.status-entfall {
    color: var(--color-text-muted);
    font-weight: 700;
    text-decoration: line-through;
}
/* Kommentar-Styling */
.detail-row.detail-comment .detail-value {
    font-style: italic;
    color: var(--color-secondary);
}
.dark-mode .detail-row.detail-comment .detail-value {
    color: var(--color-primary);
}

/* --- NEU: Styling f√ºr Notiz-Box im Modal --- */
.detail-row.detail-notes {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    border-bottom: none;
    padding-bottom: 0;
}
#detail-notes-input {
    /* Erbt Stile von textarea aus _form-elements.css */
    margin-top: 5px;
    min-height: 80px; /* Kleinere Mindesth√∂he */
}
#note-save-spinner {
    display: none; /* Standardm√§√üig versteckt */
    margin-top: 8px;
    margin-left: auto; /* Rechtsb√ºndig unter der Textarea */
}

/* --- NEU: Modal-Styling f√ºr "Meine Beitr√§ge" (Bearbeiten) --- */
#my-post-edit-modal .modal-box {
    max-width: 600px;
}

#my-post-edit-modal .modal-close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--color-text-muted);
    cursor: pointer;
    line-height: 1;
    padding: 5px;
}
#my-post-edit-modal .modal-close-btn:hover {
    color: var(--color-danger);
}
#my-post-edit-modal .modal-actions {
    justify-content: flex-end;
}
#my-post-edit-modal .btn-secondary {
    flex-grow: 0;
    width: auto;
    background-color: var(--color-surface-alt);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
}
#my-post-edit-modal .btn-secondary:hover {
    background-color: #e9ecef;
}
.dark-mode #my-post-edit-modal .btn-secondary {
    background-color: var(--color-surface);
    border-color: var(--color-border);
}
.dark-mode #my-post-edit-modal .btn-secondary:hover {
    background-color: #343a40;
}
#my-post-edit-modal .btn-primary {
    flex-grow: 1;
}

/* Responsives Styling f√ºr "Meine Beitr√§ge" Meta-Zeile */
@media (max-width: 500px) {
    .my-post-meta {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    .my-post-meta .post-status {
        align-items: flex-start;
        flex-direction: column;
        gap: 8px;
    }
    /* KORRIGIERT: Responsives Button-Layout */
    .my-post-meta .post-actions {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
    }
    /* KORREKTUR: Stelle sicher, dass Buttons im Grid die Auto-Breite verlieren */
    .my-post-meta .post-actions .btn-small {
        width: 100%; 
    }
}
--- END FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\pages\_dashboard.css ---
--- START FILE: C:\xampp\htdocs\files\PAUSE\public\assets\css\pages\_planer.css ---
/* public/assets/css/pages/_planer.css */

/* Haupt-Header Container */
.planer-header {
    display: flex;
    flex-direction: column; /* Stacks title and controls vertically */
    align-items: stretch;    /* Children take full width */
    gap: 20px;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 1.5rem;
}

/* Wrapper f√ºr alle Controls auf der rechten Seite */
.planer-actions-wrapper {
    display: flex;
    flex-direction: column; /* Stellt Filter und Publish-Controls untereinander */
    gap: 15px; /* Abstand zwischen den beiden Control-Bl√∂cken */
    align-items: stretch; /* Sorgt daf√ºr, dass beide Bl√∂cke die gleiche Breite haben */
}

/* Container f√ºr die Filter (Selects, Datum) */
.planer-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px 15px;
    align-items: flex-end;
    justify-content: flex-start; /* Richtet die Filter links aus */
}

.planer-controls .form-group {
    margin-bottom: 0;
    flex-basis: 150px;
    flex-grow: 1;
}
/* Spezifische Breite f√ºr l√§ngere Selects */
.planer-controls .form-group#class-selector-container,
.planer-controls .form-group#teacher-selector-container {
    flex-basis: 200px;
}
.planer-controls .form-group label {
    font-size: 0.85rem;
    margin-bottom: 3px;
}


/* Container f√ºr den Ver√∂ffentlichungs-Status und Buttons */
.publish-controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 15px;
    background-color: var(--color-surface-alt);
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    box-sizing: border-box;
}
.dark-mode .publish-controls {
    background-color: var(--color-surface-alt);
}

.publish-status {
    font-weight: bold;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    white-space: nowrap;
    flex-grow: 1; /* Dr√ºckt die Buttons nach rechts */
}

.status-indicator {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    margin-left: 5px;
    font-size: 0.8rem;
    font-weight: normal;
}

.status-indicator.published {
    background-color: var(--color-success);
    color: white;
}

.status-indicator.not-published {
    background-color: #e9ecef;
    color: #6c757d;
}
.dark-mode .status-indicator.not-published {
    background-color: #343a40;
    color: #adb5bd;
}

.publish-actions {
    display: flex;
    gap: 10px;
    flex-wrap: nowrap; /* Verhindert Umbruch der Buttons selbst */
    flex-shrink: 0; /* Verhindert, dass der Button-Container schrumpft */
}

.publish-actions .btn-small {
    padding: 6px 10px;
    font-size: 0.85rem;
    min-width: 100px; /* Einheitliche Mindestbreite f√ºr Buttons */
    height: 36px; /* Einheitliche H√∂he */
    display: flex; /* F√ºr vertikale Zentrierung des Textes */
    justify-content: center;
    align-items: center;
    box-sizing: border-box; /* Padding in die Breite/H√∂he einbeziehen */
}

/* Spezielles Styling f√ºr die "Zur√ºckziehen"-Buttons */
.publish-actions .btn-small.btn-warning { /* √úbernimmt die btn-warning Farbe, falls vorhanden */
    background-color: var(--color-warning); /* Beispiel: Orange f√ºr Zur√ºckziehen */
    color: #333; /* Dunklerer Text f√ºr besseren Kontrast auf gelb */
    border: 1px solid var(--color-warning);
}
.publish-actions .btn-small.btn-warning:hover {
    background-color: #e6ac00;
    border-color: #e6ac00;
}
.dark-mode .publish-actions .btn-small.btn-warning {
    background-color: #e6ac00;
    border-color: #e6ac00;
}
.dark-mode .publish-actions .btn-small.btn-warning:hover {
    background-color: var(--color-warning);
    border-color: var(--color-warning);
}

/* NEU: Bulk Actions Section */
.bulk-actions-controls {
    display: flex;
    gap: 10px;
    padding: 10px 15px;
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    /* Removed from planer-actions-wrapper, will be placed below timetable */
    /* width: fit-content; /* Adjust width to content */
    /* margin-left: auto; /* Push to the right */
}
.dark-mode .bulk-actions-controls {
    background-color: var(--color-surface);
}

.bulk-actions-controls .btn-small {
    padding: 6px 12px;
    font-size: 0.85rem;
    height: 36px;
    width: auto;
    display: inline-flex;
    gap: 6px;
    align-items: center;
    background-color: #f8f9fa;
    color: var(--color-text);
    border: 1px solid var(--color-border);
    margin-bottom: 0;
}
.bulk-actions-controls .btn-small:hover {
    background-color: #e9ecef;
    color: var(--color-primary);
}
.dark-mode .bulk-actions-controls .btn-small {
    background-color: var(--color-surface-alt);
    color: var(--color-text);
    border-color: var(--color-border);
}
.dark-mode .bulk-actions-controls .btn-small:hover {
    background-color: #343a40;
    color: var(--color-primary);
}
.bulk-actions-controls .btn-small svg {
    margin-top: -2px; /* Visual alignment */
}


/* NEU: Copy Week Modal */
.copy-week-form {
    display: grid;
    grid-template-columns: 1fr auto 1fr 1fr;
    gap: 15px;
    align-items: flex-end;
    margin-bottom: 20px;
}

.copy-week-form .form-group {
    margin-bottom: 0;
}

.copy-week-form input[readonly] {
    background-color: var(--color-surface-alt);
    color: var(--color-text-muted);
    font-weight: bold;
}
.dark-mode .copy-week-form input[readonly] {
    background-color: var(--color-background);
}


.copy-week-form .arrow-separator {
    font-size: 2rem;
    font-weight: bold;
    color: var(--color-text-muted);
    padding-bottom: 5px; /* Align with inputs */
}

#copy-week-warning {
    display: block; /* Ist immer sichtbar */
    background-color: rgba(255, 189, 0, 0.1);
    border: 1px solid var(--color-warning);
    color: #664d03; /* Darker yellow text */
    margin-top: 0;
    margin-bottom: 20px;
    padding: 10px 15px;
    border-radius: 6px;
}
.dark-mode #copy-week-warning {
    color: var(--color-warning);
}

/* --- Timetable Grid --- */

/* KORREKTUR: .grid-header auf Tabellen-Header (TH) angepasst */
.timetable-grid th.grid-header { /* Ziel: <th class="grid-header ..."> */
    /* display: flex; (Nicht n√∂tig f√ºr TH) */
    background-color: var(--color-surface-alt);
    font-weight: bold;
    text-align: center;
    padding: 10px;
    justify-content: center;
    align-items: center;
    vertical-align: middle;
}
.dark-mode .timetable-grid th.grid-header {
    background-color: var(--color-surface-alt);
}

/* KORREKTUR: Alte, falsche Breiten-Definition entfernt (war hier) */


/* --- Modal Styles --- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1040; /* Standard-Overlay-Ebene */
    display: none;
    justify-content: center;
    /* KORREKTUR: align-items: center zu flex-start ge√§ndert */
    align-items: flex-start;
    opacity: 0;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(5px);
    /* NEU: Padding oben und unten, damit Modal scrollen kann */
    padding: 5vh 0;
    overflow-y: auto; /* Erlaube dem Overlay selbst zu scrollen, falls das Modal + Padding gr√∂√üer als 100vh ist */
}
.modal-overlay.visible { display: flex; opacity: 1; }
.modal-box {
    background: var(--color-surface);
    padding: 25px 30px; /* Reduced padding */
    border-radius: 12px;
    width: 90%; /* Width for mobile */
    max-width: 500px; /* Default max-width */
    box-sizing: border-box;
    max-height: 90vh;
    overflow-y: auto;
    margin: 0;
    display: flex;
    flex-direction: column;
}
.modal-box h2 { margin-top: 0; }

/* Modal Conflict Warning */
#modal-conflict-warning {
    display: none;
    background-color: rgba(255, 0, 84, 0.1); /* Helles Rot */
    border: 1px solid var(--color-danger);
    color: var(--color-danger);
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
    font-weight: 600;
}
#modal-conflict-warning div {
    margin-bottom: 5px;
}
#modal-conflict-warning div:last-child {
    margin-bottom: 0;
}
.dark-mode #modal-conflict-warning {
    color: #ff8984;
    border-color: #ff8984;
}


.modal-actions { display: flex; gap: 15px; margin-top: 30px; }
.modal-actions .btn { width: 0; flex-grow: 1; flex-basis: 0; margin-bottom: 0; height: 44px; padding-top: 0; padding-bottom: 0; }
.modal-tabs { display: flex; border-bottom: 1px solid var(--color-border); margin-bottom: 20px; }
.modal-tabs .tab-button { padding: 10px 15px; border: none; background: transparent; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--color-text-muted); border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
.modal-tabs .tab-button:hover { color: var(--color-primary); }
.modal-tabs .tab-button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
.modal-tab-content { display: none; }
.modal-tab-content.active { display: block; }
.hidden { display: none !important; }

/* --- NEU: Stile f√ºr Template-Editor Modal --- */

/* Modal zum Erstellen/Verwalten von Vorlagen */
#manage-templates-modal {
    z-index: 1050; /* H√∂her als Standard, aber niedriger als Bearbeiten-Modal */
}
#manage-templates-modal .modal-box {
    max-width: 800px; /* Keep max-width for desktop */
    width: 95%; /* Use percentage width for responsiveness */
    /* max-height: 90vh; und overflow-y: auto; werden von .modal-box geerbt */
}

/* KORREKTUR: Z-Index f√ºr das Bearbeiten-Modal, damit es √úBER dem Vorlagen-Modal erscheint */
#timetable-modal {
    z-index: 1060; /* H√∂chste Ebene */
}


/* Ansicht 1: Liste */
.manage-templates-view.active {
    display: flex; /* Erzwinge flex-Verhalten, wenn aktiv */
    flex-direction: column;
    flex: 1;
    min-height: 0;
}

/* Ansicht 2: Editor */
#template-editor-view {
    display: none; /* (wird von JS auf 'block' gesetzt) */
    /* NEU: Sorge daf√ºr, dass der Editor-View-Container flexibel w√§chst und schrumpft */
    flex: 1;
    min-height: 0; /* Wichtig f√ºr Flexbox-Scrolling */
    display: flex;
    flex-direction: column;
}


/* Container f√ºr Formular (Name/Beschreibung) */
#template-editor-view > div:nth-of-type(2) {
    display: flex;
    flex-direction: column; /* Stack on mobile */
    gap: 15px;
    margin-bottom: 15px;
    flex-shrink: 0; /* Verhindert das Schrumpfen des Formulars */
}

/* Container f√ºr das simplifizierte Grid */
#template-editor-grid-container {
    margin-top: 15px;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    overflow-x: auto; /* KORREKTUR: Erm√∂glicht horizontales Scrollen auf kleinen Ger√§ten */
    overflow-y: hidden; /* Verhindert doppeltes Scrollen */
    flex-shrink: 1; /* Erlaube dem Grid-Container zu schrumpfen */
    min-height: 300px; /* Gib dem Grid eine Mindesth√∂he, bevor es den Container scrollt */
}

/* Das Grid im Template-Editor selbst */
/* KORREKTUR: .template-editor-grid ist jetzt eine .timetable-grid (aus JS) */
.template-editor-grid.timetable-grid {
    min-width: 600px; /* NEU: Stellt sicher, dass das Grid eine Mindestbreite hat und scrollt */
    /* grid-auto-rows: minmax(60px, auto); (wird von .grid-cell min-height gesteuert) */
    gap: 2px; /* D√ºnnere Linien */
}
/* KORREKTUR: √úberschreibe Spalten f√ºr Template-Grid (schmalere Zeitspalte) */
.template-editor-grid.timetable-grid {
    /* grid-template-columns: 80px repeat(5, 1fr); (Nicht mehr n√∂tig, wird von TH-Breite gesteuert) */
}
.template-editor-grid.timetable-grid th.time-col {
    width: 100px; /* KORREKTUR: auf 100px gesetzt (war 80px) */
}


/* Kleinere Schriftarten speziell im Template-Grid */
.template-editor-grid .grid-header {
    font-size: 0.8rem;
    padding: 5px;
    min-height: 40px;
}
.template-editor-grid .grid-header.period-header {
    font-size: 0.7rem;
    line-height: 1.2;
    padding: 4px 2px;
    grid-column: 1; /* Stellt sicher, dass es in Spalte 1 bleibt */
}
.template-editor-grid .grid-cell {
    min-height: 60px; /* Kleinere Mindesth√∂he f√ºr Zeilen */
}

/* KORREKTUR: Ziele auf .planner-entry innerhalb des Template-Grids */
.template-editor-grid .grid-cell .planner-entry {
    padding: 2px 4px;
    min-height: 50px; /* Kleinere H√∂he f√ºr Eintr√§ge */
}
.template-editor-grid .grid-cell .entry-subject { font-size: 0.8rem; }
.template-editor-grid .grid-cell .entry-main { font-size: 0.7rem; }
.template-editor-grid .grid-cell .entry-room { font-size: 0.65rem; }


/* Media Query f√ºr kleinere Bildschirme */
@media (min-width: 600px) {
    /* Formular Name/Beschreibung nebeneinander auf gr√∂√üeren Bildschirmen */
    #template-editor-view > div:nth-of-type(2) {
        flex-direction: row;
    }
}

@media (max-width: 1200px) {
    .planer-header { flex-direction: column; align-items: stretch; }
    .planer-actions-wrapper { min-width: 100%; }
    .planer-controls { justify-content: flex-start; }
    .publish-controls { justify-content: flex-start; }
    .publish-status { flex-grow: 0; width: 100%; margin-bottom: 10px; }
    /* Ensure bulk actions wrap on smaller screens if needed */
    .bulk-actions-controls { flex-wrap: wrap; justify-content: flex-start; }
}

@media (max-width: 768px) {
    /* Stack bulk action buttons vertically */
    .bulk-actions-controls {
        flex-direction: column;
        align-items: stretch; /* Make buttons full width */
    }
    .bulk-actions-controls .btn-small {
        width: 100%;
        justify-content: center;
    }

    /* NEU: Anpassungen f√ºr das Template-Editor-Modal auf Mobilger√§ten */
    #manage-templates-modal .modal-box {
        padding: 15px; /* Noch weniger Padding */
        width: 95vw; /* Fast volle Breite */
    }

    #template-editor-view > div:nth-of-type(2) { /* Formular Name/Beschreibung */
        flex-direction: column; /* Bleibt untereinander */
    }
}

/* NEU: CSS f√ºr Absence Management */
#absence-management {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 25px 30px; /* Standard-Padding f√ºr Sektionen */
}

.absence-container {
    display: grid;
    grid-template-columns: 1fr 350px; /* Kalender links, Formular rechts */
    gap: 25px;
    align-items: flex-start;
}

#absence-calendar-container {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: 20px;
    border-radius: 8px;
    /* H√∂he wird von FullCalendar gesteuert */
}

#absence-form-container {
    background-color: var(--color-surface-alt);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--color-border);
    position: sticky;
    top: 100px; /* H√§lt das Formular beim Scrollen sichtbar */
}
.dark-mode #absence-form-container {
    background-color: var(--color-surface-alt);
}

#absence-form-container h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.3rem;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 10px;
}

#absence-form .form-grid-col-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

#absence-form .form-actions {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

#absence-form .btn-danger {
    flex-grow: 0; /* L√∂schen-Button nicht strecken */
    width: auto;
}

/* FullCalendar Anpassungen */
#absence-calendar {
    max-height: 70vh; /* Begrenzt die H√∂he des Kalenders */
}

/* Farbcodes f√ºr Abwesenheiten im Kalender */
.fc-event.absence-krank {
    background-color: var(--color-danger);
    border-color: var(--color-danger);
}
.fc-event.absence-fortbildung {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
}
.fc-event.absence-beurlaubt {
    background-color: var(--color-warning);
    border-color: var(--color-warning);
    color: #333;
}
.fc-event.absence-sonstiges {
    background-color: var(--color-text-muted);
    border-color: var(--color-text-muted);
}
/* Styling f√ºr das ausgew√§hlte Event */
.fc-event.absence-selected {
    box-shadow: 0 0 0 3px var(--color-primary);
    /* Helle outline f√ºr dark mode */
    outline: 2px solid var(--color-surface);
}
.dark-mode .fc-event.absence-selected {
    outline-color: var(--color-surface);
}

.fc-event-main {
    cursor: pointer;
}

/* KORREKTUR: Layout f√ºr das Abwesenheits-Formular (flacher und breiter) */
#absence-form.absence-form-layout {
    display: grid;
    /* Nutzt auto-fit, um Spalten bei Bedarf umzubrechen */
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px 20px;
    align-items: flex-end; /* Richtet Elemente an der Unterkante aus (wichtig f√ºr Aktionen) */
}

/* Einzelne Formulargruppen */
#absence-form.absence-form-layout .form-group {
    margin-bottom: 0; /* Wird durch grid-gap ersetzt */
}

/* Lehrergruppe und Kommentargruppe sollen mehr Platz einnehmen, wenn m√∂glich */
@media (min-width: 993px) {
    #absence-form.absence-form-layout #absence-teacher-group,
    #absence-form.absence-form-layout #absence-comment-group {
        /* Nimmt 2 Spalten ein, wenn das Grid mehr als 2 Spalten hat */
        grid-column: span 2;
    }
    
    /* Auf sehr breiten Bildschirmen (mehr als 4 Items nebeneinander) */
    @media (min-width: 1200px) {
        #absence-form.absence-form-layout #absence-teacher-group {
            grid-column: span 3;
        }
        #absence-form.absence-form-layout #absence-comment-group {
            grid-column: span 2;
        }
    }
}

/* Aktions-Gruppe ganz unten und volle Breite */
#absence-form.absence-form-layout #absence-actions-group {
    grid-column: 1 / -1; /* Volle Breite */
    margin-top: 10px; /* Kleiner Abstand nach oben */
}


/* Responsive f√ºr Abwesenheits-Seite */
@media (max-width: 992px) {
    .absence-container {
        grid-template-columns: 1fr; /* Stackt Kalender und Formular */
    }
    #absence-form-container {
        position: static; /* Hebt Sticky auf */
        top: auto;
    }
    #absence-calendar {
        max-height: 60vh; /* Etwas weniger H√∂he auf Mobilger√§ten */
    }

    /* KORREKTUR: Auf Mobilger√§ten das Formular-Grid vereinfachen */
    #absence-form.absence-form-layout {
        grid-template-columns: 1fr; /* Alles untereinander */
    }

    #absence-form.absence-form-layout #absence-teacher-group,
    #absence-form.absence-form-layout #absence-comment-group {
        grid-column: 1 / -1; /* Volle Breite (Standard) */
    }
} 

/* =========================================
NEUE REGELN F√úR PARALLELE EINTR√ÑGE (wiederhergestellt von _dashboard.css)
=========================================
*/

/* KORREKTUR: Ersetzt die 'display: table' Stile durch 'display: grid' */
.timetable-grid {
    display: grid;
    grid-template-columns: 80px repeat(5, 1fr); /* 80px Zeitspalte */
    grid-auto-rows: minmax(70px, auto); /* Mindesth√∂he 70px */
    gap: 3px; /* Simuliert die d√ºnnen Linien */
    background-color: var(--color-border);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    overflow: hidden;
    /* table-layout: fixed; (Nur f√ºr Tabellen) */
}
.timetable-grid thead, .timetable-grid tbody, .timetable-grid tr {
    /* (Diese sind nur f√ºr Tabellen) */
    display: contents; /* Wichtig f√ºr CSS-Grid-Layout in einer Tabelle (obwohl wir jetzt divs verwenden) */
}
/* .timetable-grid th, .timetable-grid td { (wird durch .grid-header / .